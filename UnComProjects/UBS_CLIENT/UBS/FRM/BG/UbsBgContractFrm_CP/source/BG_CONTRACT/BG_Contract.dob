VERSION 5.00
Object = "{C3A4B116-8248-4301-BB9C-E2DF040AAE6B}#1.0#0"; "UbsCtrl.dll"
Object = "{9D55898C-2E5D-42AA-A662-D60C8218C8DD}#1.0#0"; "UbsProp.dll"
Object = "{0A45DB48-BD0D-11D2-8D14-00104B9E072A}#2.0#0"; "sstabs2.ocx"
Object = "{A9609DF2-7123-4FAA-8347-2AEEE0D8C251}#1.3#0"; "UbsInfo.ocx"
Object = "{654DF6AF-C9A1-4D4E-89AC-9F01D9B7C3ED}#1.9#0"; "UbsChlCtrl.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.2#0"; "MSCOMCTL.OCX"
Begin VB.UserDocument BG_Contract_ 
   ClientHeight    =   10680
   ClientLeft      =   0
   ClientTop       =   0
   ClientWidth     =   8625
   HScrollSmallChange=   225
   KeyPreview      =   -1  'True
   ScaleHeight     =   10680
   ScaleWidth      =   8625
   VScrollSmallChange=   225
   Begin VB.CommandButton btnReRead 
      Caption = "Перечитать"
Height = 375
Left = 120
TabIndex = 113
Top = 9960
Width = 1215
End
   Begin VB.CommandButton btnExit 
      Caption = "Выход"
Height = 375
Left = 6480
TabIndex = 107
Top = 9960
Width = 1215
End
   Begin VB.CommandButton btnSave 
      Caption = "Сохранить"
Height = 375
Left = 5160
TabIndex = 106
Top = 9960
Width = 1215
End
   Begin ActiveTabs.SSActiveTabs SSActiveTabs1 
      Height = 9795
Left = 0
TabIndex = 0
Top = 0
Width = 8295
_ExtentX = 14631
_ExtentY = 17277
_Version = 131083
TabCount = 6
TagVariant = ""
Tabs = "BG_Contract.dox" :       0000
      Begin ActiveTabs.SSActiveTabPanel SSActiveTabPanel6 
         Height = 9405
Left = -99969
TabIndex = 98
Top = 360
Width = 7875
_ExtentX = 13891
_ExtentY = 16589
_Version = 131083
TabGuid = "BG_Contract.dox" :       0154
         Begin VB.ComboBox cmbPortfolio 
            Height = 315
Left = 1440
Style = 2  'Dropdown List
TabIndex = 87
Top = 240
Width = 6375
End
         Begin VB.ComboBox cmbQualityCategory 
            Height = 315
Left = 1440
Style = 2  'Dropdown List
TabIndex = 88
Top = 720
Width = 1035
End
         Begin VB.ComboBox cmbTypeValidationRisk 
            Height = 315
Left = 1440
Style = 2  'Dropdown List
TabIndex = 93
Top = 1680
Width = 3735
End
         Begin UBSCTRLLibCtl.UbsControlMoney ucmRateReservation 
            Height = 315
Left = 1440
TabIndex = 90
Top = 1200
Width = 1695
_cx = 1248174
_cy = 1245740
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "0,00"
Valid = -1  'True
Range = 14
Precision = 2
SignEnable = 0
SeparatorsEnable = 1
ReadOnly        =   0
         End
         Begin VB.Label Label13 
            Caption = "Портфель"
Height = 195
Left = 120
TabIndex = 102
Top = 360
Width = 855
End
         Begin VB.Label Label9 
            Caption = "Категория качества"
Height = 435
Left = 120
TabIndex = 101
Top = 720
Width = 1335
End
         Begin VB.Label Label14 
            Caption = "Тип оценки риска"
Height = 555
Left = 120
TabIndex = 100
Top = 1740
Width = 1035
End
         Begin VB.Label Label15 
            Caption = "Ставка резервирования"
Height = 435
Left = 120
TabIndex = 99
Top = 1260
Width = 1275
End
End
      Begin ActiveTabs.SSActiveTabPanel SSActiveTabPanel5 
         Height = 9405
Left = -99969
TabIndex = 97
Top = 360
Width = 8235
_ExtentX = 14526
_ExtentY = 16589
_Version = 131083
TabGuid = "BG_Contract.dox" :       017C
         Begin VB.CommandButton cmdAddGuarant 
            Caption = "Заключить"
Height = 375
Left = 6480
TabIndex = 82
Top = 120
Width = 1155
End
         Begin VB.CommandButton cmdEditGuarant 
            Caption = "Изменить"
Height = 375
Left = 6480
TabIndex = 83
Top = 600
Width = 1155
End
         Begin VB.CommandButton cmdListGuarantOperDog 
            Caption = "Операции"
CausesValidation = 0   'False
Height = 375
Left = 6480
TabIndex = 85
Top = 1560
Width = 1155
End
         Begin VB.CommandButton cmdInclude 
            Caption = "Привязать"
Height = 375
Left = 6480
TabIndex = 84
Top = 1080
Width = 1155
End
         Begin MSComctlLib.ListView lvwGuarant 
            Height = 5235
Left = 120
TabIndex = 81
Top = 120
Width = 6255
_ExtentX = 11033
_ExtentY = 9234
View = 3
LabelEdit = 1
LabelWrap = 0   'False
HideSelection = -1  'True
FullRowSelect = -1  'True
GridLines = -1  'True
_Version = 393217
ForeColor = -2147483640
BackColor = -2147483643
BorderStyle = 1
Appearance = 1
NumItems = 0
End
End
      Begin ActiveTabs.SSActiveTabPanel SSActiveTabPanel4 
         Height = 9405
Left = 30
TabIndex = 96
Top = 360
Width = 8235
_ExtentX = 14526
_ExtentY = 16589
_Version = 131083
TabGuid = "BG_Contract.dox" :       01A4
         Begin UBSPROPLibCtl.UbsControlProperty ucpParam 
            Height = 6855
Left = 0
OleObjectBlob = "BG_Contract.dox" :       01CC
            TabIndex = 86
Top = 0
Width = 7695
End
End
      Begin ActiveTabs.SSActiveTabPanel SSActiveTabPanel2 
         Height = 9405
Left = -99969
TabIndex = 95
Top = 360
Width = 8235
_ExtentX = 14526
_ExtentY = 16589
_Version = 131083
TabGuid = "BG_Contract.dox" :       01FC
         Begin VB.Frame Frame1 
            Caption = "Порядок уплаты вознаграждения за выдачу гарантии"
Height = 1515
Left = 120
TabIndex = 92
Top = 5280
Width = 7575
            Begin VB.CommandButton cmdPeriodPayFeeBonus 
               Caption = "Период"
Enabled = 0   'False
Height = 315
Left = 3540
TabIndex = 77
Top = 630
Width = 1155
End
            Begin VB.ComboBox cmbBonusValutaBonus 
               Height = 315
Left = 4800
Style = 2  'Dropdown List
TabIndex = 80
Top = 1000
Width = 2655
End
            Begin VB.ComboBox cmbOrderPayFeeBonus 
               Height = 315
Left = 2160
Style = 2  'Dropdown List
TabIndex = 76
Top = 240
Width = 5295
End
            Begin VB.ComboBox cmbTypePayFeeBonus 
               Height = 315
Left = 600
Style = 2  'Dropdown List
TabIndex = 79
Top = 1000
Width = 3315
End
            Begin UBSCTRLLibCtl.UbsControlDate dDateNextPayFeeBonus 
               Height = 315
Left = 2160
TabIndex = 78
Top = 600
Width = 1215
_cx = 1247327
_cy = 1245740
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin VB.Label Label8 
               Alignment = 1  'Right Justify
Caption = "Дата следующей уплаты"
Height = 195
Left = 120
TabIndex = 112
Top = 690
Width = 1935
End
            Begin VB.Label Label7 
               Alignment = 1  'Right Justify
Caption = "Валюта"
Height = 195
Left = 4080
TabIndex = 111
Top = 1060
Width = 615
End
            Begin VB.Label Label6 
               Alignment = 1  'Right Justify
Caption = "Тип"
Height = 195
Left = 120
TabIndex = 110
Top = 1060
Width = 315
End
            Begin VB.Label Label5 
               Alignment = 1  'Right Justify
Caption = "Порядок уплаты"
Height = 195
Left = 720
TabIndex = 109
Top = 300
Width = 1335
End
End
         Begin VB.Frame frmPayFeeGuarant 
            Caption = "Порядок уплаты вознаграждения (гарант)"
Height = 1455
Left = 120
TabIndex = 91
Top = 3720
Visible = 0   'False
Width = 7575
            Begin VB.ComboBox cmbTypePayFeeGuarant 
               Height = 315
Left = 2160
Style = 2  'Dropdown List
TabIndex = 72
Top = 680
Width = 3315
End
            Begin VB.ComboBox cmbOrderPayFeeGuarant 
               Height = 315
Left = 2160
Style = 2  'Dropdown List
TabIndex = 70
Top = 300
Width = 5295
End
            Begin VB.CommandButton cmdPeriodPayFeeGuarant 
               Caption = "Период"
Height = 315
Left = 3480
TabIndex = 74
Top = 1050
Visible = 0   'False
Width = 1115
End
            Begin UBSCTRLLibCtl.UbsControlDate dDateNextPayFeeGuarant 
               Height = 315
Left = 2160
TabIndex = 75
Top = 1050
Visible = 0   'False
Width = 1215
_cx = 268437599
_cy = 268436012
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin VB.Label lblTypePayFeeGuarant 
               Alignment = 1  'Right Justify
Caption = "Тип"
Height = 195
Left = 1680
TabIndex = 71
Top = 740
Width = 315
End
            Begin VB.Label lblOrderPayFeeGuarant 
               Alignment = 1  'Right Justify
Caption = "Порядок уплаты"
Height = 195
Left = 720
TabIndex = 69
Top = 360
Width = 1275
End
            Begin VB.Label lblDateNextPayFeeGuarant 
               Caption = "Дата следующей уплаты"
Height = 195
Left = 120
TabIndex = 73
Top = 1080
Visible = 0   'False
Width = 1935
End
End
         Begin VB.Frame frameBonusOrder 
            Caption = "Порядок уплаты вознаграждения за пользование гарантией"
Height = 1515
Left = 120
TabIndex = 89
Top = 2160
Width = 7575
            Begin VB.ComboBox cmbTypePayFee 
               Appearance = 0  'Flat
Height = 315
Left = 600
Style = 2  'Dropdown List
TabIndex = 66
Top = 1000
Width = 3315
End
            Begin VB.ComboBox cmbBonusValuta 
               Height = 315
ItemData = "BG_Contract.dox" :       0224
               Left = 4800
List = "BG_Contract.dox" :       0226
               Style = 2  'Dropdown List
TabIndex = 68
Top = 1000
Width = 2655
End
            Begin VB.CommandButton cmdPeriodPayFee 
               Caption = "Период"
Enabled = 0   'False
Height = 315
Left = 3540
TabIndex = 62
Top = 630
Width = 1155
End
            Begin UBSCTRLLibCtl.UbsControlDate dDateNextPayFee 
               Height = 315
Left = 2160
TabIndex = 64
Top = 630
Width = 1215
_cx = 1247327
_cy = 1245740
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin VB.ComboBox cmbOrderPayFee 
               Height = 315
Left = 2160
Style = 2  'Dropdown List
TabIndex = 61
Top = 240
Width = 5295
End
            Begin VB.Label lblOrderPayFee 
               Alignment = 1  'Right Justify
Caption = "Порядок уплаты"
Height = 195
Left = 720
TabIndex = 60
Top = 300
Width = 1335
End
            Begin VB.Label lblTypePayFee 
               Alignment = 1  'Right Justify
Caption = "Тип"
Height = 195
Left = 120
TabIndex = 65
Top = 1060
Width = 315
End
            Begin VB.Label Label4 
               Alignment = 1  'Right Justify
Caption = "Валюта"
Height = 195
Left = 4080
TabIndex = 67
Top = 1060
Width = 615
End
            Begin VB.Label Label2 
               Alignment = 1  'Right Justify
Caption = "Дата следующей уплаты"
Height = 195
Left = 120
TabIndex = 63
Top = 690
Width = 1935
End
End
         Begin VB.CommandButton cmdDel 
            Caption = "Удалить"
Height = 375
Left = 6480
TabIndex = 59
Top = 1320
Width = 1155
End
         Begin VB.CommandButton cmdEdit 
            Caption = "Изменить"
Height = 375
Left = 6480
TabIndex = 58
Top = 720
Width = 1155
End
         Begin VB.CommandButton cmdAdd 
            Caption = "Добавить"
Height = 375
Left = 6480
TabIndex = 57
Top = 120
Width = 1155
End
         Begin MSComctlLib.TreeView trvRates 
            Height = 1995
Left = 120
TabIndex = 56
Top = 120
Width = 6255
_ExtentX = 11033
_ExtentY = 3519
_Version = 393217
HideSelection = 0   'False
Indentation = 529
LabelEdit = 1
LineStyle = 1
Sorted = -1  'True
Style = 7
FullRowSelect = -1  'True
ImageList = "ImageList"
Appearance = 1
End
End
      Begin ActiveTabs.SSActiveTabPanel SSActiveTabPanel3 
         Height = 9405
Left = -99969
TabIndex = 94
Top = 360
Width = 7875
_ExtentX = 13891
_ExtentY = 16589
_Version = 131083
TabGuid = "BG_Contract.dox" :       0228
         Begin MSComctlLib.ListView lstAccounts 
            Height = 5295
Left = 120
TabIndex = 55
Top = 120
Width = 7575
_ExtentX = 13361
_ExtentY = 9340
View = 3
LabelEdit = 1
LabelWrap = -1  'True
HideSelection = -1  'True
FullRowSelect = -1  'True
GridLines = -1  'True
_Version = 393217
ForeColor = -2147483640
BackColor = -2147483643
BorderStyle = 1
Appearance = 1
NumItems = 0
End
End
      Begin ActiveTabs.SSActiveTabPanel SSActiveTabPanel1 
         Height = 9405
Left = -99969
TabIndex = 1
Top = 360
Width = 7875
_ExtentX = 13891
_ExtentY = 16589
_Version = 131083
TabGuid = "BG_Contract.dox" :       0250
         Begin VB.TextBox txtNumAgC 
            Height = 315
Left = 3840
TabIndex = 122
Top = 1200
Width = 1215
End
         Begin VB.TextBox txtDateAgC 
            Alignment = 2  'Center
Enabled = 0   'False
Height = 315
Left = 5760
TabIndex = 121
Top = 1200
Width = 975
End
         Begin VB.CommandButton btnAgentDel 
            Caption = "X"
Height = 315
Left = 6800
TabIndex = 9
Top = 1200
Width = 315
End
         Begin VB.CommandButton btnAgent 
            Caption = "..."
Height = 315
Left = 7240
TabIndex = 8
Top = 1200
Width = 315
End
         Begin VB.TextBox txtAgent 
            Enabled = 0   'False
Height = 315
Left = 720
TabIndex = 117
Top = 1200
Width = 2415
End
         Begin VB.ComboBox kindComboBox 
            Height = 315
ItemData = "BG_Contract.dox" :       0278
            Left = 1680
List = "BG_Contract.dox" :       027A
            Sorted = -1  'True
Style = 2  'Dropdown List
TabIndex = 7
Top = 840
Width = 5895
End
         Begin VB.TextBox txtPreviousContract 
            Enabled = 0   'False
Height = 315
Left = 2520
TabIndex = 53
Top = 8160
Width = 4695
End
         Begin VB.CommandButton btnPreviousContract 
            Caption = "..."
Height = 315
Left = 7350
TabIndex = 52
Top = 8160
Width = 315
End
         Begin VB.ComboBox cmbWarrant 
            Height = 315
Left = 2520
Style = 2  'Dropdown List
TabIndex = 54
Top = 8520
Width = 5175
End
         Begin VB.CommandButton btnFrameContractDel 
            Caption = "X"
Height = 315
Left = 6800
TabIndex = 4
Top = 120
Width = 315
End
         Begin VB.CommandButton btnFrameContract 
            Caption = "..."
Height = 315
Left = 7240
TabIndex = 3
Top = 120
Width = 315
End
         Begin VB.TextBox txtFrameContract 
            Enabled = 0   'False
Height = 315
Left = 1680
TabIndex = 2
Top = 120
Width = 5055
End
         Begin VB.CommandButton btnModel 
            Caption = "..."
Height = 315
Left = 7240
TabIndex = 6
Top = 480
Width = 315
End
         Begin VB.TextBox txtModel 
            Enabled = 0   'False
Height = 315
Left = 1680
TabIndex = 5
Top = 480
Width = 5055
End
         Begin VB.Frame FrameCover 
            Caption = "Покрытие"
Height = 1320
Left = 120
TabIndex = 37
Top = 5670
Width = 7575
            Begin VB.TextBox txtCoverDogovor 
               Enabled = 0   'False
Height = 315
Left = 2280
TabIndex = 45
Top = 900
Width = 5175
End
            Begin VB.ComboBox cmbCoverValuta 
               Height = 315
Left = 5280
Style = 2  'Dropdown List
TabIndex = 43
Top = 540
Width = 2175
End
            Begin VB.ComboBox cmbCoverType 
               Height = 315
Left = 2280
Style = 2  'Dropdown List
TabIndex = 39
Top = 180
Width = 5175
End
            Begin UBSCTRLLibCtl.UbsControlMoney txtCoverSumma 
               Height = 315
Left = 2280
TabIndex = 41
Top = 540
Width = 1935
_cx = 1248597
_cy = 1245740
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "0,00"
Valid = -1  'True
Range = 14
Precision = 2
SignEnable = 0
SeparatorsEnable = 1
ReadOnly        =   0
            End
            Begin VB.Label lblCoverDogovor 
               Alignment = 1  'Right Justify
Caption = "Договор"
Height = 195
Left = 960
TabIndex = 44
Top = 960
Width = 1215
End
            Begin VB.Label lblCoverSumma 
               Alignment = 1  'Right Justify
Caption = "Сумма"
Height = 195
Left = 1440
TabIndex = 40
Top = 600
Width = 735
End
            Begin VB.Label lblCoverValuta 
               Alignment = 1  'Right Justify
Caption = "Валюта"
Height = 195
Left = 4560
TabIndex = 42
Top = 600
Width = 615
End
            Begin VB.Label Label3 
               Alignment = 1  'Right Justify
Caption = "Тип"
Height = 195
Left = 1680
TabIndex = 38
Top = 240
Width = 495
End
End
         Begin VB.Frame frameGarant 
            Caption = "Гарантия"
Height = 1320
Left = 120
TabIndex = 22
Top = 4350
Width = 7575
            Begin VB.ComboBox cmbValuta 
               Height = 315
Left = 5280
Style = 2  'Dropdown List
TabIndex = 36
Top = 900
Width = 2175
End
            Begin VB.TextBox txtNumber 
               Height = 315
Left = 2280
TabIndex = 24
Top = 180
Width = 2655
End
            Begin UBSCTRLLibCtl.UbsControlDate txtDateOpen 
               Height = 315
Left = 6480
TabIndex = 26
Top = 180
Width = 975
_cx = 1246904
_cy = 1245740
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin UBSCTRLLibCtl.UbsControlDate txtDateBegin 
               Height = 315
Left = 2280
TabIndex = 28
Top = 540
Width = 975
_cx = 268437176
_cy = 268436012
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin UBSCTRLLibCtl.UbsControlDate txtDateEnd 
               Height = 315
Left = 4440
TabIndex = 30
Top = 540
Width = 975
_cx = 268437176
_cy = 268436012
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin UBSCTRLLibCtl.UbsControlDate txtDateClose 
               Height = 315
Left = 6480
TabIndex = 32
Top = 540
Width = 975
_cx = 1246904
_cy = 1245740
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin UBSCTRLLibCtl.UbsControlMoney txtGarantSumma 
               Height = 315
Left = 2280
TabIndex = 34
Top = 900
Width = 1935
_cx = 1248597
_cy = 1245740
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "0,00"
Valid = -1  'True
Range = 14
Precision = 2
SignEnable = 0
SeparatorsEnable = 1
ReadOnly        =   0
            End
            Begin VB.Label GarantSumma 
               Alignment = 1  'Right Justify
Caption = "Сумма"
Height = 195
Left = 1440
TabIndex = 33
Top = 960
Width = 735
End
            Begin VB.Label lblValuta 
               Alignment = 1  'Right Justify
Caption = "Валюта"
Height = 195
Left = 4560
TabIndex = 35
Top = 960
Width = 615
End
            Begin VB.Label lblDateBegin 
               Alignment = 1  'Right Justify
Caption = "Дата начала"
Height = 195
Left = 1080
TabIndex = 27
Top = 600
Width = 1095
End
            Begin VB.Label lblDateEnd 
               Alignment = 1  'Right Justify
Caption = "окончания"
Height = 195
Left = 3480
TabIndex = 29
Top = 600
Width = 855
End
            Begin VB.Label lblDateClose 
               Alignment = 1  'Right Justify
Caption = "закрытия"
Height = 195
Left = 5520
TabIndex = 31
Top = 600
Width = 855
End
            Begin VB.Label lblNumber 
               Alignment = 1  'Right Justify
Caption = "Номер"
Height = 195
Left = 1320
TabIndex = 23
Top = 240
Width = 855
End
            Begin VB.Label lblDateOpen 
               Alignment = 1  'Right Justify
Caption = "Дата заключения"
Height = 195
Left = 4920
TabIndex = 25
Top = 240
Width = 1455
End
End
         Begin VB.ComboBox cmbNumberDiv 
            Height = 315
Left = 2520
Style = 2  'Dropdown List
TabIndex = 51
Top = 7800
Width = 5175
End
         Begin VB.ComboBox cmbExecut 
            Height = 315
Left = 2520
Style = 2  'Dropdown List
TabIndex = 47
Top = 7080
Width = 5175
End
         Begin VB.ComboBox cmbState 
            Height = 315
Left = 2520
Style = 2  'Dropdown List
TabIndex = 49
Top = 7440
Width = 5175
End
         Begin VB.Frame frameClients 
            Caption = "Клиенты"
Height = 1665
Left = 120
TabIndex = 21
Top = 2700
Width = 7575
            Begin UBSCTRLLibCtl.UbsControlDate txtDatePrincipal 
               Height = 315
Left = 2280
TabIndex = 20
Top = 1275
Width = 975
_cx = 1720
_cy = 556
Appearance = 1
Enabled = -1  'True
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
            End
            Begin VB.CommandButton cmdManualBenificiar 
               Caption = "Ввести реквизиты"
Height = 315
Left = 5280
TabIndex = 16
Top = 540
Width = 1695
End
            Begin VB.TextBox txtBeneficiar 
               Enabled = 0   'False
Height = 315
Left = 2280
TabIndex = 14
Top = 540
Width = 2895
End
            Begin VB.TextBox txtGarant 
               Enabled = 0   'False
Height = 315
Left = 2280
TabIndex = 19
Top = 900
Width = 4695
End
            Begin VB.TextBox txtPrincipal 
               Enabled = 0   'False
Height = 315
Left = 2280
TabIndex = 11
Top = 180
Width = 4695
End
            Begin VB.CommandButton btnPrincipal 
               Caption = "..."
Height = 315
Left = 7120
TabIndex = 12
Top = 180
Width = 315
End
            Begin VB.CommandButton btnBeneficiar 
               Caption = "..."
Height = 315
Left = 7120
TabIndex = 15
Top = 540
Width = 315
End
            Begin VB.CommandButton btnGarant 
               Caption = "..."
Height = 315
Left = 7120
TabIndex = 17
Top = 900
Width = 315
End
            Begin VB.Label Label10 
               Caption = "Дата возн. обяз. Принцип."
Height = 255
Left = 120
TabIndex = 118
Top = 1320
Width = 2175
End
            Begin VB.Label lblGarant 
               Alignment = 1  'Right Justify
Caption = "Гарант"
Height = 210
Left = 1560
TabIndex = 18
Top = 945
Width = 615
End
            Begin VB.Label lblBeneficiar 
               Alignment = 1  'Right Justify
Caption = "Бенефициар"
Height = 210
Left = 840
TabIndex = 13
Top = 585
Width = 1335
End
            Begin VB.Label lblPrincipal 
               Alignment = 1  'Right Justify
Caption = "Принципал"
Height = 210
Left = 960
TabIndex = 10
Top = 225
Width = 1215
End
End
         Begin UBSCTRLLibCtl.UbsControlDate DateReward 
            Height = 315
Left = 1800
TabIndex = 125
Top = 1680
Width = 975
_cx = 1246904
_cy = 1245740
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
         End
         Begin UBSCTRLLibCtl.UbsControlDate DateAdjustment 
            Height = 315
Left = 1800
TabIndex = 126
Top = 2160
Width = 975
_cx = 1246904
_cy = 1245740
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "  .  .    "
Valid = -1  'True
Format = 1
ReadOnly        =   0
         End
         Begin UBSCTRLLibCtl.UbsControlMoney CostAmount 
            Height = 315
Left = 3960
TabIndex = 128
Top = 1680
Width = 1935
_cx = 1248597
_cy = 1245740
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "0,00"
Valid = -1  'True
Range = 14
Precision = 2
SignEnable = 0
SeparatorsEnable = 1
ReadOnly        =   0
         End
         Begin UBSCTRLLibCtl.UbsControlMoney PaidAmount 
            Height = 315
Left = 3960
TabIndex = 129
Top = 2160
Width = 1095
_cx = 1931
_cy = 556
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "0,00"
Valid = -1  'True
Range = 14
Precision = 2
SignEnable = 0
SeparatorsEnable = 1
ReadOnly        =   0
         End
         Begin UBSCTRLLibCtl.UbsControlMoney S 
            Height = 315
Left = 6600
TabIndex = 130
Top = 2160
Width = 1095
_cx = 1931
_cy = 556
Appearance = 1
Enabled = 0   'False
Object.TabStop = -1  'True
Text = "0,00"
Valid = -1  'True
Range = 14
Precision = 2
SignEnable = 0
SeparatorsEnable = 1
ReadOnly        =   0
         End
         Begin VB.Label Label20 
            Caption = "Перечисленная сумма"
Height = 450
Left = 5160
TabIndex = 132
Top = 2160
Width = 1335
End
         Begin VB.Label Label19 
            Caption = "Уплаченная сумма"
Height = 450
Left = 2880
TabIndex = 131
Top = 2160
Width = 1095
End
         Begin VB.Label Label18 
            Caption = "Сумма затрат"
Height = 450
Left = 2880
TabIndex = 127
Top = 1680
Width = 975
End
         Begin VB.Label Label17 
            Caption = "Дата последнего ДС по корректировке"
Height = 450
Left = 120
TabIndex = 124
Top = 2160
Width = 1815
End
         Begin VB.Label Label16 
            Caption = "Дата уплаты вознаграждения"
Height = 450
Left = 120
TabIndex = 123
Top = 1680
Width = 1335
End
         Begin VB.Label Label12 
            Caption = "Дата"
Height = 210
Left = 5210
TabIndex = 120
Top = 1250
Width = 500
End
         Begin VB.Label Label11 
            Caption = "Номер"
Height = 210
Left = 3200
TabIndex = 119
Top = 1250
Width = 550
End
         Begin VB.Label Label1 
            Caption = "Агент"
Height = 210
Left = 120
TabIndex = 116
Top = 1250
Width = 495
End
         Begin VB.Label lblUID 
            Caption = "УИД:"
Height = 315
Left = 2040
TabIndex = 115
Top = 8940
Visible = 0   'False
Width = 5475
End
         Begin VB.Label kindLabel 
            Caption = "Вид гарантии"
Height = 210
Left = 120
TabIndex = 114
Top = 892
Width = 1455
End
         Begin VB.Label lblPreviousContract 
            Alignment = 1  'Right Justify
Caption = "Прежний договор гарантии"
Height = 255
Left = 120
TabIndex = 108
Top = 8220
Width = 2295
End
         Begin VB.Label lblBankFace 
            Alignment = 1  'Right Justify
Caption = "Уполномоченное лицо банка"
Height = 255
Left = 120
TabIndex = 105
Top = 8580
Width = 2295
End
         Begin VB.Label lblFrameContract 
            Caption = "Рамочный договор"
Height = 210
Left = 120
TabIndex = 104
Top = 165
Width = 1455
End
         Begin VB.Label lblModel 
            Caption = "Типовой договор"
Height = 210
Left = 120
TabIndex = 103
Top = 525
Width = 1335
End
         Begin VB.Label lblNumberDiv 
            Alignment = 1  'Right Justify
Caption = "Отделение"
Height = 195
Left = 1200
TabIndex = 50
Top = 7860
Width = 1215
End
         Begin VB.Label lblExecutor 
            Alignment = 1  'Right Justify
Caption = "Ответственный исполнитель"
Height = 195
Left = 0
TabIndex = 46
Top = 7140
Width = 2415
End
         Begin VB.Label lblState 
            Alignment = 1  'Right Justify
Caption = "Состояние"
Height = 195
Left = 1440
TabIndex = 48
Top = 7500
Width = 975
End
End
End
   Begin UbsChlCtrl.UbsChannel oleUbsChannel 
      Left = 3600
Top = 9960
_ExtentX = 873
_ExtentY = 873
End
   Begin UbsInfo32.Info Info 
      Height = 375
Left = 1440
Top = 9960
Width = 2055
_ExtentX = 3625
_ExtentY = 661
Caption = "Данные сохранены!"
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name = "MS Sans Serif"
Size = 8.25
Charset = 204
Weight = 700
Underline = 0   'False
Italic = 0   'False
Strikethrough = 0   'False
EndProperty
End
   Begin MSComctlLib.ImageList ImageList 
      Left = 4320
Top = 9840
_ExtentX = 1005
_ExtentY = 1005
BackColor = -2147483643
ImageWidth = 16
ImageHeight = 16
MaskColor = 12632256
UseMaskColor = 0   'False
_Version = 393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages = 3
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture = "BG_Contract.dox" :       027C
            Key = ""
EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture = "BG_Contract.dox" :       03D6
            Key = ""
EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture = "BG_Contract.dox" :       0530
            Key = ""
EndProperty
EndProperty
End
   Begin VB.Menu mnuAccounts 
      Caption = ""
Visible = 0   'False
      Begin VB.Menu mnuListAccounts 
         Caption = "Выбрать счет"
Shortcut = {F2}
End
      Begin VB.Menu mnuClearAccount 
         Caption = "Очистить"
Shortcut = {DEL}
End
      Begin VB.Menu mnuReports 
         Caption = "-"
Index = 0
End
End
End
Attribute VB_Name = "BG_Contract_"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit On

Implements UBSChild

Private Const strRatePrefix = "[Процентные ставки]."
Public Parent As UBSParrent

Private dateBeginC As Date
Private m_strCaptionForm As String
Private sModelType As String
Private strListItemKey As String
Private strSection As String
Private StrCommand As String
Private strAccType As String
Private IdContract As Long
Private IdContractCopy As Long
Private LoadParam As String
Private strOrderPayFeeGuarant As String

Private NumWin As Integer
Private NumParentWindow As Integer
Private NumChildWinModel As Integer
Private NumChildWinPreviousContract As Integer
Private NumChildWinFrContract As Integer
Private NumChildWinPrincipal As Integer
Private NumChildWinBeneficiar As Integer
Private NumChildWinGarant As Integer
Private NumChildWinListAccounts As Integer
Private NumChildWinListGuarantOper As Integer
Private NumChildWinListGuarant As Integer
Private NumChildWinListAgent As Integer

Private blnGuarWinOpened As Boolean
Private bNeedRefreshGrid As Boolean
Private bParentWindowClose As Boolean
Private blnAddFlChanged As Boolean
Private blnInitCurrencyBonus As Boolean
Private blnFixSum As Boolean
Private blnSecure As Boolean

Private IdModel As Long
Private IdPrevContract As Long
Private IdFrameContract As Long
Private IdPrincipal As Long
Private IdPrincipalOld As Long
Private IdBeneficiar As Long
Private IdGarant As Long, IdAgent As Long
Private IdDivision As Long
Private IdValuta As Long
Private IdOI As Long
Private IdWarrant As Long
Private IdState As Long
Private lIdCoverValuta As Long
Private lIdBonusValuta As Long
Private lIdBonusValutaBonus As Long
Private IdCoverType As Long

Private lIdCoverContract As Variant
Private arrTypePeriod As Variant
Private arrTypeDate As Variant
Private arrExecutEx As Variant
Private arrQualityCategory As Variant
Private arrPortfolio As Variant
Private arrRiskReason As Variant
Private arrTypeValidationRisk As Variant
Private arrGuarant As Variant
Private arrAccounts As Variant
Private arrListRprByAcc As Variant
Private arrRates As Variant
Private arrRateValues As Variant
Private arrInterval As Variant
Private arrIntervalGuarant As Variant
Private arrIntervalBonus As Variant
Private arrCoverTypes As Variant
Private arrState As Variant
Private arrExecut As Variant
Private arrWarrant As Variant
Private arrCurrency As Variant
Private arrDivs As Variant
Private arrPayOrder As Variant
Private arrTypeBonus As Variant
Private arrPeriodPay As Variant
Private arrDetailsBeneficiar
Private arrCountry As Variant
Private arrTypeObject As Variant

Private objInputBox As Object
Private objWait As Object
Private objArray As Object
Private objErr As Object
Private objInterfaces As Object
Private objFormParam As Object
Private objFocusCtrl As Object
Private objParamIn As Object
Private objParamOut As Object
Private objStub As Object
Private objFormat As Object
Private objUbsCheck As Object

Private KindAddflSense As Variant
Private FrameContractTerms As Variant
Private FrameContractLimitSaldo As Currency
Private IssueEndDate As Date
Private FrameContractDivision As Integer, ReflectComIssue As Integer

Private LimitExcessCheckOn As Boolean

Private dFrameContractDateBegin As Date
Private dFrameContractDateEnd As Date
Private dDate2222 As Date
Private dDate1990 As Date

Private dateNextPayFeeValue As Date
Private dateNextPayFeeBonusValue As Date
Private setRekvBen As Integer


Private Sub btnAgent_Click()  ' [14617]

    On Error GoTo ErrorCode
    Dim InitParamGrid As Variant, GridF As Object, varCond As Variant, intKeyCond As Integer, Kinds As Variant, i As Long

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinListAgent <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinListAgent
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\BG\LIST_AGENT.flt", NumChildWinListAgent

        If NumChildWinListAgent <> 0 Then
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinListAgent, "UbsGridList")
            
            intKeyCond = GridF.AddWhereItem("Состояние", 4, "Открыт")  ' 4 - это =, 0 - открыт. Т.е. "= открыт"
            GridF.WhereItemFlags(intKeyCond) = 0 'невидимое условие

            If Parent.IsExistParam(NumChildWinListAgent, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinListAgent, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinListAgent, "SelectItem") Then Parent.ParamInfo(NumChildWinListAgent, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinListAgent
            End If
            
            Set GridF = Nothing
        End If
    End If

    Call EnabledCmdControl(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор из списка агентов", "ошибка выполнения"
End Sub

Private Sub btnAgentDel_Click()
    IdAgent = 0
    txtAgent.Text = ""
    txtNumAgC.Text = ""
    txtDateAgC.Text = ""
    DateReward.Text = ""
    DateAdjustment.Text = ""
    CostAmount.Text = ""
    PaidAmount.Text = ""
    TransferedAmount.Text = ""
    DateReward.Enabled = False
    CostAmount.Enabled = False
End Sub

Private Sub btnBeneficiar_Click()
    On Error GoTo ErrorCode

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinBeneficiar <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinBeneficiar
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\COMMON\client.flt", NumChildWinBeneficiar

        If NumChildWinBeneficiar <> 0 Then
            Dim InitParamGrid As Variant
            Dim GridF As Object
            Dim varCond As Variant
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinBeneficiar, "UbsGridList")
            
            If Parent.IsExistParam(NumChildWinBeneficiar, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinBeneficiar, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinBeneficiar, "SelectItem") Then Parent.ParamInfo(NumChildWinBeneficiar, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinBeneficiar
            End If
            Set GridF = Nothing
        End If
    End If

    Call EnabledCmdControl(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор из списка клиента-бенефициара", "ошибка выполнения"
End Sub

Private Sub btnPreviousContract_Click()
    On Error GoTo ErrorCode

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinPreviousContract <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinPreviousContract
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\BG\LIST_CONTRACT.flt", NumChildWinPreviousContract
        If NumChildWinPreviousContract <> 0 Then
            Dim InitParamGrid As Variant
            Dim GridF As Object
            Dim varCond As Variant
            Dim intKeyCond As Integer
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinPreviousContract, "UbsGridList")
            
            'intKeyCond = GridF.AddWhereItem("Состояние", 4, 0)
            'GridF.WhereItemFlags(intKeyCond) = 0 'невидимое условие
            
            If Parent.IsExistParam(NumChildWinPreviousContract, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinPreviousContract, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinPreviousContract, "SelectItem") Then Parent.ParamInfo(NumChildWinPreviousContract, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinPreviousContract
            End If
            Set GridF = Nothing
        End If
    End If
    Call EnabledCmdControl(True)
    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор прежнего договора гарантии", "ошибка выполнения"
End Sub


Private Sub cmbExecut_Change()
    IdOI = cmbExecut.ItemData(cmbExecut.ListIndex)
End Sub

Private Sub cmbOrderPayFeeBonus_Change()
    dDateNextPayFeeBonus.DateValue = DateSerial(2222, 1, 1)
    Call SetBonusCtrlsBonusState()
End Sub

Private Sub cmbOrderPayFeeBonus_Click()
    Call SetBonusCtrlsBonusState()
End Sub

Private Sub cmbOrderPayFeeGuarant_Click()
    dDateNextPayFeeGuarant.DateValue = DateSerial(2222, 1, 1)
    Call SetBonusCtrlsStateGuarant()
End Sub

Private Sub cmbRiskReason_Change()

End Sub

Private Sub cmbTypePayFee_Click()
    If IdState = 4 Then
        If cmbTypePayFee.Text = "Процент суммы гарантии" Then
            cmbBonusValuta.ListIndex = cmbValuta.ListIndex
            cmbBonusValuta.Enabled = False
        Else
            cmbBonusValuta.Enabled = True
        End If
    End If
End Sub
Private Sub cmbTypePayFeeBonus_Click()
    If IdState = 4 Then
        If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
            cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
            cmbBonusValutaBonus.Enabled = False
        Else
            cmbBonusValutaBonus.Enabled = True
        End If
    End If
End Sub

Private Sub cmbTypeValidationRisk_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = 13 Then
        SendKeys(vbTab)
    End If
End Sub

Private Sub cmbValuta_Click()
    IdValuta = cmbValuta.ItemData(cmbValuta.ListIndex)
    If IdState = 4 Then
        If cmbTypePayFee.Text = "Процент суммы гарантии" Then
            cmbBonusValuta.ListIndex = cmbValuta.ListIndex
            cmbBonusValuta.Enabled = False
        Else
            cmbBonusValuta.Enabled = True
        End If
        If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
            cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
            cmbBonusValutaBonus.Enabled = False
        Else
            cmbBonusValutaBonus.Enabled = True
        End If
    End If
End Sub

Private Sub cmbWarrant_Change()
    IdWarrant = cmbWarrant.ItemData(cmbWarrant.ListIndex)
End Sub

Private Sub cmdPeriodPayFee_Click()
    Call GetBonusPayOrder(arrInterval)
    objInterfaces.NextCtrl
End Sub

Private Sub btnExit_Click()
    Call Parent.CloseWindow(NumWin)
End Sub

Private Sub btnGarant_Click()
    On Error GoTo ErrorCode

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinGarant <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinGarant
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\COMMON\client.flt", NumChildWinGarant

        If NumChildWinGarant <> 0 Then
            Dim InitParamGrid As Variant
            Dim GridF As Object
            Dim varCond As Variant
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinGarant, "UbsGridList")
            
            If Parent.IsExistParam(NumChildWinGarant, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinGarant, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinGarant, "SelectItem") Then Parent.ParamInfo(NumChildWinGarant, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinGarant
            End If
            Set GridF = Nothing
        End If
    End If

    Call EnabledCmdControl(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор из списка клиента-гаранта", "ошибка выполнения"
End Sub

Private Sub btnModel_Click()
    On Error GoTo ErrorCode
    Dim InitParamGrid As Variant
    Dim GridF As Object
    Dim varCond As Variant
    Dim intKeyCond As Integer
    Dim Kinds As Variant
    Dim i As Long

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinModel <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinModel
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\BG\LIST_MODEL.flt", NumChildWinModel

        If NumChildWinModel <> 0 Then
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinModel, "UbsGridList")
            
            intKeyCond = GridF.AddWhereItem("Состояние", 4, 0)
            GridF.WhereItemFlags(intKeyCond) = 0 'невидимое условие

            If IdFrameContract > 0 And IsArray(FrameContractTerms) Then
                ReDim Kinds(UBound(FrameContractTerms, 2))
                For i = 0 To UBound(FrameContractTerms, 2)
                    Kinds(i) = FrameContractTerms(0, i)
                Next
                intKeyCond = GridF.AddWhereItem("Вид гарантии", 8, Kinds)
                GridF.WhereItemFlags(intKeyCond) = 1 'видимое условие
            End If

            If Parent.IsExistParam(NumChildWinModel, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinModel, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinModel, "SelectItem") Then Parent.ParamInfo(NumChildWinModel, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinModel
            End If
            Set GridF = Nothing
        End If
    End If

    Call EnabledCmdControl(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор из списка типового договора", "ошибка выполнения"
End Sub

Private Sub btnPrincipal_Click()
    On Error GoTo ErrorCode

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinPrincipal <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinPrincipal
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\COMMON\client.flt", NumChildWinPrincipal

        If NumChildWinPrincipal <> 0 Then
            Dim InitParamGrid As Variant
            Dim GridF As Object
            Dim varCond As Variant
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinPrincipal, "UbsGridList")
            
            If Parent.IsExistParam(NumChildWinPrincipal, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinPrincipal, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinPrincipal, "SelectItem") Then Parent.ParamInfo(NumChildWinPrincipal, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinPrincipal
            End If
            Set GridF = Nothing
        End If
    End If

    Call EnabledCmdControl(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор из списка клиента-принципала", "ошибка выполнения"
End Sub

Private Sub btnReRead_Click()
    If (UCase(StrCommand) = "EDIT") And (IdContract > 0) Then
        Call ReReadDoc()
    End If
End Sub

Private Sub btnSave_Click()
    Dim i As Long
    Dim dateEdit As Date
    Dim isNeedChangeRisk As Boolean  ' нужно ли менять риск при команде EDIT
    On Error GoTo ErrorCode

    'MsgBox "01"
    If Not Check() Then Exit Sub

    Call EnableControls(False)

    IdDivision = cmbNumberDiv.ItemData(cmbNumberDiv.ListIndex)
    IdOI = cmbExecut.ItemData(cmbExecut.ListIndex)
    IdWarrant = cmbWarrant.ItemData(cmbWarrant.ListIndex)
    IdValuta = cmbValuta.ItemData(cmbValuta.ListIndex)

    lIdCoverValuta = cmbCoverValuta.ItemData(cmbCoverValuta.ListIndex)
    IdCoverType = cmbCoverType.ItemData(cmbCoverType.ListIndex)
    lIdBonusValuta = cmbBonusValuta.ItemData(cmbBonusValuta.ListIndex)
    lIdBonusValutaBonus = cmbBonusValutaBonus.ItemData(cmbBonusValutaBonus.ListIndex)
    bNeedRefreshGrid = True
    objParamIn.ClearParameters
    objParamOut.ClearParameters

    If UCase(StrCommand) <> "EDIT" And UCase(StrCommand) <> "PREPARE" Then
        StrCommand = "ADD"
    End If

    objParamIn.Parameter("StrCommand") = StrCommand

    objParamIn.Parameter("Идентификатор клиента-принципала") = IdPrincipal
    objParamIn.Parameter("Идентификатор клиента-бенефициара") = IdBeneficiar
    objParamIn.Parameter("Идентификатор договора агента") = IdAgent  ' [14617]
    If IdBeneficiar = 0 Then
        objParamIn.Parameter("Наименование бенефициара") = arrDetailsBeneficiar(0, 0)
        objParamIn.Parameter("ИНН бенефициара") = arrDetailsBeneficiar(1, 0)
        objParamIn.Parameter("Адрес бенефициара") = arrDetailsBeneficiar(2, 0)
    Else ' на случай, если были введены реквизиты, а потом выбрали бенефициара из списка и надо почистить доп.поля
        objParamIn.Parameter("Наименование бенефициара") = Empty
        objParamIn.Parameter("ИНН бенефициара") = Empty
        objParamIn.Parameter("Адрес бенефициара") = Empty
    End If

    If sModelType = "UBS_COUNTER_GUARANT" Then
        objParamIn.Parameter("Идентификатор клиента-гаранта") = IdGarant
    End If
    objParamIn.Parameter("Номер отделения") = IdDivision
    objParamIn.Parameter("Номер договора") = txtNumber.Text
    objParamIn.Parameter("Дата заключения") = txtDateOpen.DateValue
    'objParamIn.Parameter("Дата начала действия (Init)") = dateBeginC   ' (70774)
    objParamIn.Parameter("Дата начала действия") = txtDateBegin.DateValue
    ' [16430]  ---
    If txtDatePrincipal.DateValue = DateSerial(2222, 1, 1) Then
        txtDatePrincipal.DateValue = txtDateBegin.DateValue
    End If
    objParamIn.Parameter("Дата возникн. обязательства Принципала") = txtDatePrincipal.DateValue
    ' [16430]  ---
    objParamIn.Parameter("Дата окончания действия") = txtDateEnd.DateValue
    objParamIn.Parameter("Идентификатор ОИ") = IdOI
    objParamIn.Parameter("Идентификатор доверенности") = IdWarrant

    If (cmbOrderPayFee.Text = "Периодически") Then
        If cmdPeriodPayFee.Enabled Then
            objParamIn.Parameter("Вознаграждение. Тип периода") = arrInterval(0, 0)
            objParamIn.Parameter("Вознаграждение. Период") = arrInterval(1, 0)
            objParamIn.Parameter("Вознаграждение. Тип даты") = arrInterval(2, 0)
            objParamIn.Parameter("Вознаграждение. Номер дня") = arrInterval(3, 0)
        End If
    End If

    If (cmbOrderPayFeeBonus.Text = "Периодически") Then
        If cmdPeriodPayFeeBonus.Enabled Then
            objParamIn.Parameter("Вознаграждение за выдачу. Тип периода") = arrIntervalBonus(0, 0)
            objParamIn.Parameter("Вознаграждение за выдачу. Период") = arrIntervalBonus(1, 0)
            objParamIn.Parameter("Вознаграждение за выдачу. Тип даты") = arrIntervalBonus(2, 0)
            objParamIn.Parameter("Вознаграждение за выдачу. Номер дня") = arrIntervalBonus(3, 0)
        End If
    End If

    If (strOrderPayFeeGuarant <> "") Then
        objParamIn.Parameter("Вознаграждение (гарант). Порядок уплаты") = cmbOrderPayFeeGuarant.Text
        objParamIn.Parameter("Вознаграждение (гарант). Тип") = cmbTypePayFeeGuarant.Text

        If (cmbOrderPayFeeGuarant.Text = "Периодически") Then
            objParamIn.Parameter("Вознаграждение (гарант). Тип периода") = arrIntervalGuarant(0, 0)
            objParamIn.Parameter("Вознаграждение (гарант). Период") = arrIntervalGuarant(1, 0)
            objParamIn.Parameter("Вознаграждение (гарант). Тип даты") = arrIntervalGuarant(2, 0)
            objParamIn.Parameter("Вознаграждение (гарант). Номер дня") = arrIntervalGuarant(3, 0)

            objParamIn.Parameter("Дата след. уплаты вознаграждения (гарант)") = dDateNextPayFeeGuarant.DateValue
        End If
    End If

    If UCase(StrCommand) = "ADD" Or UCase(StrCommand) = "PREPARE" Then
        objParamIn.Parameter("Порядок уплаты вознаграждения") = cmbOrderPayFee.Text
        objParamIn.Parameter("Вознаграждение. Тип") = cmbTypePayFee.Text

        objParamIn.Parameter("Порядок уплаты вознаграждения за выдачу") = cmbOrderPayFeeBonus.Text
        objParamIn.Parameter("Вознаграждение за выдачу. Тип") = cmbTypePayFeeBonus.Text

        objParamIn.Parameter("Идентификатор типового договора") = IdModel
        objParamIn.Parameter("Состояние") = IdState
        objParamIn.Parameter("Переоформляемый договор") = IdPrevContract
    End If

    If dDateNextPayFee.Enabled Then
        objParamIn.Parameter("Дата следующей уплаты вознаграждения") = dDateNextPayFee.DateValue
    End If
    If dDateNextPayFeeBonus.Enabled Then
        objParamIn.Parameter("Дата след. упл.вознаграждения за выдачу") = dDateNextPayFeeBonus.DateValue
    End If

    ' данные риска
    objParamIn.Parameter("Идентификатор портфеля") = cmbPortfolio.ItemData(cmbPortfolio.ListIndex)
    objParamIn.Parameter("Тип оценки риска") = cmbTypeValidationRisk.ItemData(cmbTypeValidationRisk.ListIndex)
    objParamIn.Parameter("Ставка резервирования") = ucmRateReservation.CurrencyValue
    objParamIn.Parameter("Группа риска") = Val(cmbQualityCategory.Text)
    'objParamIn.Parameter("Причина классификации ссуды") = cmbRiskReason.ItemData(cmbRiskReason.ListIndex)


    objParamIn.Parameter("Дата вознаграждения") = DateReward.DateValue
    objParamIn.Parameter("Сумма затрат") = CostAmount.CurrencyValue

    objParamIn.Parameter("Дата по корректировке") = DateAdjustment.DateValue
    objParamIn.Parameter("Уплаченная сумма") = PaidAmount.CurrencyValue
    objParamIn.Parameter("Перечисленная сумма") = TransferedAmount.CurrencyValue

    'MsgBox "02"
    If UCase(StrCommand) = "EDIT" Then
        ' а нужно ли менять риск?
        ' Нужно, если данные на форме не совпадают с данными риска в договоре
        Call oleUbsChannel.Run("BG_IsNeedChangeRisk", objParamIn, objParamOut)
        ' изменился ли риск
        isNeedChangeRisk = objParamOut.Parameter("isNeedChangeRisk")
        objParamIn.Parameter("isNeedChangeRisk") = isNeedChangeRisk
    End If

    ' IdState = 2 - заключен (4 - подготовлен) (18767)
    If UCase(StrCommand) = "EDIT" And (IdState = 2 Or IdState = 4) Then
        objParamIn.Parameter("Порядок уплаты вознаграждения") = cmbOrderPayFee.Text
        objParamIn.Parameter("Вознаграждение. Тип") = cmbTypePayFee.Text

        objParamIn.Parameter("Порядок уплаты вознаграждения за выдачу") = cmbOrderPayFeeBonus.Text
        objParamIn.Parameter("Вознаграждение за выдачу. Тип") = cmbTypePayFeeBonus.Text
    End If

    If UCase(StrCommand) = "ADD" Or UCase(StrCommand) = "PREPARE" _
                Or IdState = 4 Then
        objParamIn.Parameter("Дата изменения") = txtDateBegin.DateValue
    Else
        If isNeedChangeRisk And IdState <> 2 Then
            If Not FindInArray(arrExecutEx, Val(cmbExecut.ItemData(cmbExecut.ListIndex)), 0) Then
                MsgBox "Нет доступа на выполнение операций", vbExclamation + vbOKOnly, "Ошибка"
                Call EnableControls()
                Exit Sub
            End If

            'спросим дату изменений и передадим её в сценарий, если договор не в состоянии "заключен"
            dateEdit = CDate(objInputBox.InputBox("Введите дату изменения параметров риска", m_strCaptionForm, , 4))

            If dateEdit = TimeSerial(0, 0, 0) Then
                Call EnableControls()
                Exit Sub
            End If

            If dateEdit >= dDate2222 Or dateEdit <= dDate1990 Or Not IsDate(dateEdit) Then
                MsgBox "Введите корректную дату!", vbExclamation + vbOKOnly, "Ошибка"
                Call EnableControls()
                Exit Sub
            End If

            objParamIn.Parameter("Дата изменения") = dateEdit
        Else
            objParamIn.Parameter("Дата изменения") = txtDateBegin.DateValue
        End If
    End If

    'MsgBox "03"
    If IdState = 4 Then
        If Not CheckTerm() Then
            Call EnableControls()
            Exit Sub
        End If

        If Not CheckFrameLimit() Then
            Call EnableControls()
            Exit Sub
        End If

        If Not CheckIssueDate() Then
            Call EnableControls()
            Exit Sub
        End If

        ' [15508] 16.11.2018 [ADR] Отделение устанавливается из рамочного договора
        If IdFrameContract > 0 And FrameContractDivision > 0 Then
            SetComboText cmbNumberDiv, FrameContractDivision
        End If
    End If

    'MsgBox "04"
    'If UCase(StrCommand) = "ADD" Or (isNeedChangeRisk And IdState <> 2) Then

    '   If Not FindInArray(arrExecutEx, Val(cmbExecut.ItemData(cmbExecut.ListIndex)), 0) Then
    '          MsgBox "Нет доступа на выполнение операций", vbExclamation + vbOKOnly, "Ошибка"
    '          Call EnableControls
    '          Exit Sub
    '   End If

    'спросим дату изменений и передадим её в сценарий, если договор не в состоянии "заключен"
    '   dateEdit = CDate(objInputBox.InputBox("Введите дату изменения параметров риска", m_strCaptionForm, , 4))

    '   If dateEdit = TimeSerial(0, 0, 0) Then
    '      Call EnableControls
    '      Exit Sub
    '   End If

    '   If dateEdit >= dDate2222 Or dateEdit <= dDate1990 Or Not IsDate(dateEdit) Then
    '      MsgBox "Введите корректную дату!", vbExclamation + vbOKOnly, "Ошибка"
    '      Call EnableControls
    '      Exit Sub
    '   End If

    '   objParamIn.Parameter("Дата изменения") = dateEdit
    'End If

    objParamIn.Parameter("Идентификатор валюты") = IdValuta

    objParamIn.Parameter("Счета") = arrAccounts
    '---------------------------------------------------------------------------------
    If IsArray(arrRates) Then
        For i = 0 To UBound(arrRates)
            objParamIn.Parameter(strRatePrefix & arrRates(i)) = arrRateValues(i)
        Next i
    End If
    '---------------------------------------------------------------------------------
    '/////////////////// Доп. поля
    '---------------------------------------------------------------------------------
    objParamIn.Parameter("Сумма гарантии") = txtGarantSumma.CurrencyValue
    objParamIn.Parameter("Идентификатор валюты вознаграждения") = lIdBonusValuta
    objParamIn.Parameter("Ид. вал. вознаграждения за выдачу") = lIdBonusValutaBonus
    '83476
    Dim arrCover(3, 0)
    If UCase(StrCommand) = "EDIT" Then
        arrCover(0, 0) = IdCoverType
        arrCover(1, 0) = txtCoverSumma.CurrencyValue
        arrCover(2, 0) = lIdCoverValuta
        arrCover(3, 0) = lIdCoverContract
    Else
        arrCover(0, 0) = IdCoverType
        arrCover(1, 0) = txtCoverSumma.CurrencyValue
        arrCover(2, 0) = lIdCoverValuta
        arrCover(3, 0) = 0
    End If
    objParamIn.Parameter("Покрытие") = arrCover
    Dim arrPerPay(1, 0) As Variant
    If IsArray(arrPeriodPay) Then
        arrPerPay(0, 0) = arrPeriodPay(0, 0)
        arrPerPay(1, 0) = arrPeriodPay(1, 0)
    End If
    objParamIn.Parameter("Срок погашения оплаченной суммы") = arrPerPay
    'заявка 75615 • передаю в пользовательскую проверку действий два новых параметра
    objParamIn.Parameter("Идентификатор договора гарантии") = IdContract
    objParamIn.Parameter("Идентификатор типового договора") = IdModel

    objParamIn.Parameter("Идентификатор рамочного договора") = IdFrameContract
    objParamIn.Parameter("Вид гарантии") = kindComboBox.Text

    '---------------------------------------------------------------------------------
    ' Пользовательская проверка - KVF, 28.06.2012
    If Not objUbsCheck.SystemCheckAction(oleUbsChannel, objParamIn, "BG", IIf(UCase(StrCommand) = "EDIT", "UBS_BG_CONTRACT_EDIT", "UBS_BG_CONTRACT_ADD"), "Договор гарантии") Then
        Call EnableControls()
        Exit Sub
    End If
    '---------------------------------------------------------------------------------

    'MsgBox "05"
    Call oleUbsChannel.Run("BG_Contract_Edit", objParamIn, objParamOut)

    If objParamOut.Parameter("Код ошибки") <> 0 Then
        MsgBox objParamOut.Parameter("Текст ошибки"), vbCritical, "Договор банковской гарантии"
        Call EnableControls()
        Exit Sub
    End If

    If Not UCase(StrCommand) = "EDIT" Then
        StrCommand = "EDIT"
        btnReRead.Enabled = True
        cmdAddGuarant.Enabled = True
        IdContract = objParamOut.Parameter("ID")
    End If

    blnAddFlChanged = False
    Info.Caption = "Данные сохранены!"
    Info.Show

    dateBeginC = txtDateBegin.DateValue    ' (72952)

    If IdState = 4 Then
        'MsgBox "SAVE True"
        btnPreviousContract.Enabled = True
        btnModel.Enabled = True
        btnModel.Visible = True

        btnFrameContractDel.Visible = True
        btnFrameContract.Visible = True

        btnAgentDel.Visible = True
        btnAgent.Visible = True

        cmbNumberDiv.Enabled = True
    Else
        'MsgBox "SAVE False = " & IdState
        btnPreviousContract.Enabled = False
        btnModel.Enabled = False
        btnModel.Visible = False

        btnFrameContractDel.Visible = False
        btnFrameContract.Visible = False
        'txtFrameContract.Width = 4695

        btnAgentDel.Visible = False
        btnAgent.Visible = False
        'txtAgent.Width = 4695

        cmbNumberDiv.Enabled = False
    End If

    Call EnableControls()
    btnExit.SetFocus

    If IdState = 4 Then
        'MsgBox "2 SAVE True"
        cmbNumberDiv.Enabled = True
        btnGarant.Enabled = True
        cmbValuta.Enabled = cmbValutaEnabled()
        btnPreviousContract.Enabled = True

        cmbOrderPayFee.Enabled = True
        cmbTypePayFee.Enabled = True

        cmbOrderPayFeeBonus.Enabled = True
        cmbTypePayFeeBonus.Enabled = True
    End If

    'If IdState = 4 Then IdState = 2

    Exit Sub
ErrorCode:
    Call EnableControls()
    objErr.UbsErrMsg "btnSave_Click", "ошибка выполнения"
End Sub

Private Sub UpdateCover()
    If IdCoverType > 0 Then
        txtCoverSumma.Enabled = True
        cmbCoverValuta.Enabled = True
    Else
        txtCoverSumma.Enabled = False
        cmbCoverValuta.Enabled = False
    End If
End Sub

Private Sub cmbCoverType_Click()

    IdCoverType = cmbCoverType.ItemData(cmbCoverType.ListIndex)
    Call UpdateCover()

End Sub


Private Sub cmbNumberDiv_Change()
    IdDivision = cmbNumberDiv.ItemData(cmbNumberDiv.ListIndex)
End Sub

Private Sub cmbOrderPayFee_Click()
    dDateNextPayFee.DateValue = DateSerial(2222, 1, 1)
    Call SetBonusCtrlsState()
End Sub

Private Sub cmbPortfolio_Click()
    If cmbPortfolio.ListIndex = 0 Then
        ucmRateReservation.Enabled = True
        ucmRateReservation.CurrencyValue = arrQualityCategory(2, cmbQualityCategory.ListIndex)
    Else
        ucmRateReservation.Enabled = False
        ucmRateReservation.CurrencyValue = 0
    End If
End Sub

Private Sub cmbQualityCategory_Click()
    If ucmRateReservation.Enabled Then
        ucmRateReservation.CurrencyValue = arrQualityCategory(2, cmbQualityCategory.ListIndex)
    End If
End Sub

Private Sub cmdAdd_Click()
    Call GetRate("ADD")
End Sub

Private Sub cmdAddGuarant_Click()

    Call AddEditGuarContract("Add")

End Sub

Private Sub cmdDel_Click()
    Dim q As Integer
    Dim i As Integer
    Dim j As Integer
    Dim strKey As String
    Dim arrRateTemp As Variant
    Dim strTypeRate As String
    Dim strDateRate As String
    On Error GoTo ErrorCode

    If trvRates.SelectedItem Is Nothing Then
        Exit Sub
    End If

    strKey = trvRates.SelectedItem.Key

    strDateRate = Mid(trvRates.SelectedItem.Text, 1, 10)

    Call trvRates.Nodes.Remove(trvRates.SelectedItem.index)

    q = InStr(strKey, " Date:")
    strTypeRate = Mid(strKey, 11, q - 11)

    For i = 0 To UBound(arrRates)
        If arrRates(i) = strTypeRate Then
            arrRateTemp = arrRateValues(i)
            For j = 0 To UBound(arrRateTemp, 2)
                If arrRateTemp(0, j) = strDateRate Then
                    objArray.ADel2 arrRateTemp, j
                arrRateValues(i) = arrRateTemp
                    Exit For
                End If
            Next j
            Exit For
        End If
    Next i

    trvRates_Click()

    If cmdDel.Enabled Then
        objInterfaces.GoToCtrl cmdDel
    ElseIf cmdAdd.Enabled Then
        objInterfaces.GoToCtrl cmdAdd
    End If

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "cmdDel_Click", "ошибка выполнения"
End Sub

Private Sub cmdEdit_Click()
    Call GetRate("EDIT")
End Sub

Private Sub cmdEditGuarant_Click()

    If lvwGuarant.ListItems.Count = 0 Then Exit Sub

    Call AddEditGuarContract("Edit")

End Sub

Private Sub btnFrameContract_Click()
    Dim intKeyCond As Integer
    On Error GoTo ErrorCode

    Call EnabledCmdControl(False)

    DoEvents
    If NumChildWinFrContract <> 0 Then
        Me.Parent.SetFocusToWindow NumChildWinFrContract
        DoEvents
    Else
        DoEvents

        Me.Parent.GetWindow "UBS_FLT\BG\LIST_FRAME_CONTRACT.flt", NumChildWinFrContract

        If NumChildWinFrContract <> 0 Then
            Dim InitParamGrid As Variant
            Dim GridF As Object
            Dim varCond As Variant
            ReDim InitParamGrid(5)
            
            Set GridF = Me.Parent.ParamInfo(NumChildWinFrContract, "UbsGridList")
            'GridF.ClearWhereList
        
            intKeyCond = GridF.AddWhereItem("Состояние", 4, 0)
            GridF.WhereItemFlags(intKeyCond) = 0 'невидимое условие

            If Parent.IsExistParam(NumChildWinFrContract, "InitParamGrid") Then
                InitParamGrid(0) = NumWin : InitParamGrid(2) = True : InitParamGrid(5) = 1
                Parent.ParamInfo(NumChildWinFrContract, "InitParamGrid") = InitParamGrid
                If Parent.IsExistParam(NumChildWinFrContract, "SelectItem") Then Parent.ParamInfo(NumChildWinFrContract, "SelectItem") = Empty
                Parent.SetFocusToWindow NumChildWinFrContract
            End If
            Set GridF = Nothing
        End If
    End If

    Call EnabledCmdControl(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "Выбор из списка рамочного договора", "ошибка выполнения"
End Sub

Private Sub btnFrameContractDel_Click()
    IdFrameContract = 0
    txtFrameContract.Text = ""
    btnPrincipal.Enabled = True
    cmbValuta.Enabled = cmbValutaEnabled()
    dFrameContractDateBegin = dDate2222
    dFrameContractDateEnd = dDate2222
    FrameContractTerms = Empty
    FrameContractLimitSaldo = CCur(0)
    IssueEndDate = dDate2222
    FrameContractDivision = 0
    ResetKindComboBox()
    kindComboBox.Enabled = True
    SSActiveTabs1.Tabs(2).Enabled = True
End Sub

Private Sub cmdInclude_Click()
    Dim i As Integer
    Dim arrIdGuarant As Variant
    Dim RetVal1 As Variant, RetVal2 As Variant, varCond As Variant
    Dim objGridList As Object
    On Error GoTo ErrorCode

    Call GuarCmdState(False, True)

    If NumChildWinListGuarant Then
        Parent.SetFocusToWindow NumChildWinListGuarant
    Else

        Parent.GetWindow "UBS_FLT\BG\BG_GUAR_CONTRACT.flt", NumChildWinListGuarant

        If NumChildWinListGuarant <> 0 Then
        
            Set objGridList = Parent.ParamInfo(NumChildWinListGuarant, "UbsGridList")
                        
            varCond = Empty
            arrIdGuarant = Empty
            If lvwGuarant.ListItems.Count > 0 Then
                ReDim arrIdGuarant(lvwGuarant.ListItems.Count - 1)
                For i = 0 To lvwGuarant.ListItems.Count - 1
                    arrIdGuarant(i) = lvwGuarant.ListItems(i + 1).Text
                Next i
            End If

            'Установка условий фильтра, если для объекта обеспечения добавлен хотя бы один договор обеспечения
            If IsArray(arrIdGuarant) Then
                RetVal1 = 0

                If Not IsEmpty(varCond) Then
                    For i = 0 To UBound(varCond, 2)
                        If varCond(0, i) = "Идентификатор договора" Then
                            RetVal1 = varCond(4, i)
                        End If
                    Next
                End If
                'Установка условий фильтра: идентификатор договора обеспечения не равен
                '   идентификаторам уже добавленных договоров
                If RetVal1 = 0 Then
                    RetVal1 = objGridList.AddWhereItem("Идентификатор договора", 9, arrIdGuarant)
                Else
                    objGridList.DelWhereItem RetVal1
                    RetVal1 = objGridList.AddWhereItem("Идентификатор договора", 9, arrIdGuarant)
                End If
            End If

            'Установка условий фильтра: Код бизнеса
            'RetVal2 = 0
            'If Not IsEmpty(varCond) Then
            '    For i = 0 To UBound(varCond, 2)
            '        If varCond(0, i) = "Код типа объекта" Then
            '            RetVal2 = varCond(4, i)
            '        End If
            '    Next
            'End If

            'If RetVal2 = 0 Then
            '    RetVal2 = objGridList.AddWhereItem("Код типа объекта", 4, "BG")
            'Else
            '    objGridList.EditWhereItem RetVal2, "Код типа объекта", 4, "BG"
            'End If

            'objGridList.WhereItemFlags(RetVal2) = 1

            ' Определим наличие условия "Код типа объекта" и удалим его
            Dim varItems As Variant, countItems As Integer
            countItems = objGridList.GetWhereRS(1, varItems)
            For i = 0 To countItems - 1
                If CStr(varItems(0, i)) = "Код типа объекта" Then
                    objGridList.EditWhereItem RetVal2, "Код типа объекта", 4, Empty
                End If
            Next

            If Parent.IsExistParam(NumChildWinListGuarant, "InitParamGrid") Then

                ReDim varInitParam(5)
                varInitParam(0) = NumWin
                varInitParam(2) = True
                varInitParam(5) = 1

                Parent.ParamInfo(NumChildWinListGuarant, "InitParamGrid") = varInitParam
                Parent.SetFocusToWindow NumChildWinListGuarant

            End If

        End If


        SSActiveTabs1.SelectedTab = 5
        lvwGuarant.SetFocus

    End If

    Call GuarCmdState(True)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "cmdInclude_Click", "ошибка выполнения"
End Sub

Private Sub cmdListGuarantOperDog_Click()
    On Error GoTo ErrorCode
    Dim varInitParam(2) As Variant
    Dim varCond As Variant, RetVal1 As Long, i As Integer
    Dim objGridList As Object

    If lvwGuarant.ListItems.Count = 0 Then
        Exit Sub
    End If

    Call GuarCmdState(False, True)

    If NumChildWinListGuarantOper Then
        Parent.SetFocusToWindow NumChildWinListGuarantOper
    Else

        Parent.GetWindow "UBS_FLT\GUAR\LIST_OPERATION_LOG.flt", NumChildWinListGuarantOper

        If NumChildWinListGuarantOper <> 0 Then
    
            Set objGridList = Parent.ParamInfo(NumChildWinListGuarantOper, "UbsGridList")
    
        '    objGridList.GetWhereRS 1, varCond
            RetVal1 = 0

            '   If Not IsEmpty(varCond) Then
            '     For i = 0 To UBound(varCond, 2)
            '       If varCond(0, i) = "Идентификатор договора" Then
            '         RetVal1 = varCond(4, i)
            '     End If
            ' Next
            'End If
            objGridList.ClearWhereList
            'Установка условий фильтра
            If RetVal1 = 0 Then
                RetVal1 = objGridList.AddWhereItem("Идентификатор договора", 4, Val(lvwGuarant.SelectedItem.Text))
            Else
                objGridList.DelWhereItem RetVal1
                RetVal1 = objGridList.AddWhereItem("Идентификатор договора", 4, Val(lvwGuarant.SelectedItem.Text))
            End If

            objGridList.WhereItemFlags(RetVal1) = 0

            If Parent.IsExistParam(NumChildWinListGuarantOper, "InitParamGrid") Then

                varInitParam(0) = NumWin
                varInitParam(2) = True

                Parent.ParamInfo(NumChildWinListGuarantOper, "InitParamGrid") = varInitParam
                Parent.SetFocusToWindow NumChildWinListGuarantOper

            End If

        End If

        SSActiveTabs1.SelectedTab = 5
        lvwGuarant.SetFocus


    End If

    Call GuarCmdState(True)
    '    SSActiveTabs1.SelectedTab = 6
    '    objInterfaces.GoToCtrl ucpParam
    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "cmdListGuarantOperDog_Click", "ошибка выполнения"
End Sub

Private Sub cmdManualBenificiar_Click()
    On Error GoTo ErrorCode
    Load frmDetailsBenificiar

    Dim i As Integer
    Dim arrAddress

    If Not IsArray(arrCountry) Then
        objParamIn.ClearParameters
        objParamOut.ClearParameters
        objParamIn.Parameter("Тип данных") = "Страны"
        Call oleUbsChannel.Run("GetAddressData", objParamIn, objParamOut)
        arrCountry = objParamOut.Parameter("Данные")

        If IsArray(arrCountry) Then
            For i = 0 To UBound(arrCountry, 2)
                ' Так мучаемся с "-", из-за того, что код "ЕС" = "-"
                frmDetailsBenificiar.cmbCodeCountry.AddItem(arrCountry(0, i))
                frmDetailsBenificiar.cmbCountry.AddItem(arrCountry(1, i))
            Next

            frmDetailsBenificiar.arrCountry = arrCountry
            frmDetailsBenificiar.cmbCodeCountry.Text = "643"
        End If
    End If

    If Not IsArray(arrTypeObject) Then
        objParamIn.ClearParameters
        objParamOut.ClearParameters
        objParamIn.Parameter("Тип данных") = "Типы объектов"
        objParamIn.Parameter("Код страны") = "643"
        objParamIn.Parameter("Условия получения данных") = objParamIn.Parameters
        Call oleUbsChannel.Run("GetAddressData", objParamIn, objParamOut)
        arrTypeObject = objParamOut.Parameter("Данные")
        frmDetailsBenificiar.arrTypeObject = arrTypeObject
    End If

    If (IsArray(arrTypeObject) And frmDetailsBenificiar.cmbCodeCountry.Text = "643" And frmDetailsBenificiar.cmbTypeRegion.ListCount = 0 And
        frmDetailsBenificiar.cmbTypeArea.ListCount = 0 And frmDetailsBenificiar.cmbTypeCity.ListCount = 0 And
        frmDetailsBenificiar.cmbTypeSettl.ListCount = 0 And frmDetailsBenificiar.cmbTypeStreet.ListCount = 0 And
        frmDetailsBenificiar.cmbTypeHome.ListCount = 0 And frmDetailsBenificiar.cmbTypeHousing.ListCount = 0 And
        frmDetailsBenificiar.cmbTypeFlat.ListCount = 0) Then

        For i = 0 To UBound(arrTypeObject, 2)

            Select Case CInt(arrTypeObject(0, i))
                Case 1 : frmDetailsBenificiar.cmbTypeRegion.AddItem(arrTypeObject(1, i))
                Case 2 : frmDetailsBenificiar.cmbTypeArea.AddItem(arrTypeObject(1, i))
                Case 3 : frmDetailsBenificiar.cmbTypeCity.AddItem(arrTypeObject(1, i))
                Case 4 : frmDetailsBenificiar.cmbTypeSettl.AddItem(arrTypeObject(1, i))
                Case 5 : frmDetailsBenificiar.cmbTypeStreet.AddItem(arrTypeObject(1, i))
                Case 6 : frmDetailsBenificiar.cmbTypeHome.AddItem(arrTypeObject(1, i))
                Case 7 : frmDetailsBenificiar.cmbTypeHousing.AddItem(arrTypeObject(1, i))
                Case 8 : frmDetailsBenificiar.cmbTypeFlat.AddItem(arrTypeObject(1, i))
            End Select
        Next
    End If

    If IsArray(arrDetailsBeneficiar) Then
        frmDetailsBenificiar.txtName.Text = arrDetailsBeneficiar(0, 0)
        frmDetailsBenificiar.txtINN.Text = arrDetailsBeneficiar(1, 0)

        arrAddress = arrDetailsBeneficiar(2, 0)
        frmDetailsBenificiar.txtIndex.Text = arrAddress(0, 0) : frmDetailsBenificiar.cmbCodeCountry.Text = arrAddress(1, 0)  'Индекс , Страна
        frmDetailsBenificiar.cmbTypeRegion.Text = arrAddress(2, 0) : frmDetailsBenificiar.txtRegion.Text = arrAddress(3, 0) 'Тип региона, Регион
        frmDetailsBenificiar.cmbTypeArea.Text = arrAddress(4, 0) : frmDetailsBenificiar.txtArea.Text = arrAddress(5, 0) 'Тип района, Район
        frmDetailsBenificiar.cmbTypeCity.Text = arrAddress(6, 0) : frmDetailsBenificiar.txtCity.Text = arrAddress(7, 0) 'Тип города, Город
        frmDetailsBenificiar.cmbTypeSettl.Text = arrAddress(8, 0) : frmDetailsBenificiar.txtSettl.Text = arrAddress(9, 0) 'Тип н.п., Насел.пункт
        frmDetailsBenificiar.cmbTypeStreet.Text = arrAddress(10, 0) : frmDetailsBenificiar.txtStreet.Text = arrAddress(11, 0) 'Тип улицы, Улица
        frmDetailsBenificiar.cmbTypeHome.Text = arrAddress(12, 0) : frmDetailsBenificiar.txtHome.Text = arrAddress(13, 0) 'Тип дома, Дом
        frmDetailsBenificiar.cmbTypeHousing.Text = arrAddress(14, 0) : frmDetailsBenificiar.txtHousing.Text = arrAddress(15, 0) 'Тип корпуса, Корпус
        frmDetailsBenificiar.cmbTypeFlat.Text = arrAddress(16, 0) : frmDetailsBenificiar.txtFlat.Text = arrAddress(17, 0)
    Else
        frmDetailsBenificiar.txtName.Text = ""
        frmDetailsBenificiar.txtINN.Text = ""

        frmDetailsBenificiar.txtIndex.Text = "" : frmDetailsBenificiar.cmbCodeCountry.Text = "643"  'Индекс , Страна
        frmDetailsBenificiar.cmbTypeRegion.Text = "" : frmDetailsBenificiar.txtRegion.Text = "" 'Тип региона, Регион
        frmDetailsBenificiar.cmbTypeArea.Text = "" : frmDetailsBenificiar.txtArea.Text = "" 'Тип района, Район
        frmDetailsBenificiar.cmbTypeCity.Text = "" : frmDetailsBenificiar.txtCity.Text = "" 'Тип города, Город
        frmDetailsBenificiar.cmbTypeSettl.Text = "" : frmDetailsBenificiar.txtSettl.Text = "" 'Тип н.п., Насел.пункт
        frmDetailsBenificiar.cmbTypeStreet.Text = "" : frmDetailsBenificiar.txtStreet.Text = "" 'Тип улицы, Улица
        frmDetailsBenificiar.cmbTypeHome.Text = "" : frmDetailsBenificiar.txtHome.Text = "" 'Тип дома, Дом
        frmDetailsBenificiar.cmbTypeHousing.Text = "" : frmDetailsBenificiar.txtHousing.Text = "" 'Тип корпуса, Корпус
        frmDetailsBenificiar.cmbTypeFlat.Text = "" : frmDetailsBenificiar.txtFlat.Text = ""
    End If

    frmDetailsBenificiar.Show vbModal

    If frmDetailsBenificiar.blnApply Then

        IdBeneficiar = 0

        txtBeneficiar.Text = frmDetailsBenificiar.txtName.Text

        ReDim arrDetailsBeneficiar(2, 0)
        arrDetailsBeneficiar(0, 0) = frmDetailsBenificiar.txtName.Text
        arrDetailsBeneficiar(1, 0) = frmDetailsBenificiar.txtINN.Text

        ReDim arrAddress(17, 0)
        arrAddress(0, 0) = frmDetailsBenificiar.txtIndex.Text : arrAddress(1, 0) = frmDetailsBenificiar.cmbCodeCountry.Text 'Индекс , Страна
        arrAddress(2, 0) = frmDetailsBenificiar.cmbTypeRegion.Text : arrAddress(3, 0) = frmDetailsBenificiar.txtRegion.Text 'Тип региона, Регион
        arrAddress(4, 0) = frmDetailsBenificiar.cmbTypeArea.Text : arrAddress(5, 0) = frmDetailsBenificiar.txtArea.Text 'Тип района, Район
        arrAddress(6, 0) = frmDetailsBenificiar.cmbTypeCity.Text : arrAddress(7, 0) = frmDetailsBenificiar.txtCity.Text 'Тип города, Город
        arrAddress(8, 0) = frmDetailsBenificiar.cmbTypeSettl.Text : arrAddress(9, 0) = frmDetailsBenificiar.txtSettl.Text 'Тип н.п., Насел.пункт
        arrAddress(10, 0) = frmDetailsBenificiar.cmbTypeStreet.Text : arrAddress(11, 0) = frmDetailsBenificiar.txtStreet.Text 'Тип улицы, Улица
        arrAddress(12, 0) = frmDetailsBenificiar.cmbTypeHome.Text : arrAddress(13, 0) = frmDetailsBenificiar.txtHome.Text 'Тип дома, Дом
        arrAddress(14, 0) = frmDetailsBenificiar.cmbTypeHousing.Text : arrAddress(15, 0) = frmDetailsBenificiar.txtHousing.Text 'Тип корпуса, Корпус
        arrAddress(16, 0) = frmDetailsBenificiar.cmbTypeFlat.Text : arrAddress(17, 0) = frmDetailsBenificiar.txtFlat.Text

        arrDetailsBeneficiar(2, 0) = arrAddress
    End If

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "cmdListGuarantOperDog_Click", "ошибка выполнения"

End Sub

Private Sub cmdPeriodPayFeeBonus_Click()
    Call GetBonusPayOrder(arrIntervalBonus)
    If cmbTypePayFeeBonus.Enabled Then
        objInterfaces.NextCtrl
    Else
        SSActiveTabs1.SelectedTab = 5
        objInterfaces.NextCtrl
    End If
End Sub

Private Sub cmdPeriodPayFeeGuarant_Click()
    Call GetBonusPayOrder(arrIntervalGuarant)
    objInterfaces.NextCtrl
End Sub


Private Sub lstAccounts_DblClick()
    Call mnuListAccounts_Click()
End Sub

Private Sub lstAccounts_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim i As Integer

    If KeyCode = vbKeyF2 Then
        mnuListAccounts_Click()
    ElseIf KeyCode = vbKeyDelete Then
        'По кнопке Delete удаляем счет из массива счетов arrAccounts и списка lstAccounts,
        '   а также из lstAccounts остаток на счете
        lstAccounts.SelectedItem.SubItems(2) = ""
        lstAccounts.SelectedItem.SubItems(3) = ""
        For i = 0 To UBound(arrAccounts, 2)
            If arrAccounts(0, i) = lstAccounts.SelectedItem.Text Then
                arrAccounts(2, i) = ""
            End If
        Next i
    End If

End Sub

Private Sub lstAccounts_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = vbRightButton Then
        UserDocument.PopupMenu mnuAccounts
    End If
End Sub

Private Sub lvwGuarant_Click()

    If Not lvwGuarant.SelectedItem Is Nothing Then
        cmdEditGuarant.Enabled = True
    Else
        cmdEditGuarant.Enabled = False
    End If

End Sub

Private Sub mnuReports_Click(index As Integer)
    Call GetReport(CLng(index), Trim$(lstAccounts.SelectedItem.SubItems(2)))
End Sub

Private Sub SSActiveTabs1_GotFocus()
    On Error GoTo ErrorCode

    'Если это добавление и мы в первый раз зашли на закладку вознаграждения, устанавливаем валюту договора, иначе ничего не трогаем
    If cmbState.ItemData(cmbState.ListIndex) = 2 And blnFixSum And SSActiveTabs1.Tabs(4).Selected And Not blnInitCurrencyBonus Then
        cmbBonusValuta.ListIndex = cmbValuta.ListIndex
        blnInitCurrencyBonus = True
    End If

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "SSActiveTabs1_Click", "ошибка выполнения"
End Sub

Private Sub trvRates_Click()
    'Дизейблим или раздизейблим кнопки для работы со ставками (TreeView)
    Dim objNode As Node, objNodeParent As Node

    If Not trvRates.SelectedItem Is Nothing Then
        Set objNode = trvRates.Nodes(trvRates.SelectedItem.Key)
    
        If TypeName(objNode.Parent) <> "Nothing" Then
            cmdAdd.Enabled = False
            cmdEdit.Enabled = True
            cmdDel.Enabled = True
        Else
            cmdAdd.Enabled = True
            cmdEdit.Enabled = False
            cmdDel.Enabled = False
        End If
        Set objNode = Nothing
    End If

End Sub

Private Sub trvRates_KeyUp(KeyCode As Integer, Shift As Integer)
    trvRates_Click()
End Sub

Private Sub txtDateBegin_LostFocus()

    On Error GoTo ErrorCode

    Dim cnt
    Dim arrRatesFromModel(1, 0) As Variant
    Dim arrRatesFromModelOld
    cnt = 0

    If Not txtDateBegin.IsValid Then
        MsgBox "Значение даты начала (" & txtDateBegin.Text & ") накорректно", vbOKOnly, "Проверка даты начала"
    txtDateBegin.SetFocus
        Exit Sub
    End If

    If (UCase(StrCommand) = "ADD" Or UCase(StrCommand) = "COPY" Or UCase(StrCommand) = "PREPARE") Or (UCase(StrCommand) = "COPY" And IdState = 2) Then

        If IdModel > 0 Then
            SSActiveTabs1.Tabs(3).Enabled = True
            SSActiveTabs1.Tabs(4).Enabled = True
        End If

        '[19608] модифицировать операцию "Регистрация подготовленного договора", добавив анализ установки "Режим учета вознаграждений"
        '   если = "1" то на вкладке ставки для типа ставки "Ставка вознаграждения за выдачу гарантии"
        '   по умолчанию указывать "Дату заключения"
        Dim t_DateRateIssue As Date
        t_DateRateIssue = txtDateBegin.DateValue  ' Дата начала
        If UCase(StrCommand) = "PREPARE" And ReflectComIssue = 1 Then t_DateRateIssue = txtDateOpen.DateValue ' Дата заключения

        For cnt = 0 To UBound(arrRates)
            If IsEmpty(arrRateValues(cnt)) Or IsNull(arrRateValues(cnt)) Then
                arrRatesFromModel(1, 0) = 0
            Else
                arrRatesFromModelOld = arrRateValues(cnt)
                arrRatesFromModel(1, 0) = arrRatesFromModelOld(1, 0)
            End If
            If arrRates(cnt) = "Ставка вознаграждения за выдачу гарантии" Or arrRates(cnt) = "Ставка вознаграждения за пользование гарантией" Then
                arrRatesFromModel(0, 0) = t_DateRateIssue  ' [19608]
            Else
                arrRatesFromModel(0, 0) = txtDateBegin.DateValue  ' Дата начала
            End If
            arrRateValues(cnt) = arrRatesFromModel
        Next
        Call InitTrvRates(True)
    End If

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "txtDateBegin_LostFocus", "ошибка выполнения"
End Sub



Private Property Get UBSChild_Height() As Integer
    'UBSChild_Height = 7515
    UBSChild_Height = UserDocument.MinHeight
End Property

Private Property Get UBSChild_ActualParameter() As Variant

End Property

Private Property Let UBSChild_HeightBrowser(ByVal RHS As Variant)
'If RHS < 7515 Then RHS = 7515
If RHS < UserDocument.MinHeight Then RHS = UserDocument.MinHeight
    
    SSActiveTabs1.Height = RHS - 550
SSActiveTabPanel1.Height = RHS - 550
SSActiveTabPanel2.Height = RHS - 550
SSActiveTabPanel3.Height = RHS - 550
SSActiveTabPanel4.Height = RHS - 550
SSActiveTabPanel5.Height = RHS - 550
SSActiveTabPanel6.Height = RHS - 550

lstAccounts.Height = SSActiveTabs1.Height - 500
lvwGuarant.Height = SSActiveTabs1.Height - 500
ucpParam.Height = SSActiveTabs1.Height - 500

btnSave.Top = SSActiveTabs1.Height + 100
btnExit.Top = SSActiveTabs1.Height + 100
btnReRead.Top = SSActiveTabs1.Height + 100
Info.Top = SSActiveTabs1.Height + 100

End Property

Private Property Get UBSChild_ImageList(Key As String) As Object
    Key = "CARD"
End Property

Private Property Get UBSChild_IsExistParam(ByVal NameParam As String) As Boolean
    UBSChild_IsExistParam = objFormParam.ExistParameter(NameParam)
End Property

Private Sub UBSChild_NotifyCloseWindow(ByVal NumWindow As Integer)

    'Обработка извещения о закрытии окна
    If NumParentWindow <> 0 And NumParentWindow = NumWindow Then bParentWindowClose = True

    If NumWindow = NumChildWinListAccounts Then NumChildWinListAccounts = 0

    If NumWindow = NumChildWinListGuarantOper Then NumChildWinListGuarantOper = 0

    If NumWindow = NumChildWinListAgent Then NumChildWinListAgent = 0

    If NumWindow = NumChildWinListGuarant Then NumChildWinListGuarant = 0

    If NumWindow = NumChildWinModel Then
        NumChildWinModel = 0
        GuarCmdState(True)
    End If

    If NumWindow = NumChildWinPreviousContract Then
        NumChildWinPreviousContract = 0
        'GuarCmdState (True)
    End If

    If NumWindow = NumChildWinFrContract Then
        NumChildWinFrContract = 0
        GuarCmdState(True)
    End If

    If NumWindow = NumChildWinPrincipal Then
        NumChildWinPrincipal = 0
        GuarCmdState(True)
    End If

    If NumWindow = NumChildWinBeneficiar Then
        NumChildWinBeneficiar = 0
        GuarCmdState(True)
    End If

    If NumWindow = NumChildWinGarant Then
        NumChildWinGarant = 0
        GuarCmdState(True)
    End If

End Sub

Private Sub UBSChild_NotifyFixWindow(ByVal NumWindow As Variant, ByVal FixState As Boolean)
    If NumWindow = NumWin And FixState Then
        'Если пришпиливают наше окно
        NumParentWindow = 0
    End If
End Sub

Private Property Let UBSChild_NumWindow(ByVal RHS As Integer)
    NumWin = RHS
End Property

Private Property Let UBSChild_ParamInfo(ByVal NameParam As String, ByVal RHS As Variant)
Dim ItemArray As Variant
Dim q As Integer

On Error GoTo ErrorCode

If Not objFormParam.ExistParameter(NameParam) Then
objErr.UbsErrRaise "Проверка поддержки параметров", "Параметер '" & NameParam & "' не поддерживается"
    End If

LoadParam = NameParam

Select Case NameParam

Case "InitParamForm"
Call Initialize
NumParentWindow = RHS(0)
ItemArray = RHS(1)
StrCommand = UCase(RHS(2))
IdContract = 0
blnSecure = True
dDate2222 = DateSerial(2222, 1, 1)
IssueEndDate = dDate2222

If StrCommand = "EDIT" Or StrCommand = "COPY" Then
If Not IsArray(ItemArray) Then
MsgBox "Не выбран договор!", vbCritical, m_strCaptionForm

                        If CheckParamForClose(NameParam) Then
Call btnExit_Click
Exit Property
End If
End If
If StrCommand = "EDIT" Then
IdContract = ItemArray(0)
Else
IdContractCopy = ItemArray(0)
End If

If IdContract = 0 And IdContractCopy = 0 Then

MsgBox "Не выбран договор!", vbCritical, m_strCaptionForm

                    If CheckParamForClose(NameParam) Then
Call btnExit_Click
Exit Property
End If
End If
ElseIf StrCommand = "ADD_BY_FRAME_CONTRACT" Then

If IsArray(ItemArray) Then
IdFrameContract = ItemArray(0)
Else
IdFrameContract = 0
End If

If IdFrameContract = 0 Then
MsgBox "Не выбран рамочный договор!", vbCritical, m_strCaptionForm

                    If CheckParamForClose(NameParam) Then
btnExit_Click
Exit Property
End If
End If

StrCommand = "ADD"

ElseIf StrCommand = "ADD_BY_FRAME_PREPARE" Then

If IsArray(ItemArray) Then
IdFrameContract = ItemArray(0)
Else
IdFrameContract = 0
End If

If IdFrameContract = 0 Then
MsgBox "Не выбран рамочный договор!", vbCritical, m_strCaptionForm

                    If CheckParamForClose(NameParam) Then
btnExit_Click
Exit Property
End If
End If

StrCommand = "PREPARE"
End If

InitDoc

Parent.WindowDraw(NumWin) = True

objInterfaces.NextCtrl
            'objInterfaces.PrevCtrl

Case "SetFocus"
If Not objFocusCtrl Is Nothing Then
If objFocusCtrl.Visible And objFocusCtrl.Enabled Then
'DoEvents
objFocusCtrl.SetFocus
End If
End If

Case "LostFocus"
If Not UserDocument.ActiveControl Is Nothing Then
Set objFocusCtrl = UserDocument.ActiveControl
            End If

        '=========================================================================
        'RetFromGrid - возврат из списков, вызываемых кнопкой "..."
Case "RetFromGrid"

If NumChildWinListAccounts = CInt(RHS(0)) _
                Or NumChildWinListGuarant = CInt(RHS(0)) _
                Or NumChildWinListGuarantOper = CInt(RHS(0)) _
                Or NumChildWinModel = CInt(RHS(0)) _
                Or NumChildWinFrContract = CInt(RHS(0)) _
                Or NumChildWinPrincipal = CInt(RHS(0)) _
                Or NumChildWinBeneficiar = CInt(RHS(0)) _
                Or NumChildWinGarant = CInt(RHS(0)) _
                Or NumChildWinPreviousContract = CInt(RHS(0)) _
                Or NumChildWinListAgent = CInt(RHS(0)) _
            Then

Select Case RHS(0)

Case NumChildWinPreviousContract
If Not IsArray(RHS(1)) Then
MsgBox "Не выбран прежний договор!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinPreviousContract
                            NumChildWinPreviousContract = 0
Parent.SetFocusToWindow NumWin
                            DoEvents
btnPreviousContract.SetFocus
Exit Property
End If
IdPrevContract = RHS(1)(0)

objParamOut.ClearParameters
objParamIn.ClearParameters

objParamIn.Parameter("IdPrevContract") = IdPrevContract
Call oleUbsChannel.Run("BGReadPreviuosContract", objParamIn, objParamOut)
txtPreviousContract.Text = objParamOut.Parameter("InfoPrevContract")

Parent.CloseWindow NumChildWinPreviousContract
                        NumChildWinPreviousContract = 0
Parent.SetFocusToWindow NumWin
                        DoEvents


If SSActiveTabs1.Tabs(2).Enabled Then
Set objFocusCtrl = cmbPortfolio
                            SSActiveTabs1.SelectedTab = 2
objInterfaces.GoToCtrl cmbPortfolio
                        Else
Set objFocusCtrl = lstAccounts
                            SSActiveTabs1.SelectedTab = 3
objInterfaces.GoToCtrl lstAccounts
                        End If

Case NumChildWinModel

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран типовой договор!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinModel
                            NumChildWinModel = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

btnModel.SetFocus
Exit Property
End If

IdModel = RHS(1)(0)

objParamOut.ClearParameters
objParamIn.ClearParameters

objParamIn.Parameter("ID") = IdModel
Call oleUbsChannel.Run("BGReadModelById", objParamIn, objParamOut)
arrPeriodPay = objParamOut.Parameter("Срок погашения оплаченной суммы")

If IsArray(arrPeriodPay) Then
Dim cnt As Integer
Dim arrRatesFromModel(1, 0) As Variant
If IsArray(arrRateValues) Then
If UBound(arrRateValues) <> UBound(arrRates) Then
ReDim Preserve arrRateValues(UBound(arrRates)) As Variant
                                End If
Else
ReDim arrRateValues(UBound(arrRates)) As Variant
                            End If

' для всех типов, кроме "Ставка вознаграждения за выдачу гарантии"
arrRatesFromModel(0, 0) = txtDateBegin.DateValue 'Date

For cnt = 0 To UBound(arrRates)
Select Case arrRates(cnt)
Case "Ставка % по оплаченной гарантии"
arrRatesFromModel(1, 0) = arrPeriodPay(2, 0)
arrRateValues(cnt) = arrRatesFromModel
Case "Ставка % по просроченной оплате гарантии"
arrRatesFromModel(1, 0) = arrPeriodPay(3, 0)
arrRateValues(cnt) = arrRatesFromModel
Case "Ставка пени за просрочку погашения процентов по оплаченной гарантии", "Ставка пени за просрочку погашения оплаченной гарантии"
arrRatesFromModel(1, 0) = arrPeriodPay(4, 0)
arrRateValues(cnt) = arrRatesFromModel
Case "Ставка вознаграждения за пользование гарантией"
arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения"))
arrRateValues(cnt) = arrRatesFromModel
Case "Ставка вознаграждения (гарант)"
arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения (гарант)"))
arrRateValues(cnt) = arrRatesFromModel
Case "Ставка вознаграждения за выдачу гарантии"
arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения за выдачу"))
arrRateValues(cnt) = arrRatesFromModel
End Select
Next

' [19608] Выбор типового --------------
' определяем Дату ставки для типа "Ставка вознаграждения за выдачу гарантии"
Dim t_DateRateIssue As Date
t_DateRateIssue = txtDateBegin.DateValue  ' Дата начала
If UCase(StrCommand) = "PREPARE" And ReflectComIssue = 1 Then t_DateRateIssue = txtDateOpen.DateValue ' Дата заключения
                            
                            For cnt = 0 To UBound(arrRates)
If arrRates(cnt) = "Ставка вознаграждения за выдачу гарантии" Then
arrRatesFromModel(0, 0) = t_DateRateIssue  '[19608] подменяем
'MsgBox "Выбор типового /подмена/: " & arrRatesFromModel(0, 0)
arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения за выдачу"))
arrRateValues(cnt) = arrRatesFromModel
End If
If arrRates(cnt) = "Ставка вознаграждения за пользование гарантией" Then
arrRatesFromModel(0, 0) = t_DateRateIssue  '[19608] подменяем
'MsgBox "Выбор типового /подмена/: " & arrRatesFromModel(0, 0)
arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения"))
arrRateValues(cnt) = arrRatesFromModel
End If
Next
' [19608] Выбор типового --------------

Call InitTrvRates(True)
End If

ucpParam.PropertyByName("Очередность платежей") = objParamOut.Parameter("Очередность платежей")
ucpParam.PropertyByName("Досрочное гашение в групповом режиме") = objParamOut.Parameter("Досрочное гашение в групповом режиме")
ucpParam.PropertyByName("Параметры расчета графиков") = objParamOut.Parameter("Параметры расчета графиков")
ucpParam.PropertyByName("Сумма платежа") = objParamOut.Parameter("Сумма платежа")
ucpParam.PropertyByName("Алгоритм расчета процентов") = objParamOut.Parameter("Алгоритм расчета процентов")
ucpParam.PropertyByName("Льготный период") = objParamOut.Parameter("Льготный период")
ucpParam.PropertyByName("Режим смещения выходных дней") = objParamOut.Parameter("Режим смещения выходных дней")
ucpParam.PropertyByName("Алгоритм расчета суммы платежа") = objParamOut.Parameter("Алгоритм расчета суммы платежа")
ucpParam.PropertyByName("Исключить неполный первый период") = objParamOut.Parameter("Исключить неполный первый период")
ucpParam.PropertyByName("Отсрочка") = objParamOut.Parameter("Отсрочка")

blnFixSum = CBool(objParamOut.Parameter("Тип вознаграждения") = "Фиксированная сумма")
txtModel.Text = objParamOut.Parameter("Наименование")
sModelType = objParamOut.Parameter("Идентификатор шаблона")
strOrderPayFeeGuarant = objParamOut.Parameter("Порядок уплаты вознаграждения (гарант)")

If (strOrderPayFeeGuarant <> "") Then
frmPayFeeGuarant.Visible = True
If (strOrderPayFeeGuarant = "Периодически") Then
dDateNextPayFeeGuarant.Visible = True
cmdPeriodPayFeeGuarant.Visible = True
lblDateNextPayFeeGuarant.Visible = True
End If
Else
frmPayFeeGuarant.Visible = False
End If

If Not IsArray(objParamOut.Parameter("Порядок уплаты вознаграждения (список)")) Then
MsgBox "Параметр 'Порядок уплаты вознаграждения (список)' пуст!", vbCritical, "Договор гарантии"
                            If CheckParamForClose(LoadParam) Then
btnExit_Click
Exit Property
End If
End If

arrPayOrder = objParamOut.Parameter("Порядок уплаты вознаграждения (список)")
Call FillComboText(cmbOrderPayFee, arrPayOrder)
Call SetComboValueText(cmbOrderPayFee, CStr(objParamOut.Parameter("Порядок уплаты вознаграждения")))

Call FillComboText(cmbOrderPayFeeBonus, arrPayOrder)
Call SetComboValueText(cmbOrderPayFeeBonus, CStr(objParamOut.Parameter("Порядок уплаты вознаграждения за выдачу")))

'    If objParamOut.Parameter("Порядок уплаты вознаграждения за выдачу") <> "Периодически" Then dDateNextPayFeeBonus.DateValue = DateSerial(2222, 1, 1)
'   If objParamOut.Parameter("Порядок уплаты вознаграждения") <> "Периодически" Then dDateNextPayFee.DateValue = DateSerial(2222, 1, 1)

'Вознаграждение (гарант)
If (strOrderPayFeeGuarant <> "") Then
Call FillComboText(cmbOrderPayFeeGuarant, arrPayOrder)
Call SetComboValueText(cmbOrderPayFeeGuarant, strOrderPayFeeGuarant)
End If

If Not IsArray(objParamOut.Parameter("Тип вознаграждения (список)")) Then
MsgBox "Параметр 'Тип вознаграждения (список)' пуст!", vbCritical, "Договор гарантии"
                            If CheckParamForClose(LoadParam) Then
btnExit_Click
Exit Property
End If
End If

arrTypeBonus = objParamOut.Parameter("Тип вознаграждения (список)")
Call FillComboText(cmbTypePayFee, arrTypeBonus)
Call SetComboValueText(cmbTypePayFee, CStr(objParamOut.Parameter("Тип вознаграждения")))
Call SetBonusCtrlsState

Call FillComboText(cmbTypePayFeeBonus, arrTypeBonus)
Call SetComboValueText(cmbTypePayFeeBonus, CStr(objParamOut.Parameter("Тип вознаграждения за выдачу")))
Call SetBonusCtrlsBonusState

'Вознаграждение (гарант)
If (strOrderPayFeeGuarant <> "") Then
Call FillComboText(cmbTypePayFeeGuarant, arrTypeBonus)
Call SetComboValueText(cmbTypePayFeeGuarant, CStr(objParamOut.Parameter("Тип вознаграждения (гарант)")))
End If

If txtDateBegin.DateValue <> #1/1/2222# Then
SSActiveTabs1.Tabs(3).Enabled = True
SSActiveTabs1.Tabs(4).Enabled = True
End If

objParamIn.ClearParameters
objParamOut.ClearParameters
objParamIn.Parameter("Идентификатор типового договора") = IdModel
objParamIn.Parameter("Порядок уплаты вознаграждения") = cmbOrderPayFee.Text
objParamIn.Parameter("Порядок уплаты вознаграждения за выдачу") = cmbOrderPayFeeBonus.Text
Call oleUbsChannel.Run("BG_Contract_Init_Ucp", objParamIn, objParamOut)

If sModelType = "UBS_GUARANT" Then
If IdState = 4 Then
btnGarant.Enabled = True
If cmbTypePayFee.Text = "Процент суммы гарантии" Then
cmbBonusValuta.ListIndex = cmbValuta.ListIndex
cmbBonusValuta.Enabled = False
Else
cmbBonusValuta.Enabled = True
End If

If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
cmbBonusValutaBonus.Enabled = False
Else
cmbBonusValutaBonus.Enabled = True
End If
Else
btnGarant.Enabled = False
End If
IdGarant = 0
txtGarant.Text = ""
Else 'sModelType = "UBS_COUNTER_GUARANT"
btnGarant.Enabled = True
End If

Parent.CloseWindow NumChildWinModel
                        NumChildWinModel = 0
Parent.SetFocusToWindow NumWin
                        DoEvents

If StrCommand = "ADD" Or UCase(StrCommand) = "PREPARE" Then
Set objFocusCtrl = kindComboBox
                        End If

ucpParam.UbsAddFields = objStub
ucpParam.Refresh


Case NumChildWinFrContract

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран рамочный договор!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinFrContract
                            NumChildWinFrContract = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

Set objFocusCtrl = btnFrameContract
                            Exit Property
End If

IdFrameContract = RHS(1)(0)

objParamOut.ClearParameters
objParamIn.ClearParameters

objParamIn.Parameter("ID") = IdFrameContract
Call oleUbsChannel.Run("BGReadFrameContractById", objParamIn, objParamOut)
txtFrameContract.Text = objParamOut.Parameter("Наименование")
dFrameContractDateBegin = CDate(objParamOut.Parameter("Дата начала действия рамочного договора"))
dFrameContractDateEnd = CDate(objParamOut.Parameter("Дата окончания действия рамочного договора"))
FrameContractTerms = objParamOut.Parameter("Срок гарантии рамочного договора")
FrameContractLimitSaldo = objParamOut.Parameter("Остаток лимита")
IssueEndDate = CDate(objParamOut.Parameter("Дата окончания выдачи"))
FrameContractDivision = CInt(objParamOut.Parameter("Номер отделения"))
SetInfoByFrameContract

Parent.CloseWindow NumChildWinFrContract
                        NumChildWinFrContract = 0
Parent.SetFocusToWindow NumWin
                        DoEvents

Set objFocusCtrl = btnModel
                    
                    Case NumChildWinPrincipal

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран клиент-принципал!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinPrincipal
                            NumChildWinPrincipal = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

Set objFocusCtrl = btnPrincipal
                            Exit Property
End If

IdPrincipal = RHS(1)(0)

objParamOut.ClearParameters
objParamIn.ClearParameters

objParamIn.Parameter("ID") = IdPrincipal
Call oleUbsChannel.Run("BGReadClientById", objParamIn, objParamOut)
txtPrincipal.Text = objParamOut.Parameter("Наименование")

Parent.CloseWindow NumChildWinPrincipal
                        NumChildWinPrincipal = 0
Parent.SetFocusToWindow NumWin
                        DoEvents
Set objFocusCtrl = btnBeneficiar
                            
                    Case NumChildWinBeneficiar

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран клиент-бенефициар!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinBeneficiar
                            NumChildWinBeneficiar = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

Set objFocusCtrl = btnBeneficiar
                            Exit Property
End If

IdBeneficiar = RHS(1)(0)
arrDetailsBeneficiar = Empty

objParamOut.ClearParameters
objParamIn.ClearParameters

objParamIn.Parameter("ID") = IdBeneficiar
Call oleUbsChannel.Run("BGReadClientById", objParamIn, objParamOut)
txtBeneficiar.Text = objParamOut.Parameter("Наименование")

Parent.CloseWindow NumChildWinBeneficiar
                        NumChildWinBeneficiar = 0
Parent.SetFocusToWindow NumWin
                        DoEvents
If btnGarant.Enabled Then Set objFocusCtrl = btnGarant Else Set objFocusCtrl = txtNumber
                            
                    Case NumChildWinGarant

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран клиент-гарант!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinGarant
                            NumChildWinGarant = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

Set objFocusCtrl = btnGarant
                            Exit Property
End If

IdGarant = RHS(1)(0)

objParamOut.ClearParameters
objParamIn.ClearParameters

objParamIn.Parameter("ID") = IdGarant
Call oleUbsChannel.Run("BGReadClientById", objParamIn, objParamOut)
txtGarant.Text = objParamOut.Parameter("Наименование")

Parent.CloseWindow NumChildWinGarant
                        NumChildWinGarant = 0
Parent.SetFocusToWindow NumWin
                        DoEvents
Set objFocusCtrl = txtNumber
                        
                    Case NumChildWinListAccounts

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран счёт!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinListAccounts
                            NumChildWinListAccounts = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

Set objFocusCtrl = lstAccounts
                            Exit Property
End If

objParamIn.ClearParameters
objParamOut.ClearParameters
objParamIn.Parameter("ID") = CLng(RHS(1)(0))
objParamIn.Parameter("Раздел") = strSection

Call oleUbsChannel.Run("BGReadAccountInfoById", objParamIn, objParamOut)

'Добавление счета в массив счетов и lstAccounts
objParamOut.Parameter("Раздел") = objParamIn.Parameter("Раздел")
Call AddAccount(objParamOut)

Call Parent.CloseWindow(NumChildWinListAccounts)
NumChildWinListAccounts = 0

Call Parent.SetFocusToWindow(NumWin)

DoEvents

lstAccounts.SetFocus

Case NumChildWinListGuarantOper

Parent.CloseWindow NumChildWinListGuarantOper
                        NumChildWinListGuarantOper = 0

Parent.SetFocusToWindow NumWin

                        DoEvents

Call GuarCmdState(True)

Call ReReadGuarCntracts

SSActiveTabs1.SelectedTab = 5
Set objFocusCtrl = lvwGuarant
                        
                        blnGuarWinOpened = False

Case NumChildWinListGuarant


If Not IsArray(RHS(1)) Then
MsgBox "Не выбран договор обеспечения!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinListAccounts
                            NumChildWinListAccounts = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

SSActiveTabs1.SelectedTab = 5
Set objFocusCtrl = cmdInclude
                            
                            Exit Property
End If

objParamIn.ClearParameters
objParamOut.ClearParameters

objParamIn.Parameter("GuarIDs") = RHS(1)
objParamIn.Parameter("BGId") = IdContract

oleUbsChannel.Run "BG_AddGuarantContract", objParamIn, objParamOut

                        If objParamOut.Parameter("Код ошибки") <> 0 Then
                            MsgBox objParamOut.Parameter("Текст ошибки"), vbCritical, m_strCaptionForm
                            EnableControls
Exit Property
End If

Call GuarCmdState(True)

Call ReReadGuarCntracts

Parent.CloseWindow NumChildWinListGuarant
                        NumChildWinListAccounts = 0

Parent.SetFocusToWindow NumWin

                        DoEvents

SSActiveTabs1.SelectedTab = 5
cmdListGuarantOperDog.SetFocus


Case NumChildWinListAgent  ' [14617]

If Not IsArray(RHS(1)) Then
MsgBox "Не выбран договор с агентом!", vbCritical, m_strCaptionForm

                            Parent.CloseWindow NumChildWinListAgent
                            NumChildWinListAgent = 0
Parent.SetFocusToWindow NumWin
                            DoEvents

SSActiveTabs1.SelectedTab = 1
Set objFocusCtrl = btnAgent
                            
                            Exit Property
End If

IdAgent = RHS(1)(0)

Dim DatePayment As Date
objParamIn.ClearParameters
objParamOut.ClearParameters

objParamIn.Parameter("DateBegin") = txtDateOpen.DateValue
objParamIn.Parameter("IdAgent") = IdAgent

oleUbsChannel.Run "GetDatePayment", objParamIn, objParamOut
                        DateReward.Text = objParamOut.Parameter("DatePayment")

If UCase(StrCommand) = "EDIT" Then
oleUbsChannel.Run "AgentRewardAvaliable", objParamIn, objParamOut
                            DateReward.Enabled = objParamOut.Parameter("Avaliable")
CostAmount.Enabled = objParamOut.Parameter("Avaliable")
Else
DateReward.Enabled = True
CostAmount.Enabled = True
End If



objParamOut.ClearParameters : objParamIn.ClearParameters

objParamIn.Parameter("ID") = IdAgent  ' ЗДЕСЬ ЛЕЖИТ ДОГОВОР С АГЕНТОМ - ID_AG_CONTRACT
Call oleUbsChannel.Run("BGReadAgContr", objParamIn, objParamOut)
Dim idAgClient : idAgClient = objParamOut.Parameter("Ид клиента")
Dim numAg : numAg = objParamOut.Parameter("Номер договора агента")
Dim dateAg : dateAg = objParamOut.Parameter("Дата договора агента")
txtNumAgC.Text = numAg
txtDateAgC.Text = dateAg

objParamIn.Parameter("ID") = idAgClient
Call oleUbsChannel.Run("BGReadClientById", objParamIn, objParamOut)
txtAgent.Text = objParamOut.Parameter("Наименование")

Parent.CloseWindow NumChildWinListAgent
                        NumChildWinListAgent = 0
Parent.SetFocusToWindow NumWin
                        DoEvents

SSActiveTabs1.SelectedTab = 1
btnAgent.SetFocus

End Select
End If
End Select


Exit Property
ErrorCode:
objErr.UbsErrMsg "UBSChild_ParamInfo (LET)", "ошибка выполнения"
    If CheckParamForClose(NameParam) Then
btnExit_Click
End If

End Property

Private Sub SetInfoByFrameContract()
    IdPrincipal = CLng(objParamOut.Parameter("Идентификатор клиента-принципала"))
    txtPrincipal.Text = CStr(objParamOut.Parameter("Принципал"))
    btnPrincipal.Enabled = False

    If IsArray(FrameContractTerms) Then
        SetKindComboBoxByFrame()
    Else
        ResetKindComboBox()
    End If

    SSActiveTabs1.Tabs(2).Enabled = False

    IdValuta = CLng(objParamOut.Parameter("Идентификатор валюты рамочного договора"))
    If IdState = 4 Then
        If cmbTypePayFee.Text = "Процент суммы гарантии" Then
            cmbBonusValuta.ListIndex = cmbValuta.ListIndex
            cmbBonusValuta.Enabled = False
        Else
            cmbBonusValuta.Enabled = True
        End If

        If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
            cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
            cmbBonusValutaBonus.Enabled = False
        Else
            cmbBonusValutaBonus.Enabled = True
        End If
        kindComboBox.Enabled = True

        If FrameContractDivision > 0 Then
            SetComboText cmbNumberDiv, FrameContractDivision
        End If
    ElseIf IdState = 2 And UCase(StrCommand) = "EDIT" Then
        kindComboBox.Enabled = True
    Else
        kindComboBox.Enabled = False
    End If
    cmbValuta.Enabled = cmbValutaEnabled()

    Dim q
    If cmbValuta.ListCount > 0 Then
        For q = 0 To cmbValuta.ListCount - 1

            If cmbValuta.ItemData(q) = IdValuta Then
                cmbValuta.ListIndex = q
                Exit For
            End If

        Next
    End If

End Sub

Private Property Get UBSChild_ParamInfo(ByVal NameParam As String) As Variant
If NameParam = "WaitShow" Then
UBSChild_ParamInfo = True
End If
End Property

Private Property Let UBSChild_Parrent(ByVal RHS As Object)
    Set Parent = RHS
End Property

Private Property Let UBSChild_RunParameter(ByVal RHS As String)

End Property


Private Property Get UBSChild_Sizable() As Boolean
    UBSChild_Sizable = False
End Property

Private Property Get UBSChild_TitleWindow() As String
    UBSChild_TitleWindow = "Договор гарантии"
End Property

Private Property Get UBSChild_Width() As Integer
    'UBSChild_Width = 7845
    UBSChild_Width = UserDocument.MinWidth
End Property

Private Property Let UBSChild_WidthBrowser(ByVal RHS As Variant)
'If RHS < 7845 Then RHS = 7845
If RHS < UserDocument.MinWidth Then RHS = UserDocument.MinWidth
    
    SSActiveTabs1.Width = RHS - 100
SSActiveTabPanel1.Width = RHS - 100
SSActiveTabPanel2.Width = RHS - 100
SSActiveTabPanel3.Width = RHS - 100
SSActiveTabPanel4.Width = RHS - 100
SSActiveTabPanel5.Width = RHS - 100
SSActiveTabPanel6.Width = RHS - 100

'lstAccounts.Height = SSActiveTabs1.Width - 400
'lvwGuarant.Height = SSActiveTabs1.Height - 400
'ucpParam.Height = SSActiveTabs1.Height - 400

btnSave.Left = SSActiveTabs1.Width - 2640
btnExit.Left = SSActiveTabs1.Width - 1320

End Property




Private Sub ucpParam_KeyPress(ByVal nKeyCode As Integer)
    Dim blnMoveFlag As Boolean
    On Error GoTo TryToCorrectError_
    Select Case nKeyCode
        Case 13                              'Enter
            blnMoveFlag = True
            nKeyCode = 0
            'MsgBox ucpParam.PropertyCurrentIndex & " " & ucpParam.PropertyCount - 2
            If ucpParam.PropertyCurrentIndex >= ucpParam.PropertyCount - 2 Then
                If btnSave.Enabled Then
                    objInterfaces.GoToCtrl btnSave
                Else
                    objInterfaces.GoToCtrl btnExit
                End If
            End If
        Case 27                              'Esc
            blnMoveFlag = False
            nKeyCode = 0
            ' objInterfaces.PrevCtrl        'SendKeys "+{TAB}"
            If ucpParam.PropertyCurrentIndex = 0 Then
                If SSActiveTabs1.Tabs(5).Enabled Then
                    SSActiveTabs1.SelectedTab = 5
                    lvwGuarant.SetFocus
                ElseIf SSActiveTabs1.Tabs(4).Enabled Then
                    SSActiveTabs1.SelectedTab = 4
                    objInterfaces.GoToCtrl trvRates
                ElseIf SSActiveTabs1.Tabs(2).Enabled Then
                    SSActiveTabs1.SelectedTab = 2
                    '                    objInterfaces.GoToCtrl cmbRiskReason
                    objInterfaces.GoToCtrl cmbTypeValidationRisk

                End If
            End If
    End Select
    Exit Sub

TryToCorrectError_:
    Err.Clear
    If blnMoveFlag Then
        objInterfaces.NextCtrl
    Else
        objInterfaces.PrevCtrl
    End If
    Resume Next

End Sub

Private Sub ucpParam_TextChange()
    On Error GoTo Error_
    blnAddFlChanged = True
    Exit Sub
Error_:
    objErr.UbsErrMsg "ucpParam_TextChange", "ошибка выполнения"
End Sub

Private Sub UserDocument_Hide()
    On Error GoTo ErrorCode

    arrGuarant = Empty

    objStub.ReleaseUbsChannel
    Set objErr = Nothing
    Set objUbsCheck = Nothing
    Set objInterfaces = Nothing
    Set objFormParam = Nothing
    Set objFocusCtrl = Nothing
    Set objParamIn = Nothing
    Set objParamOut = Nothing
    Set objStub = Nothing
    Set objFormat = Nothing
    Set objInputBox = Nothing
    Set objWait = Nothing
    
    If Not bParentWindowClose And Parent.IsExistParam(NumParentWindow, "NeedRefreshGrid") Then
        Parent.ParamInfo(NumParentWindow, "NeedRefreshGrid") = bNeedRefreshGrid
    End If

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "UserDocument_Hide", "ошибка выполнения"
End Sub

Private Sub UserDocument_Initialize()
    On Error GoTo Error_

    m_strCaptionForm = "Договор предоставления банковских гарантий"
        
    Set objErr = CreateObject("LibErr.IUbsError")  'ToolPubs.
    Set objUbsCheck = CreateObject("UbsCheck.UbsCheckAction")
    Set objParamIn = CreateObject("ToolPubs.IUbsParam")
    Set objParamOut = CreateObject("ToolPubs.IUbsParam")
    Set objFormParam = CreateObject("ToolPubs.IUbsParam")
    Set objStub = CreateObject("UbsAddFiledsStub.IUbsAddFiledsStub")
    Set objFormat = CreateObject("Lib3.IUbsFormat")
    
    ' МАССИВ ПОДДЕРЖИВАЕМЫХ ПАРАМЕТРОВ
    objFormParam.Parameter("WaitShow") = True
    objFormParam.Parameter("InitParamForm") = True
    objFormParam.Parameter("SetFocus") = True
    objFormParam.Parameter("LostFocus") = True
    objFormParam.Parameter("RetFromGrid") = True

    Exit Sub

Error_:
    objErr.UbsErrMsg "UserDocument_Initialize", "ошибка инициализации"
End Sub

Private Sub UserDocument_KeyPress(KeyAscii As Integer)
    Dim blnMoveFlag As Boolean
    On Error GoTo TryToCorrectError_

    Select Case (KeyAscii)
        Case 13                              'Enter
            blnMoveFlag = True
            KeyAscii = 0

            Select Case (UserDocument.ActiveControl.Name)
                Case "btnPreviousContract"
                    objInterfaces.GoToCtrl btnPreviousContract
                Case "cmbWarrant"
                    If SSActiveTabs1.Tabs(2).Enabled Then
                        SSActiveTabs1.SelectedTab = 2
                        objInterfaces.GoToCtrl cmbPortfolio
                    Else
                        SSActiveTabs1.SelectedTab = 3
                        objInterfaces.GoToCtrl lstAccounts
                    End If
                Case "cmbTypeValidationRisk"
                    SSActiveTabs1.SelectedTab = 3
                    objInterfaces.GoToCtrl lstAccounts
                Case "lstAccounts"
                    SSActiveTabs1.SelectedTab = 4
                    objInterfaces.GoToCtrl trvRates
'                Case "cmbRiskReason"
 '                   SSActiveTabs1.SelectedTab = 3
  '                  objInterfaces.GoToCtrl lstAccounts
                Case "cmdPeriodPayFee"
                    If SSActiveTabs1.Tabs(5).Enabled Then
                        SSActiveTabs1.SelectedTab = 5
                        objInterfaces.GoToCtrl lvwGuarant
                    Else
                        SSActiveTabs1.SelectedTab = 6
                        objInterfaces.GoToCtrl ucpParam
                    End If
                Case "cmdListGuarantOperDog"
                    SSActiveTabs1.SelectedTab = 6
                    objInterfaces.GoToCtrl ucpParam
                Case "cmbTypePayFeeBonus"
                    If cmbBonusValutaBonus.Enabled Then
                        objInterfaces.GoToCtrl cmbBonusValutaBonus
                    Else
                        If SSActiveTabs1.Tabs(5).Enabled Then
                            SSActiveTabs1.SelectedTab = 5
                            objInterfaces.GoToCtrl lvwGuarant
                        Else
                            SSActiveTabs1.SelectedTab = 6
                            objInterfaces.GoToCtrl ucpParam
                        End If
                    End If
                Case "cmbBonusValutaBonus"
                    SSActiveTabs1.SelectedTab = 5
                    If SSActiveTabs1.Tabs(5).Enabled Then
                        SSActiveTabs1.SelectedTab = 5
                        objInterfaces.GoToCtrl lvwGuarant
                        Else
                        SSActiveTabs1.SelectedTab = 6
                        objInterfaces.GoToCtrl ucpParam
                        End If
                Case "ucpParam"
                    objInterfaces.GoToCtrl btnSave
                Case "txtNextDatePayFee"
                    If cmdPeriodPayFee.Enabled Then
                        objInterfaces.GoToCtrl cmdPeriodPayFee
                    Else
                        If SSActiveTabs1.Tabs(5).Enabled Then
                            SSActiveTabs1.SelectedTab = 5
                            objInterfaces.GoToCtrl lvwGuarant
                        Else
                            SSActiveTabs1.SelectedTab = 6
                            objInterfaces.GoToCtrl ucpParam
                        End If
                    End If
                Case "lvwGuarant"
                    SSActiveTabs1.SelectedTab = 6
                    objInterfaces.GoToCtrl ucpParam

                Case Else
                    objInterfaces.NextCtrl
            End Select

        Case 27                              'Esc
            blnMoveFlag = False
            KeyAscii = 0

            Select Case (UserDocument.ActiveControl.Name)
                Case "btnReRead"
                    objInterfaces.GoToCtrl btnExit
                Case "ucpParam"
                    If SSActiveTabs1.Tabs(5).Enabled Then
                        SSActiveTabs1.SelectedTab = 5
                        lvwGuarant.SetFocus
                    ElseIf SSActiveTabs1.Tabs(4).Enabled Then
                        SSActiveTabs1.SelectedTab = 4
                        objInterfaces.GoToCtrl trvRates
                    ElseIf SSActiveTabs1.Tabs(2).Enabled Then
                        SSActiveTabs1.SelectedTab = 2
                        'objInterfaces.GoToCtrl cmbRiskReason
                        objInterfaces.GoToCtrl cmbTypeValidationRisk
                    Else
                        SSActiveTabs1.SelectedTab = 1
                        objInterfaces.GoToCtrl cmbWarrant
                    End If
                Case "lvwGuarant"
                    SSActiveTabs1.SelectedTab = 4
                    objInterfaces.GoToCtrl cmbBonusValutaBonus
                Case "trvRates"
                    SSActiveTabs1.SelectedTab = 3
                    objInterfaces.GoToCtrl lstAccounts
                Case "lstAccounts"
                    If SSActiveTabs1.Tabs(2).Enabled Then
                        SSActiveTabs1.SelectedTab = 2
                        objInterfaces.GoToCtrl cmbTypeValidationRisk
                    Else
                        SSActiveTabs1.SelectedTab = 1
                        objInterfaces.GoToCtrl cmbWarrant
                    End If
                Case "cmbPortfolio"
                    SSActiveTabs1.SelectedTab = 1
                    objInterfaces.GoToCtrl cmbWarrant
                Case "txtModel"
                    objInterfaces.GoToCtrl btnExit
                Case Else
                    objInterfaces.PrevCtrl
            End Select
    End Select

    Exit Sub

TryToCorrectError_:
    Err.Clear
    If blnMoveFlag Then
        objInterfaces.NextCtrl
    Else
        objInterfaces.PrevCtrl
    End If
    Resume Next

End Sub

Private Function Check() As Boolean
    Dim datDate As Date
    Dim curSumm As Currency

    Check = False

    If Len(txtModel.Text) < 1 Then
        MsgBox "Необходимо выбрать типовой договор.", vbExclamation, "Ошибка ввода параметров"

        Call EnableControls()
        SSActiveTabs1.SelectedTab = 1
        btnModel.SetFocus
        Exit Function
    End If

    If Len(txtPrincipal.Text) < 1 Then
        MsgBox "Необходимо выбрать принципала.", vbExclamation, "Ошибка ввода параметров"

        Call EnableControls()
        SSActiveTabs1.SelectedTab = 1
        btnPrincipal.SetFocus
        Exit Function
    End If

    If Len(txtBeneficiar.Text) < 1 Then
        MsgBox "Необходимо выбрать бенефициара.", vbExclamation, "Ошибка ввода параметров"

        Call EnableControls()
        SSActiveTabs1.SelectedTab = 1
        btnBeneficiar.SetFocus
        Exit Function
    End If

    If Len(txtNumber.Text) < 1 Then
        MsgBox "Необходимо ввести номер договора.", vbExclamation, "Ошибка ввода параметров"

        Call EnableControls()
        SSActiveTabs1.SelectedTab = 1
        txtNumber.SetFocus
        Exit Function
    End If


    If txtDateOpen.Enabled Then
        datDate = txtDateOpen.DateValue
        If datDate <= dDate1990 Or datDate >= dDate2222 Then
            MsgBox "Необходимо указать дату заключения договора.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 1
            txtDateOpen.SetFocus
            Exit Function
        End If
    End If
    If txtDateBegin.Enabled Then
        datDate = txtDateBegin.DateValue
        If datDate < txtDateOpen.DateValue Or datDate >= dDate2222 Then
            MsgBox "Дата начала договора должна быть не ранее даты заключения.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 1
            txtDateBegin.SetFocus
            Exit Function
        End If
    End If
    If txtDateEnd.Enabled Then
        datDate = txtDateEnd.DateValue
        If datDate <= txtDateBegin.DateValue Or datDate >= dDate2222 Then
            MsgBox "Дата окончания договора должна быть больше даты начала договора.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 1
            txtDateEnd.SetFocus
            Exit Function
        End If
    End If

    If (IdFrameContract > 0) Then
        If (txtDateOpen.DateValue < dFrameContractDateBegin) Then
            MsgBox "Дата заключения должна быть не ранее даты начала действия рамочного договора — " & dFrameContractDateBegin & ".", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 1
            txtDateOpen.SetFocus
            Exit Function
        End If

        If (txtDateEnd.DateValue > dFrameContractDateEnd) Then
            MsgBox "Дата окончания действия договора гарантии должна быть не позднее даты окончания действия рамочного договора — " & dFrameContractDateEnd & ".", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 1
            txtDateEnd.SetFocus
            Exit Function
        End If
    End If

    If txtCoverSumma.Enabled Then
        curSumm = txtCoverSumma.CurrencyValue
        If curSumm <= 0 Then
            MsgBox "Необходимо указать сумму покрытия договора.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 1
            txtCoverSumma.SetFocus
            Exit Function
        End If
    End If

    If dDateNextPayFee.Enabled Then
        datDate = dDateNextPayFee.DateValue
        If datDate <= dDate1990 Or datDate >= dDate2222 Then
            MsgBox "Необходимо указать дату следующей уплаты вознаграждения.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 4
            dDateNextPayFee.SetFocus
            Exit Function
        End If
    End If

    If dDateNextPayFeeBonus.Enabled Then
        datDate = dDateNextPayFeeBonus.DateValue
        If datDate <= dDate1990 Or datDate >= dDate2222 Then
            MsgBox "Необходимо указать дату следующей уплаты вознаграждения.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 4
            dDateNextPayFeeBonus.SetFocus
            Exit Function
        End If
    End If

    If cmdPeriodPayFee.Enabled Then
        If IsEmpty(arrInterval) Then
            MsgBox "Необходимо ввести данные по порядку уплаты вознаграждения.", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 4
            cmdPeriodPayFee.SetFocus
            Exit Function
        End If
    End If

    ' Вознаграждение (гарант)
    If (cmbOrderPayFeeGuarant.Text = "Периодически") Then
        datDate = dDateNextPayFeeGuarant.DateValue
        If (datDate <= dDate1990 Or datDate >= dDate2222) Then
            MsgBox "Необходимо указать дату следующей уплаты вознаграждения (гарант).", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 4
            dDateNextPayFeeGuarant.SetFocus
            Exit Function
        End If

        If IsEmpty(arrIntervalGuarant) Then
            MsgBox "Необходимо ввести данные по порядку уплаты вознаграждения (гарант).", vbExclamation, "Ошибка ввода параметров"
            Call EnableControls()
            SSActiveTabs1.SelectedTab = 4
            cmdPeriodPayFeeGuarant.SetFocus
            Exit Function
        End If
    End If

    Check = True
End Function

Private Sub Initialize()
    
    Set objErr = CreateObject("LibErr.IUbsError")
    Set objInterfaces = CreateObject("ToolPubs.Interfaces")
    Set objArray = CreateObject("Lib1.IUbsArray")
    Set objParamIn = CreateObject("ToolPubs.IUbsParam")
    Set objParamOut = CreateObject("ToolPubs.IUbsParam")
    
    oleUbsChannel.HostAddress = Parent.LoaderParamInfo(NumWin, "HostAddress")
    oleUbsChannel.UserGUID = Parent.LoaderParamInfo(NumWin, "GuidSession")
    oleUbsChannel.ParentHwnd = UserDocument.hWnd

    oleUbsChannel.LoadResource = "VBS:UBS_VBD\BG\BG_CONTRACT.vbs"
    objParamIn.ClearParameters
    objParamOut.ClearParameters

    Call oleUbsChannel.Run("BG_Interval_Init", objParamIn, objParamOut)

    If objParamOut.ExistParameter("StrError") Then
        MsgBox objParamOut.Parameter("StrError"), vbCritical, m_strCaptionForm
        Call EnableControls(False)
    Else
        arrTypePeriod = objParamOut.Parameter("Типы периодов")
        arrTypeDate = objParamOut.Parameter("Типы дат гашений")
    End If
    
    Set objInputBox = CreateObject("UbsInBox.IUbsInputBox")
    Set objWait = CreateObject("UbsWait.UbsWaitBox")
    
End Sub


Private Sub InitDoc()
    Dim q As Integer
    Dim iIdx As Integer
    Dim iId As Integer
    Dim lstCols As ColumnHeader
    Dim i As Long
    On Error GoTo Error_

    ' песочные часы
    'UserDocument.MousePointer = 11
    
    Set objStub.UbsChannel = oleUbsChannel

    objParamIn.ClearParameters
    objParamOut.ClearParameters

    objParamIn.Parameter("StrCommand") = StrCommand

    oleUbsChannel.Run "BG_Contract_Init", objParamIn, objParamOut

    setRekvBen = CInt(objParamOut.Parameter("setRekvBen"))  '[18127]
    If setRekvBen = 1 Then cmdManualBenificiar.Enabled = False '[18127]

    'Инициализация комбобокса - Список ответственных исполнителей
    If IsArray(objParamOut.Parameter("ОИ")) Then arrExecut = objParamOut.Parameter("ОИ")
    If IsArray(objParamOut.Parameter("ОИ")) Then
        cmbExecut.Clear
        For q = 0 To UBound(arrExecut, 2)
            cmbExecut.AddItem(arrExecut(1, q))
            cmbExecut.ItemData(q) = arrExecut(0, q)
        Next q
        cmbExecut.ListIndex = 0
    Else
        If StrCommand = "ADD" Or UCase(StrCommand) = "PREPARE" Then
            MsgBox "Нет прав на создание договора!", vbCritical, "Ошибка доступа"
            btnExit_Click()
            Exit Sub
        End If
    End If


    If IsArray(objParamOut.Parameter("УЛБ")) Then arrWarrant = objParamOut.Parameter("УЛБ")
    If IsArray(objParamOut.Parameter("УЛБ")) Then
        cmbWarrant.Clear
        For q = 0 To UBound(arrWarrant, 2)
            cmbWarrant.AddItem(arrWarrant(1, q))
            cmbWarrant.ItemData(q) = arrWarrant(0, q)
        Next q
        cmbWarrant.ListIndex = 0
    End If

    KindAddflSense = objParamOut.Parameter("Виды гарантии")
    If IsArray(KindAddflSense) Then
        ReDim Preserve KindAddflSense(UBound(KindAddflSense) + 1)
    Else
        ReDim KindAddflSense(0)
    End If
    KindAddflSense(UBound(KindAddflSense)) = ""
    ResetKindComboBox()

    LimitExcessCheckOn = CBool(objParamOut.Parameter("Контроль лимитов"))
    ReflectComIssue = CInt(objParamOut.Parameter("Режим учета вознаграждений"))

    arrExecutEx = objParamOut.Parameter("ОИ вып.оп.")

    If objParamOut.ExistParameter("Список типов процентных ставок") Then
        arrRates = objParamOut.Parameter("Список типов процентных ставок")
    Else
        Call MsgBox("Параметр <Список типов процентных ставок> отсутствует.", vbExclamation, "Предупреждение")
    End If

    blnInitCurrencyBonus = False

    txtDateOpen.Text = CStr(Now)

    arrGuarant = objParamOut.Parameter("Обеспечения")

    arrListRprByAcc = objParamOut.Parameter("Перечень отчетов по счету")
    If IsArray(arrListRprByAcc) Then
        For i = 0 To UBound(arrListRprByAcc, 2)
            Load mnuReports(CInt(i + 2))
            mnuReports(CInt(i + 2)).Caption = Trim$(CStr(arrListRprByAcc(1, i)))
        Next i
    End If

    'Инициализация комбобокса - Категории качества
    If IsArray(objParamOut.Parameter("Категории качества")) Then
        arrQualityCategory = objParamOut.Parameter("Категории качества")
        cmbQualityCategory.Clear
        For i = 0 To UBound(arrQualityCategory, 2)
            cmbQualityCategory.AddItem(arrQualityCategory(0, i))
            cmbQualityCategory.ItemData(i) = (arrQualityCategory(0, i))
        Next i
        cmbQualityCategory.ListIndex = 0
    Else
        MsgBox "Установка <Риск (величина резерва)> не заполнена", vbExclamation, "Предупреждение"
    End If

    'Инициализация комбобокса портфелей
    cmbPortfolio.Clear
    cmbPortfolio.AddItem("Портфель не определен")
    cmbPortfolio.ItemData(0) = 0&

    If IsArray(objParamOut.Parameter("Портфели")) Then
        arrPortfolio = objParamOut.Parameter("Портфели")
        For i = 0 To UBound(arrPortfolio, 2)
            cmbPortfolio.AddItem(arrPortfolio(1, i))
            cmbPortfolio.ItemData(i + 1) = (arrPortfolio(0, i))
        Next i
    End If

    cmbPortfolio.ListIndex = 0

    'Инициализация комбобокса причин классификации ссуд
    ' cmbRiskReason.Clear

    ' If IsArray(objParamOut.Parameter("Причины классификации ссуд")) Then
    '     arrRiskReason = objParamOut.Parameter("Причины классификации ссуд")
    '     For i = 0 To UBound(arrRiskReason, 2)
    '        cmbRiskReason.AddItem (arrRiskReason(1, i))
    '         cmbRiskReason.ItemData(i) = (arrRiskReason(0, i))
    '     Next i
    ' End If

    ' cmbRiskReason.Text = arrRiskReason(1, 0)




    'Инициализация комбобокса с типами оценки риска
    If IsArray(objParamOut.Parameter("Тип оценки риска")) Then
        arrTypeValidationRisk = objParamOut.Parameter("Тип оценки риска")
        cmbTypeValidationRisk.Clear
        For i = 0 To UBound(arrTypeValidationRisk, 2)
            cmbTypeValidationRisk.AddItem(arrTypeValidationRisk(1, i))
            cmbTypeValidationRisk.ItemData(i) = (arrTypeValidationRisk(0, i))
        Next i
        cmbTypeValidationRisk.ListIndex = 0
    Else
        MsgBox "Список типов оценок риска пуст", vbExclamation, "Предупреждение"
    End If


    'Инициализация комбобокса - Типы покрытия
    iIdx = 0
    If IsArray(objParamOut.Parameter("Типы покрытия")) Then
        arrCoverTypes = objParamOut.Parameter("Типы покрытия")
        For q = 0 To UBound(arrCoverTypes, 2)
            cmbCoverType.AddItem(arrCoverTypes(1, q))
            cmbCoverType.ItemData(q) = (arrCoverTypes(0, q))
            If arrCoverTypes(0, q) = 0 Then
                iIdx = q
            End If
        Next q
        cmbCoverType.ListIndex = iIdx
    Else
        MsgBox "Список типов покрытия пуст", vbExclamation, "Предупреждение"
        'If CheckParamForClose(LoadParam) Then
        'btnExit_Click
        'Exit Sub
        'End If
    End If

    'Инициализация комбобокса - Список валют
    If IsArray(objParamOut.Parameter("Валюты")) Then
        arrCurrency = objParamOut.Parameter("Валюты")
        For q = 0 To UBound(arrCurrency, 2)
            cmbValuta.AddItem(arrCurrency(3, q))
            cmbValuta.ItemData(q) = arrCurrency(0, q)
            cmbCoverValuta.AddItem(arrCurrency(3, q))
            cmbCoverValuta.ItemData(q) = arrCurrency(0, q)
            cmbBonusValuta.AddItem(arrCurrency(3, q))
            cmbBonusValuta.ItemData(q) = arrCurrency(0, q)
            cmbBonusValutaBonus.AddItem(arrCurrency(3, q))
            cmbBonusValutaBonus.ItemData(q) = arrCurrency(0, q)
            If arrCurrency(0, q) = IIf(IdValuta > 0, IdValuta, 810) Then
                iIdx = q
            End If
        Next q
        cmbValuta.ListIndex = iIdx
        cmbCoverValuta.ListIndex = iIdx
        cmbBonusValuta.ListIndex = iIdx
        cmbBonusValutaBonus.ListIndex = iIdx
    Else
        If CheckParamForClose(LoadParam) Then
            MsgBox "Список валют пуст", vbCritical, "Ошибка инициализации"
            btnExit_Click()
            Exit Sub
        End If
        MsgBox "Список валют пуст", vbExclamation, "Предупреждение"
    End If

    'Инициализация комбобокса - Список состояний
    If IsArray(objParamOut.Parameter("Состояния")) Then
        arrState = objParamOut.Parameter("Состояния")
        iIdx = 0
        IdState = 4
        For q = 0 To UBound(arrState, 2)
            cmbState.AddItem(arrState(1, q))
            cmbState.ItemData(q) = (arrState(0, q))
            If arrState(0, q) = IdState Then
                iIdx = q
            End If
        Next q
        cmbState.ListIndex = iIdx
        cmbState.Enabled = False
    Else
        If CheckParamForClose(LoadParam) Then
            'MsgBox "Список состояний пуст", vbCritical, "Ошибка инициализации"
            'btnExit_Click
            'Exit Sub
        End If
        MsgBox "Список состояний пуст", vbExclamation, "Предупреждение"
    End If

    'Инициализация комбобокса - Список отделений
    If IsArray(objParamOut.Parameter("Отделения")) Then
        iIdx = 0
        iId = objParamOut.Parameter("GUDiv")
        arrDivs = objParamOut.Parameter("Отделения")
        For q = 0 To UBound(arrDivs, 2)
            cmbNumberDiv.AddItem(arrDivs(1, q))
            cmbNumberDiv.ItemData(q) = (arrDivs(0, q))
            If arrDivs(0, q) = iId Then
                iIdx = q
            End If
        Next q
        cmbNumberDiv.ListIndex = iIdx
        ' (12485) ---
        'If StrCommand <> "ADD" Or UCase(StrCommand) = "PREPARE" Then
        If UCase(StrCommand) <> "ADD" Then
            ' (12485) ---
            If StrCommand = "EDIT" And IdState = 2 Then
                'MsgBox "2 InitDoc True"
                cmbNumberDiv.Enabled = True
                If cmbTypePayFee.Text = "Процент суммы гарантии" Then
                    cmbBonusValuta.ListIndex = cmbValuta.ListIndex
                    cmbBonusValuta.Enabled = False
                    cmbBonusValutaBonus.Enabled = False
                Else
                    cmbBonusValuta.Enabled = True
                    cmbBonusValutaBonus.Enabled = True
                End If

                If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
                    cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
                    cmbBonusValutaBonus.Enabled = False
                Else
                    cmbBonusValutaBonus.Enabled = True
                End If
            Else
                'MsgBox "2 InitDoc False"
                cmbNumberDiv.Enabled = False
            End If
        End If
        If UCase(StrCommand) = "PREPARE" Then cmbNumberDiv.Enabled = True  ' (12485) ---

    Else
        If CheckParamForClose(LoadParam) Then
            'MsgBox "Список отделений пуст", vbCritical, "Ошибка инициализации"
            'btnExit_Click
            'Exit Sub
        End If
        MsgBox "Список отделений пуст", vbExclamation, "Предупреждение"
    End If

    'Инициализация заголовков ListView
    Call lstAccounts.ColumnHeaders.Clear
    Call lstAccounts.ColumnHeaders.Add(, , "Тип счета")
    Call lstAccounts.ColumnHeaders.Add(, , "Раздел")
    Call lstAccounts.ColumnHeaders.Add(, , "Счет")
    Call lstAccounts.ColumnHeaders.Add(, , "Остаток")
    lstAccounts.ColumnHeaders(1).Width = 2700
    lstAccounts.ColumnHeaders(2).Width = 450
    lstAccounts.ColumnHeaders(3).Width = 2950
    lstAccounts.ColumnHeaders(4).Alignment = lvwColumnRight

    'Инициализация заголовков lvwGuarant
    lvwGuarant.ColumnHeaders.Clear
    Call lvwGuarant.ColumnHeaders.Add(, , "Идентификатор")
    Call lvwGuarant.ColumnHeaders.Add(, , "Номер договора")
    Call lvwGuarant.ColumnHeaders.Add(, , "Описание")

    lvwGuarant.ColumnHeaders(1).Width = 400
    lvwGuarant.ColumnHeaders(2).Width = 1500
    lvwGuarant.ColumnHeaders(3).Width = 4500

    If IdState < 2 Then
        dDateNextPayFee.Enabled = False
    Else
        dDateNextPayFee.Enabled = True
    End If

    If StrCommand = "ADD" Or UCase(StrCommand) = "PREPARE" Then
        btnReRead.Enabled = False
        SSActiveTabs1.Tabs(3).Enabled = False
        SSActiveTabs1.Tabs(4).Enabled = False
        SSActiveTabs1.Tabs(5).Enabled = False
        cmbOrderPayFee.Enabled = True
        cmbTypePayFee.Enabled = True
        cmbOrderPayFeeBonus.Enabled = True
        cmbTypePayFeeBonus.Enabled = True
    ElseIf StrCommand = "COPY" Then
        btnReRead.Enabled = False
        SSActiveTabs1.Tabs(3).Enabled = True
        SSActiveTabs1.Tabs(4).Enabled = True
        SSActiveTabs1.Tabs(5).Enabled = True
        cmbOrderPayFee.Enabled = True
        cmbTypePayFee.Enabled = True
        cmbOrderPayFeeBonus.Enabled = True
        cmbTypePayFeeBonus.Enabled = True
        cmbOrderPayFeeGuarant.Enabled = True
        cmbTypePayFeeGuarant.Enabled = True
        btnModel.Enabled = True
    Else
        btnReRead.Enabled = True
        SSActiveTabs1.Tabs(3).Enabled = True
        SSActiveTabs1.Tabs(4).Enabled = True
        SSActiveTabs1.Tabs(5).Enabled = True
        cmbOrderPayFee.Enabled = False
        cmbTypePayFee.Enabled = False
        cmbOrderPayFeeBonus.Enabled = False
        cmbTypePayFeeBonus.Enabled = False
        cmbOrderPayFeeGuarant.Enabled = False
        cmbTypePayFeeGuarant.Enabled = False
        cmbBonusValutaBonus.Enabled = False
        cmbBonusValuta.Enabled = False
    End If

    If UCase(StrCommand) = "COPY" Then
        Dim porVoz
        objParamIn.Parameter("Id") = IdContractCopy
        oleUbsChannel.Run "BG_Contract_Copy", objParamIn, objParamOut

        arrPeriodPay = objParamOut.Parameter("Срок погашения оплаченной суммы")

        blnFixSum = CBool(objParamOut.Parameter("Тип вознаграждения") = "Фиксированная сумма")

        ucpParam.UbsAddFields = objStub
        ucpParam.Refresh

        txtModel.Text = objParamOut.Parameter("Типовой договор")
        txtBeneficiar.Text = objParamOut.Parameter("Бенефициар")
        txtGarant.Text = objParamOut.Parameter("Гарант")
        txtFrameContract.Text = objParamOut.Parameter("Наименование рамочного договора")

        SetComboValueText kindComboBox, CStr(objParamOut.Parameter("Вид гарантии"))

        IdModel = objParamOut.Parameter("Идентификатор типового договора")
        IdPrincipal = objParamOut.Parameter("Идентификатор клиента-принципала")
        IdPrincipalOld = IdPrincipal
        IdBeneficiar = objParamOut.Parameter("Идентификатор клиента-бенефициара")
        If IdBeneficiar = 0 Then arrDetailsBeneficiar = objParamOut.Parameter("Реквизиты бенефициара")
        porVoz = objParamOut.Parameter("Порядок уплаты вознаграждения")

        IdDivision = objParamOut.Parameter("Номер отделения")
        IdOI = objParamOut.Parameter("Идентификатор ОИ")
        IdWarrant = objParamOut.Parameter("Идентификатор доверенности")
        IdState = 2
        IdValuta = objParamOut.Parameter("Идентификатор валюты")

        IdCoverType = objParamOut.Parameter("Тип покрытия")

        IdGarant = objParamOut.Parameter("Идентификатор клиента-гаранта")
        IdFrameContract = objParamOut.Parameter("Идентификатор рамочного договора")
        If IdFrameContract > 0 Then
            dFrameContractDateBegin = CDate(objParamOut.Parameter("Дата начала действия рамочного договора"))
            dFrameContractDateEnd = CDate(objParamOut.Parameter("Дата окончания действия рамочного договора"))
            FrameContractTerms = objParamOut.Parameter("Срок гарантии рамочного договора")
            FrameContractLimitSaldo = objParamOut.Parameter("Остаток лимита рамочного договора")
            IssueEndDate = CDate(objParamOut.Parameter("Дата окончания выдачи"))
            FrameContractDivision = CInt(objParamOut.Parameter("Отделение рамочного договора"))
            'btnFrameContractDel.Visible = False
            'btnFrameContract.Visible = False
            ''txtFrameContract.Width = 4695
            SetInfoByFrameContract()
        Else
            txtPrincipal.Text = objParamOut.Parameter("Принципал")
        End If

        If IdAgent > 0 Then
            'btnAgentDel.Visible = False
            'btnAgent.Visible = False
            'txtAgent.Width = 4695
        End If

        ReDim arrInterval(3, 0) As Variant
        arrInterval(0, 0) = objParamOut.Parameter("Вознаграждение. Тип периода")
        arrInterval(1, 0) = objParamOut.Parameter("Вознаграждение. Период")
        arrInterval(2, 0) = objParamOut.Parameter("Вознаграждение. Тип даты")
        arrInterval(3, 0) = objParamOut.Parameter("Вознаграждение. Номер дня")

        'Вознаграждение (гарант)
        strOrderPayFeeGuarant = CStr(objParamOut.Parameter("Порядок уплаты вознаграждения (гарант)"))

        If (strOrderPayFeeGuarant <> "") Then
            frmPayFeeGuarant.Visible = True
            Dim TypePayFeeGuarant : TypePayFeeGuarant = CStr(objParamOut.Parameter("Тип вознаграждения (гарант)"))
            If (strOrderPayFeeGuarant = "Периодически") Then
                dDateNextPayFeeGuarant.DateValue = objParamOut.Parameter("Дата след. уплаты вознаграждения (гарант)")
                arrIntervalGuarant = objParamOut.Parameter("Вознаграждение (гарант)")
            End If
        End If

        If objParamOut.ExistParameter("Идентификатор портфеля") Then
            Call SetComboText(cmbPortfolio, objParamOut.Parameter("Идентификатор портфеля"))
        End If

        If objParamOut.ExistParameter("Тип оценки риска") Then
            Call SetComboText(cmbTypeValidationRisk, objParamOut.Parameter("Тип оценки риска"))
        End If

        If objParamOut.ExistParameter("Группа риска") Then
            objInterfaces.SetFocusCombo cmbQualityCategory, objParamOut.Parameter("Группа риска")
            cmbQualityCategory.Text = objParamOut.Parameter("Группа риска")
        End If

        '  If objParamOut.ExistParameter("Причина классификации ссуды") Then

        '     Dim indexItem

        '    For i = 0 To cmbRiskReason.ListCount - 1
        '       If cmbRiskReason.ItemData(i) = objParamOut.Parameter("Причина классификации ссуды") Then
        '          cmbRiskReason.ListIndex = i
        '           indexItem = i
        '           Exit For
        '       End If
        '   Next i

        ' End If

        If objParamOut.ExistParameter("Ставка резервирования") Then
            ucmRateReservation.CurrencyValue = objParamOut.Parameter("Ставка резервирования")
        End If

        Call SetComboText(cmbNumberDiv, IdDivision)
        Call SetComboText(cmbExecut, IdOI)
        Call SetComboText(cmbWarrant, IdWarrant)
        Call SetComboText(cmbCoverType, IdCoverType)
        Call SetComboText(cmbState, IdState)
        Call SetComboText(cmbValuta, IdValuta)

        txtNumber.Text = objParamOut.Parameter("Номер договора")
        txtDateOpen.Text = objParamOut.Parameter("Дата заключения")
        txtDateClose.Text = objParamOut.Parameter("Дата закрытия")
        txtDateBegin.Text = objParamOut.Parameter("Дата начала действия")
        txtDatePrincipal.Text = objParamOut.Parameter("Дата возникн. обязательства Принципала") ' [16430]
        dateBeginC = objParamOut.Parameter("Дата начала действия")  ' (70774)
        txtDateEnd.Text = objParamOut.Parameter("Дата окончания действия")

        lIdBonusValuta = objParamOut.Parameter("Идентификатор валюты вознаграждения")
        Call SetComboText(cmbBonusValuta, lIdBonusValuta)

        blnInitCurrencyBonus = True

        txtGarantSumma.CurrencyValue = objParamOut.Parameter("Сумма гарантии")
        IdCoverType = objParamOut.Parameter("Тип покрытия")
        Call SetComboText(cmbCoverType, IdCoverType)
        txtCoverSumma.CurrencyValue = objParamOut.Parameter("Сумма покрытия")
        lIdCoverValuta = objParamOut.Parameter("Идентификатор валюты покрытия")
        Call SetComboText(cmbCoverValuta, lIdCoverValuta)
        lIdCoverContract = objParamOut.Parameter("Идентификатор договора покрытия")
        If objParamOut.ExistParameter("Договор покрытия") Then
            txtCoverDogovor.Text = objParamOut.Parameter("Договор покрытия")
        End If
        Dim accs
        accs = objParamOut.Parameter("Счета")
        ucpParam.PropertyByName("Реквизиты оплаты гарантии") = objParamOut.Parameter("Реквизиты оплаты гарантии")


        objParamIn.Parameter("ID") = IdModel
        Call oleUbsChannel.Run("BGReadModelById", objParamIn, objParamOut)
        arrPeriodPay = objParamOut.Parameter("Срок погашения оплаченной суммы")
        If IsArray(arrPeriodPay) Then
            Dim cnt As Integer
            Dim arrRatesFromModel(1, 0) As Variant
            If IsArray(arrRateValues) Then
                If UBound(arrRateValues) <> UBound(arrRates) Then
                    ReDim Preserve arrRateValues(UBound(arrRates)) As Variant
                End If
            Else
                ReDim arrRateValues(UBound(arrRates)) As Variant
            End If
            '[19608]
            arrRatesFromModel(0, 0) = txtDateBegin.DateValue

            'Date
            For cnt = 0 To UBound(arrRates)
                Select Case arrRates(cnt)
                    Case "Ставка % по оплаченной гарантии"
                        arrRatesFromModel(1, 0) = arrPeriodPay(2, 0)
                        arrRateValues(cnt) = arrRatesFromModel
                    Case "Ставка % по просроченной оплате гарантии"
                        arrRatesFromModel(1, 0) = arrPeriodPay(3, 0)
                        arrRateValues(cnt) = arrRatesFromModel
                    Case "Ставка пени за просрочку погашения процентов по оплаченной гарантии", "Ставка пени за просрочку погашения оплаченной гарантии"
                        arrRatesFromModel(1, 0) = arrPeriodPay(4, 0)
                        arrRateValues(cnt) = arrRatesFromModel
                    Case "Ставка вознаграждения за пользование гарантией"
                        arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения"))
                        arrRateValues(cnt) = arrRatesFromModel
                    Case "Ставка вознаграждения (гарант)"
                        arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения (гарант)"))
                        arrRateValues(cnt) = arrRatesFromModel
                    Case "Ставка вознаграждения за выдачу гарантии"
                        arrRatesFromModel(1, 0) = CDbl(objParamOut.Parameter("Ставка вознаграждения за выдачу"))
                        arrRateValues(cnt) = arrRatesFromModel
                End Select
            Next
            Call InitTrvRates(True)
        End If

        ucpParam.PropertyByName("Очередность платежей") = objParamOut.Parameter("Очередность платежей")
        ucpParam.PropertyByName("Досрочное гашение в групповом режиме") = objParamOut.Parameter("Досрочное гашение в групповом режиме")
        ucpParam.PropertyByName("Параметры расчета графиков") = objParamOut.Parameter("Параметры расчета графиков")
        ucpParam.PropertyByName("Сумма платежа") = objParamOut.Parameter("Сумма платежа")
        ucpParam.PropertyByName("Алгоритм расчета процентов") = objParamOut.Parameter("Алгоритм расчета процентов")
        ucpParam.PropertyByName("Льготный период") = objParamOut.Parameter("Льготный период")
        ucpParam.PropertyByName("Режим смещения выходных дней") = objParamOut.Parameter("Режим смещения выходных дней")
        ucpParam.PropertyByName("Алгоритм расчета суммы платежа") = objParamOut.Parameter("Алгоритм расчета суммы платежа")
        ucpParam.PropertyByName("Исключить неполный первый период") = objParamOut.Parameter("Исключить неполный первый период")
        ucpParam.PropertyByName("Отсрочка") = objParamOut.Parameter("Отсрочка")


        txtModel.Text = objParamOut.Parameter("Наименование")
        sModelType = objParamOut.Parameter("Идентификатор шаблона")
        strOrderPayFeeGuarant = objParamOut.Parameter("Порядок уплаты вознаграждения (гарант)")

        If (strOrderPayFeeGuarant <> "") Then
            frmPayFeeGuarant.Visible = True
            If (strOrderPayFeeGuarant = "Периодически") Then
                dDateNextPayFeeGuarant.Visible = True
                cmdPeriodPayFeeGuarant.Visible = True
                lblDateNextPayFeeGuarant.Visible = True
            End If
        Else
            frmPayFeeGuarant.Visible = False
        End If

        If Not IsArray(objParamOut.Parameter("Порядок уплаты вознаграждения (список)")) Then
            MsgBox "Параметр 'Порядок уплаты вознаграждения (список)' пуст!", vbCritical, "Договор гарантии"
            If CheckParamForClose(LoadParam) Then
                btnExit_Click()
                Exit Sub
            End If
        End If

        arrPayOrder = objParamOut.Parameter("Порядок уплаты вознаграждения (список)")
        Call FillComboText(cmbOrderPayFee, arrPayOrder)
        Call SetComboValueText(cmbOrderPayFee, CStr(porVoz))

        Call FillComboText(cmbOrderPayFeeBonus, arrPayOrder)
        Call SetComboValueText(cmbOrderPayFeeBonus, CStr(porVoz))


        'Вознаграждение (гарант)
        If (strOrderPayFeeGuarant <> "") Then
            Call FillComboText(cmbOrderPayFeeGuarant, arrPayOrder)
            Call SetComboValueText(cmbOrderPayFeeGuarant, strOrderPayFeeGuarant)
        End If

        If Not IsArray(objParamOut.Parameter("Тип вознаграждения (список)")) Then
            MsgBox "Параметр 'Тип вознаграждения (список)' пуст!", vbCritical, "Договор гарантии"
            If CheckParamForClose(LoadParam) Then
                btnExit_Click()
                Exit Sub
            End If
        End If

        arrTypeBonus = objParamOut.Parameter("Тип вознаграждения (список)")
        Call FillComboText(cmbTypePayFee, arrTypeBonus)
        Call SetComboValueText(cmbTypePayFee, CStr(objParamOut.Parameter("Тип вознаграждения")))

        Call FillComboText(cmbTypePayFeeBonus, arrTypeBonus)
        Call SetComboValueText(cmbTypePayFeeBonus, CStr(objParamOut.Parameter("Тип вознаграждения за выдачу")))

        Call SetBonusCtrlsState()
        Call SetBonusCtrlsBonusState()

        'Вознаграждение (гарант)
        If (strOrderPayFeeGuarant <> "") Then
            Call FillComboText(cmbTypePayFeeGuarant, arrTypeBonus)
            Call SetComboValueText(cmbTypePayFeeGuarant, CStr(objParamOut.Parameter("Тип вознаграждения (гарант)")))
        End If

        SSActiveTabs1.Tabs(3).Enabled = True
        SSActiveTabs1.Tabs(4).Enabled = True

        objParamIn.Parameter("Идентификатор типового договора") = IdModel
        objParamIn.Parameter("Порядок уплаты вознаграждения") = cmbOrderPayFee.Text


        If sModelType = "UBS_GUARANT" Then
            If IdState <> 2 Then
                btnGarant.Enabled = False
            Else
                btnGarant.Enabled = True
            End If

            IdGarant = 0
            txtGarant.Text = ""
        Else 'sModelType = "UBS_COUNTER_GUARANT"
            btnGarant.Enabled = True
        End If



        Call oleUbsChannel.Run("BG_Contract_Init_Ucp", objParamIn, objParamOut)
        arrAccounts = accs
        Call FilllstAccounts()

        dDateNextPayFee.DateValue = objParamOut.Parameter("Дата следующей уплаты вознаграждения")

    End If


    Call ReReadDoc()

    If StrCommand = "COPY" Then btnModel.Enabled = True

    If (StrCommand = "ADD" Or UCase(StrCommand) = "PREPARE") And IdFrameContract > 0 Then
        IdState = 4

        objParamIn.Parameter("ID") = IdFrameContract
        oleUbsChannel.Run "BGReadFrameContractById", objParamIn, objParamOut

        If (objParamOut.ExistParameter("Ошибка")) Then
            IdFrameContract = 0
            MsgBox CStr(objParamOut.Parameter("Ошибка")), vbCritical, m_strCaptionForm
        Else
            txtFrameContract.Text = CStr(objParamOut.Parameter("Наименование"))
            dFrameContractDateBegin = CDate(objParamOut.Parameter("Дата начала действия рамочного договора"))
            dFrameContractDateEnd = CDate(objParamOut.Parameter("Дата окончания действия рамочного договора"))
            FrameContractTerms = objParamOut.Parameter("Срок гарантии рамочного договора")
            FrameContractLimitSaldo = objParamOut.Parameter("Остаток лимита")
            IssueEndDate = CDate(objParamOut.Parameter("Дата окончания выдачи"))
            FrameContractDivision = CInt(objParamOut.Parameter("Номер отделения"))

            'btnFrameContractDel.Visible = False
            'btnFrameContract.Visible = False
            ''txtFrameContract.Width = 4695

            SetInfoByFrameContract()
        End If
    End If

    If (StrCommand = "ADD" Or UCase(StrCommand) = "PREPARE") And IdAgent > 0 Then
        'btnAgentDel.Visible = False
        'btnAgent.Visible = False
        'txtAgent.Width = 4695
    End If

    If Not IsEmpty(dateNextPayFeeValue) And dateNextPayFeeValue > dDate1990 Then _
                dDateNextPayFee.DateValue = dateNextPayFeeValue
    If Not IsEmpty(dateNextPayFeeBonusValue) And dateNextPayFeeBonusValue > dDate1990 Then _
                dDateNextPayFeeBonus.DateValue = dateNextPayFeeBonusValue

    'включение остальных полей для редактирования договора в сост подготовлен
    If UCase(StrCommand) = "EDIT" And IdState = 4 Then
        btnPrincipal.Enabled = True
        btnModel.Enabled = True
        btnFrameContract.Visible = True
        btnFrameContract.Enabled = True
        btnAgent.Visible = True
        btnAgent.Enabled = True
    End If
    Exit Sub
Error_:
    UserDocument.MousePointer = 0
    objErr.UbsMsgRaise "InitDoc", "Ошибка выполнения"
End Sub
Private Sub SetEnableCombos()
    If IdState = 4 Then
        btnReRead.Enabled = True
        SSActiveTabs1.Tabs(3).Enabled = True
        SSActiveTabs1.Tabs(4).Enabled = True
        SSActiveTabs1.Tabs(5).Enabled = True
        cmbOrderPayFee.Enabled = True
        cmbTypePayFee.Enabled = True
        cmbOrderPayFeeBonus.Enabled = True
        cmbTypePayFeeBonus.Enabled = True
        cmbOrderPayFeeGuarant.Enabled = True
        cmbTypePayFeeGuarant.Enabled = True
        btnGarant.Enabled = True
        cmbNumberDiv.Enabled = True
        btnPreviousContract.Enabled = True
    End If
    cmbValuta.Enabled = cmbValutaEnabled()
End Sub

Private Sub SetComboText(in_Ctrl As ComboBox, ByVal in_Val As Long)
    Dim iIdx As Long
    Dim i As Long
    On Error GoTo Error_

    iIdx = 0
    For i = 0 To in_Ctrl.ListCount - 1
        If in_Ctrl.ItemData(i) = in_Val Then
            in_Ctrl.ListIndex = i
            Exit For
        End If
    Next i

    Exit Sub
Error_:
    UserDocument.MousePointer = 0
    objErr.UbsMsgRaise "SetComboText", "ошибка выполнения"
End Sub

Private Function CheckParamForClose(ByVal NameParam As String) As Boolean
    CheckParamForClose = False
    If (NameParam = "LoadFromMenu") Or (NameParam = "InitParamForm") Or (NameParam = "InitParamGrid") Then
        CheckParamForClose = True
    End If
End Function

Sub EnabledCmdControl(ByVal En As Boolean)
    btnBeneficiar.Enabled = En

    If IdState <> 0 And IdState <> 2 Then cmdManualBenificiar.Enabled = En '(99025)
    If sModelType = "UBS_COUNTER_GUARANT" Then btnGarant.Enabled = En
    'If IdState = 2 Then btnGarant.Enabled = True
    btnModel.Enabled = En
    btnAgent.Enabled = En
    btnPreviousContract.Enabled = En
    If (IdFrameContract = 0) Then btnPrincipal.Enabled = En
    If (btnFrameContract.Visible) Then btnFrameContract.Enabled = En
    If (btnFrameContractDel.Visible) Then btnFrameContractDel.Enabled = En
    If (btnAgent.Visible) Then btnAgent.Enabled = En
    If (btnAgentDel.Visible) Then btnAgentDel.Enabled = En

    If setRekvBen = 1 Then cmdManualBenificiar.Enabled = False '[18127]
End Sub

'===================================================================
'*********   WORK with Accounts list
'===================================================================

Private Function AddAccount(objParamIn As Variant)
    Dim i As Integer
    On Error GoTo ErrorCode

    'Добавление выбранного счета в массив счетов
    For i = 0 To UBound(arrAccounts, 2)
        If arrAccounts(0, i) = strListItemKey Then
            arrAccounts(2, i) = objParamIn.Parameter("Номер счета")
            Exit For
        End If
    Next i

    'Добавление выбранного счета в lstAccounts
    lstAccounts.ListItems(strListItemKey).SubItems(2) = objParamIn.Parameter("Номер счета")
    lstAccounts.ListItems(strListItemKey).SubItems(3) = objParamIn.Parameter("Остаток")

    Exit Function
ErrorCode:
    objErr.UbsErrMsg "AddAccount", "ошибка выполнения"
End Function


Private Function DelAccount()
    Dim i As Integer
    On Error GoTo ErrorCode

    'Удаление выбранного счета из массива счетов
    For i = 0 To UBound(arrAccounts, 2)
        If arrAccounts(0, i) = strListItemKey Then
            arrAccounts(2, i) = ""
            Exit For
        End If
    Next i

    'Удаление выбранного счета из lstAccounts
    lstAccounts.ListItems(strListItemKey).SubItems(2) = ""
    lstAccounts.ListItems(strListItemKey).SubItems(3) = ""

    Exit Function
ErrorCode:
    objErr.UbsErrMsg "DelAccount", "ошибка выполнения"
End Function

Private Sub GetAccount()
    Dim objGridList As Object
    Dim varInitParam(5) As Variant
    Dim strFilterName As String
    Dim varCond As Variant, RetVal1 As Long, i As Integer
    Dim strBalNum2 As String
    On Error GoTo ErrorCode

    If NumChildWinListAccounts <> 0 Then
        Call Parent.SetFocusToWindow(NumChildWinListAccounts)
        Exit Sub
    End If

    Select Case strSection
        Case "А"
            strFilterName = "UBS_FLT\OD\ACCOUNT0.flt"
        Case "В"
            strFilterName = "UBS_FLT\OD\ACCOUNT2.flt"
    End Select

    Call Parent.GetWindow(strFilterName, NumChildWinListAccounts)

    If NumChildWinListAccounts <> 0 Then
        Set objGridList = Parent.ParamInfo(NumChildWinListAccounts, "UbsGridList")
                
        objGridList.GetWhereRS 1, varCond
        RetVal1 = 0

        If Not IsEmpty(varCond) Then
            For i = 0 To UBound(varCond, 2)
                If varCond(0, i) = "Балансовый счет" Then
                    RetVal1 = varCond(4, i)
                End If
            Next
        End If

        'Установка условий фильтра
        strBalNum2 = ""
        Select Case strAccType
            Case "Счет начисленных процентов"
                strBalNum2 = "47427"
            Case "Счет начисленных процентов внебаланс"
                strBalNum2 = "91604"
            Case "Резерв по начисленным процентам"
                strBalNum2 = "47425"
            'Case "Счет просроченных процентов" (110253)
                'strBalNum2 = "45912"
            Case "Счет просроченных процентов внебаланс"
                strBalNum2 = "91604"
            Case "Резерв по просроченным процентам"
                strBalNum2 = "45918"
        End Select

        If strBalNum2 <> "" Then
            If RetVal1 <> 0 Then
                objGridList.DelWhereItem RetVal1
            End If
            RetVal1 = objGridList.AddWhereItem("Балансовый счет", 4, strBalNum2)

            objGridList.WhereItemFlags(RetVal1) = 0
        End If

        If Parent.IsExistParam(NumChildWinListAccounts, "InitParamGrid") Then
            varInitParam(0) = NumWin
            varInitParam(2) = True
            varInitParam(5) = 1 'Номер закладки фильтра

            Parent.ParamInfo(NumChildWinListAccounts, "InitParamGrid") = varInitParam
            Parent.SetFocusToWindow NumChildWinListAccounts

        End If

        Set objGridList = Nothing
        
    End If

    Exit Sub

ErrorCode:
    objErr.UbsErrMsg "GetAccount", "ошибка выполнения"
End Sub


Private Function FilllstAccounts()
    Dim i As Integer
    Dim itmAcc As ListItem
    On Error GoTo ErrorCode

    lstAccounts.ListItems.Clear

    If Not IsEmpty(arrAccounts) Then

        objParamIn.ClearParameters
        objParamOut.ClearParameters

        'objParamIn.Parameter("ID") = Val(IdObject)
        objParamIn.Parameter("Счета") = arrAccounts

        Call oleUbsChannel.Run("BGReadAccountsByContract", objParamIn, objParamOut)

        If Len(objParamOut.Parameter("StrError")) > 0 Then
            MsgBox objParamOut.Parameter("StrError"), vbCritical, "Договор банковских гарантий"
            Call EnableControls()
            Exit Function
        End If

        arrAccounts = objParamOut.Parameter("Счета")

        For i = 0 To UBound(arrAccounts, 2)
            Set itmAcc = lstAccounts.ListItems.Add(, arrAccounts(0, i), arrAccounts(0, i))
            itmAcc.SubItems(1) = arrAccounts(1, i)
            itmAcc.SubItems(2) = arrAccounts(2, i)
            itmAcc.SubItems(3) = arrAccounts(3, i)
        Next i
    Else
        MsgBox "Список счетов пуст!", vbCritical, "Договор банковских гарантий"
    End If

    Exit Function
ErrorCode:
    objErr.UbsErrMsg "FilllstAccounts", "ошибка выполнения"
End Function


Private Function EnableControls(Optional in_State As Boolean = True)

    btnSave.Enabled = (in_State And blnSecure)
    btnExit.Enabled = in_State

End Function


Private Sub mnuClearAccount_Click()
    If lstAccounts.ListItems.Count > 0 Then
        strListItemKey = lstAccounts.SelectedItem.Key
        Call DelAccount()
    End If
End Sub

Private Sub mnuListAccounts_Click()
    If lstAccounts.ListItems.Count > 0 Then
        strSection = (CStr(lstAccounts.SelectedItem.SubItems(1)))
        strAccType = (CStr(lstAccounts.SelectedItem.Text))
        strListItemKey = lstAccounts.SelectedItem.Key
        Call GetAccount()
    End If
End Sub




Private Sub GetReport(ByVal lngReport As Long, ByVal strAccount As String)
    Dim dFrom As Date
    Dim dTo As Date
    Dim objScript As Object
    Dim arrReportInfo As Variant
    Dim objReport As Object
    Dim lngWindow As Long
    Dim varInitParam(3) As Variant
    On Error GoTo ErrorCode


    'Начальная дата
    dFrom = Date
    'Конечная  дата
    dTo = dFrom
    'Уточняем начальную дату
    If UCase(StrCommand) = "EDIT" Then
        dFrom = txtDateOpen.DateValue
    End If

    'Информация об отчете
    ReDim arrReportInfo(3)

    'Строковый идентификатор отчета
    arrReportInfo(0) = CStr(arrListRprByAcc(0, lngReport - 2&))
    'Порядковый номер параметра "Счет"    в отчете
    arrReportInfo(1) = CLng(arrListRprByAcc(2, lngReport - 2&))
    'Порядковый номер параметра "Дата с"  в отчете
    arrReportInfo(2) = CLng(arrListRprByAcc(3, lngReport - 2&))
    'Порядковый номер параметра "Дата по" в отчете
    arrReportInfo(3) = CLng(arrListRprByAcc(4, lngReport - 2&))


    Parent.GetWindow CStr(arrReportInfo(0)), lngWindow

    If lngWindow <> 0 Then

        varInitParam(0) = NumWin
        varInitParam(1) = Array(arrReportInfo(0))
        varInitParam(3) = True

        Parent.ParamInfo(lngWindow, "InitParamForm") = varInitParam

        Set objReport = Parent.ParamInfo(lngWindow, "GetUbsReport")
        If CLng(arrReportInfo(1)) > 0 Then
            objReport.Params(CLng(arrReportInfo(1))).Value = strAccount
        End If
        If CLng(arrReportInfo(2)) > 0 Then
            objReport.Params(CLng(arrReportInfo(2))).Value = dFrom
        End If
        If CLng(arrReportInfo(3)) > 0 Then
            objReport.Params(CLng(arrReportInfo(3))).Value = dTo
        End If
        Set objReport = Nothing

        Parent.ParamInfo(lngWindow, "RefreshParam") = True
        Parent.SetFocusToWindow lngWindow

    End If

    '    Call objScript.Run("GetReport", arrReportInfo, strAccount, dFrom, dTo)

    Exit Sub
ErrorCode:
    objErr.UbsErrMsg "GetReport", "ошибка выполнения"
End Sub


Private Sub GetRate(ByVal StrCommandRates As String)
    Dim objNode As Node, strKeyParent As String, strKey As String, i As Integer
    Dim j As Integer, arrRateTemp As Variant, intItemIndex As Integer, q As Integer
    Dim strTypeRate As String, ArrCond As Variant, tstr As String

    On Error GoTo ErrorCode

    ' Загружаем форму и инициализируем ее
    Load frmRates

    If trvRates.SelectedItem Is Nothing Then
        Exit Sub
    End If

    strKeyParent = trvRates.SelectedItem.Key
    intItemIndex = trvRates.SelectedItem.index

    Dim sumFormat1 As String


    With frmRates

        .Caption = "Добавить ставку"

        .ucdDateRate.DateValue = txtDateOpen.DateValue
        .cmbRateTypes.Clear
        .cmbRateTypes.AddItem(trvRates.SelectedItem.Text)
        .cmbRateTypes.ListIndex = 0
        If UCase(StrCommandRates) = "EDIT" Then
            .Caption = "Изменить ставку"

            q = InStr(strKeyParent, " Date:")
            strKey = Mid(strKeyParent, 1, q - 1)
            strTypeRate = Mid(strKeyParent, 11, q - 11)
            .cmbRateTypes.Clear
            .cmbRateTypes.AddItem(strTypeRate)
            .cmbRateTypes.ListIndex = 0
            .ucdDateRate.DateValue = Mid(trvRates.SelectedItem.Text, 1, 10)
            sumFormat1 = objFormat.FixToSaldo(Mid(trvRates.SelectedItem.Text, 14), 18, 2, "+")
            .ucmRate.CurrencyValue = sumFormat1

            .ucdDateRate.Enabled = False
        End If
        .Show vbModal

        ' Если нажали кнопку "Применить"
        If .blnApply Then
            For i = 0 To UBound(arrRates)
                If arrRates(i) = .cmbRateTypes.Text Then
                    arrRateTemp = arrRateValues(i)
                    If UCase(StrCommandRates) = "ADD" Then
                        If IsArray(arrRateTemp) Then
                            For j = 0 To UBound(arrRateTemp, 2)
                                If arrRateTemp(0, j) = .ucdDateRate.DateValue Then
                                    MsgBox "Ставка на эту дату уже установлена!", vbCritical, "Договор гарантии"
                                Exit For
                                End If
                            Next j
                            If j = UBound(arrRateTemp, 2) + 1 Then
                                ReDim Preserve arrRateTemp(1, UBound(arrRateTemp, 2) + 1)
                                arrRateTemp(0, UBound(arrRateTemp, 2)) = .ucdDateRate.DateValue
                                arrRateTemp(1, UBound(arrRateTemp, 2)) = .ucmRate.CurrencyValue
                                arrRateValues(i) = arrRateTemp

                            End If
                        Else
                            ReDim arrRateTemp(1, 0)
                            arrRateTemp(0, UBound(arrRateTemp, 2)) = .ucdDateRate.DateValue
                            arrRateTemp(1, UBound(arrRateTemp, 2)) = .ucmRate.CurrencyValue

                            arrRateValues(i) = arrRateTemp

                        End If
                    ElseIf UCase(StrCommandRates) = "EDIT" Then
                        For j = 0 To UBound(arrRateTemp, 2)
                            If arrRateTemp(0, j) = .ucdDateRate.DateValue Then
                                arrRateTemp(0, j) = .ucdDateRate.DateValue
                                arrRateTemp(1, j) = .ucmRate.CurrencyValue
                                arrRateValues(i) = arrRateTemp

                                Exit For
                            End If
                        Next j

                    End If
                    Exit For
                End If
            Next i

        End If

    End With

    Unload frmRates


    For i = 0 To UBound(arrRates)
        If IsArray(arrRateValues(i)) Then
            If UBound(arrRateValues(i), 2) > 0 Then
                arrRateTemp = arrRateValues(i)
                ReDim ArrCond(1, 0)
                ArrCond(0, 0) = 0
                ArrCond(1, 0) = True
                objArray.ASort arrRateTemp, ArrCond
                arrRateValues(i) = arrRateTemp
            End If
        End If
        'Call MsgBox("-." & i & "." & UBound(arrRateValues(i), 2))
    Next i

    InitTrvRates()
    SSActiveTabs1.SelectedTab = 4


    cmdAdd.Enabled = False
    cmdEdit.Enabled = False
    cmdDel.Enabled = False

    trvRates.SetFocus
    trvRates_Click()

    If cmdAdd.Enabled Then
        objInterfaces.GoToCtrl cmdAdd
    ElseIf cmdEdit.Enabled Then
        objInterfaces.GoToCtrl cmdEdit
    End If


    Exit Sub
ErrorCode:
    ' Если при возникновении ошибки форма еще не выгружена, то выгружаем ее.
    If Not frmRates Is Nothing Then
        Unload frmRates
    End If
    objErr.UbsErrMsg "GetRate", "ошибка выполнения"
End Sub




Private Function InitTrvRates(Optional in_Refresh As Boolean)
    Dim i As Integer, objNode As Node, strKey As String, strRateType As String
    Dim j As Integer, strKeyChild As String, arrRateTemp As Variant
    Dim tstr As String
    Dim objPIn As Object
    Dim objPOut As Object
    On Error GoTo ErrorCode

    If trvRates.Nodes.Count Then
        trvRates.Nodes.Clear
    End If

    If IsArray(arrRates) Then

        If IsArray(arrRateValues) Then
            If UBound(arrRateValues) <> UBound(arrRates) Then
                ReDim Preserve arrRateValues(UBound(arrRates)) As Variant
            End If
        Else
            ReDim arrRateValues(UBound(arrRates)) As Variant
        End If
        
        Set objPIn = CreateObject("ToolPubs.IUbsParam")
        Set objPOut = CreateObject("ToolPubs.IUbsParam")
        
        Dim s1
        s1 = ""
        For i = 0 To UBound(arrRates)

            strRateType = arrRates(i)
            strKey = "RateType: " & strRateType
            Set objNode = trvRates.Nodes.Add(, , strKey, strRateType, 1, 2)
If strRateType = "Ставка вознаграждения за выдачу" Then s1 = s1 & ".Add(, , " & strKey & ", 1, 2)" & vbCrLf

            objPOut.ClearParameters
            arrRateTemp = Empty

            If (Len(strRateType) > 0) And (in_Refresh) Then

                If IsArray(arrRateValues(i)) Then
                    arrRateTemp = arrRateValues(i)
                    If strRateType = "Ставка вознаграждения за выдачу" Then s1 = s1 & "IsArray(arrRateValues(i))" & ": " & arrRateTemp(0, 0) & " = " & arrRateTemp(1, 0) & vbCrLf
                Else
                    objPIn.Parameter("RateType") = strRatePrefix & strRateType
                    Call oleUbsChannel.Run("BG_GetRateByRateType", objPIn, objPOut)
                    If strRateType = "Ставка вознаграждения за выдачу" Then s1 = s1 & "Else .Run(BG_GetRateByRateType)" & vbCrLf
                    If IsArray(objPOut.Parameter("ValueRate")) Then
                        arrRateTemp = objPOut.Parameter("ValueRate")
                    End If
                    'If strRateType = "Ставка вознаграждения (гарант)" Then s1 = s1 & "Else IsArray(objPOut.Parameter(ValueRate))" & ": " & arrRateTemp(0, 0) & " = " & arrRateTemp(1, 0) & vbCrLf
                    arrRateValues(i) = arrRateTemp
                End If
            Else
                If strRateType = "Ставка вознаграждения за выдачу" Then s1 = s1 & "Else" & vbCrLf
                arrRateTemp = arrRateValues(i)
            End If

            If IsArray(arrRateTemp) Then
                For j = 0 To UBound(arrRateTemp, 2)
                    strKeyChild = strKey & " Date: " & arrRateTemp(0, j)
                    tstr = arrRateTemp(0, j) & " - " & objFormat.FixToSaldo(arrRateTemp(1, j), 18, 2, "+")
                    Set objNode = trvRates.Nodes.Add(strKey, tvwChild, strKeyChild, tstr, 3, 3)
'If strRateType = "Ставка вознаграждения (гарант)" Then s1 = s1 & ".Add(" & strKey & ", " & arrRateTemp(1, j) & vbCrLf
                Next j
            End If
        Next i

    Else
        MsgBox "Массив типов процентных ставок пуст!", vbCritical, m_strCaptionForm
    End If

    Exit Function
ErrorCode:
    objErr.UbsErrMsg "InitTrvRates", "ошибка выполнения"
End Function

Private Sub ReReadDoc()
    Dim q As Integer
    Dim iIdx As Integer
    Dim iId As Integer
    Dim lstCols As ColumnHeader
    Dim i As Long
    On Error GoTo Error_

    If UCase(StrCommand) <> "COPY" Then txtDateOpen.Text = CStr(Now)
    'Инициализация комбобокса - Список валют
    iIdx = 0

    For q = 0 To UBound(arrCurrency, 2)
        If arrCurrency(0, q) = IIf(IdValuta > 0, IdValuta, 810) Then
            iIdx = q
        End If
    Next q
    cmbValuta.ListIndex = iIdx
    cmbCoverValuta.ListIndex = iIdx
    cmbBonusValuta.ListIndex = iIdx
    'cmbExecut.ListIndex = 0

    'Инициализация заголовков ListView
    lstAccounts.ColumnHeaders(1).Width = 2700
    lstAccounts.ColumnHeaders(2).Width = 450
    lstAccounts.ColumnHeaders(3).Width = 2950

    'Call GuarCmdState(False)
    cmdAdd.Enabled = False
    cmdDel.Enabled = False
    cmdEdit.Enabled = False

    If UCase(StrCommand) = "EDIT" Then

        SSActiveTabs1.Tabs(5).Enabled = True

        Call GuarCmdState(True)

        objParamIn.ClearParameters
        objParamOut.ClearParameters

        objParamIn.Parameter("Id") = IdContract
        oleUbsChannel.Run "BG_Contract_Read", objParamIn, objParamOut

        lblUID.Visible = True

        lblUID.Caption = lblUID.Caption & " " & CStr(objParamOut.Parameter("UID"))

        If objParamOut.ExistParameter("strError") Then
            MsgBox objParamOut.Parameter("strError"), vbCritical, "Договор гарантии"
            btnExit_Click()
            Exit Sub
        End If

        If objParamOut.Parameter("Доступ") = 0 Then
            blnSecure = False
            MsgBox "Доступ на редактирование отсутствует! Форма запущена в режиме просмотра", vbCritical, "Договор гарантии"
            btnSave.Enabled = False
        End If

        arrPeriodPay = objParamOut.Parameter("Срок погашения оплаченной суммы")

        blnFixSum = CBool(objParamOut.Parameter("Тип вознаграждения") = "Фиксированная сумма")

        'если права только на просмотр. заполнение комбобокса ОИ одним значением
        If objParamOut.Parameter("Доступ") = 0 Then
            cmbExecut.Clear
            cmbExecut.AddItem(objParamOut.Parameter("Наименование ОИ"))
            cmbExecut.ItemData(0) = objParamOut.Parameter("ОИ")
            cmbExecut.ListIndex = 0
        End If

        objInterfaces.SetFocusCombo cmbExecut, objParamOut.Parameter("ОИ")

        txtModel.Text = objParamOut.Parameter("Типовой договор")
        txtAgent.Text = objParamOut.Parameter("Агент")  ' [14617]

        Dim numAg : numAg = objParamOut.Parameter("Номер договора агента")
        Dim dateAg : dateAg = objParamOut.Parameter("Дата договора агента")
        txtNumAgC.Text = numAg
        txtDateAgC.Text = dateAg

        txtBeneficiar.Text = objParamOut.Parameter("Бенефициар")
        txtGarant.Text = objParamOut.Parameter("Гарант")
        txtFrameContract.Text = objParamOut.Parameter("Наименование рамочного договора")

        SetComboValueText kindComboBox, CStr(objParamOut.Parameter("Вид гарантии"))

        IdModel = objParamOut.Parameter("Идентификатор типового договора")
        IdAgent = objParamOut.Parameter("Идентификатор договора агента") ' [14617]
        IdPrincipal = objParamOut.Parameter("Идентификатор клиента-принципала")
        IdPrincipalOld = IdPrincipal
        IdBeneficiar = objParamOut.Parameter("Идентификатор клиента-бенефициара")
        If IdBeneficiar = 0 Then arrDetailsBeneficiar = objParamOut.Parameter("Реквизиты бенефициара")


        IdDivision = objParamOut.Parameter("Номер отделения")
        IdOI = objParamOut.Parameter("Идентификатор ОИ")
        IdWarrant = objParamOut.Parameter("Идентификатор доверенности")
        IdState = objParamOut.Parameter("Состояние")
        SetEnableCombos()
        IdValuta = objParamOut.Parameter("Идентификатор валюты")
        '
        IdCoverType = objParamOut.Parameter("Тип покрытия")

        IdGarant = objParamOut.Parameter("Идентификатор клиента-гаранта")
        IdFrameContract = objParamOut.Parameter("Идентификатор рамочного договора")

        If IdState = 2 And UCase(StrCommand) <> "EDIT" Then
            cmbBonusValuta.Enabled = True
            dateNextPayFeeValue = objParamOut.Parameter("Дата следующей уплаты вознаграждения")
            dateNextPayFeeBonusValue = objParamOut.Parameter("Дата след. упл.вознаграждения за выдачу")
        End If

        If IdFrameContract > 0 Then
            dFrameContractDateBegin = CDate(objParamOut.Parameter("Дата начала действия рамочного договора"))
            dFrameContractDateEnd = CDate(objParamOut.Parameter("Дата окончания действия рамочного договора"))
            FrameContractTerms = objParamOut.Parameter("Срок гарантии рамочного договора")
            FrameContractLimitSaldo = CCur(objParamOut.Parameter("Остаток лимита рамочного договора"))
            IssueEndDate = CDate(objParamOut.Parameter("Дата окончания выдачи"))
            FrameContractDivision = CInt(objParamOut.Parameter("Отделение рамочного договора"))

            'btnFrameContractDel.Visible = False
            'btnFrameContract.Visible = False
            ''txtFrameContract.Width = 4695

            SetInfoByFrameContract()
        Else
            txtPrincipal.Text = objParamOut.Parameter("Принципал")
        End If

        If IdAgent > 0 Then
            'btnAgentDel.Visible = False
            'btnAgent.Visible = False
            'txtAgent.Width = 4695
            DateReward.Enabled = True
            DateReward.Text = objParamOut.Parameter("Дата вознаграждения")
            CostAmount.Enabled = True
            CostAmount.CurrencyValue = objParamOut.Parameter("Сумма затрат")

            Dim pIn, pOut
            Set pIn = CreateObject("ToolPubs.IUbsParam")
            Set pOut = CreateObject("ToolPubs.IUbsParam")
            pIn.Parameter("IdAgent") = IdAgent

            oleUbsChannel.Run "AgentRewardAvaliable", pIn, pOut
            DateReward.Enabled = pOut.Parameter("Avaliable")
            CostAmount.Enabled = pOut.Parameter("Avaliable")

            DateAdjustment.Text = objParamOut.Parameter("Дата по корректировке")
            PaidAmount.CurrencyValue = objParamOut.Parameter("Уплаченная сумма")
            TransferedAmount.CurrencyValue = objParamOut.Parameter("Перечисленная сумма")


        End If

        If objParamOut.ExistParameter("Обеспечения") Then
            arrGuarant = objParamOut.Parameter("Обеспечения")
            Call FillLvwGuarant()
        End If

        If IdModel = 0 Then
            SSActiveTabs1.Tabs(3).Enabled = False
            SSActiveTabs1.Tabs(4).Enabled = False
        Else
            SSActiveTabs1.Tabs(3).Enabled = True
            SSActiveTabs1.Tabs(4).Enabled = True
        End If

        sModelType = objParamOut.Parameter("Шаблон")
        If sModelType = "UBS_GUARANT" Then
            If IdState = 4 Then
                btnGarant.Enabled = True
                If cmbTypePayFee.Text = "Процент суммы гарантии" Then
                    cmbBonusValuta.ListIndex = cmbValuta.ListIndex
                    cmbBonusValuta.Enabled = False
                    'ElseIf IdState = 2 Then
                    '      cmbBonusValuta.Enabled = True
                    'Else
                End If

                If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
                    cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
                    cmbBonusValutaBonus.Enabled = False
                    'ElseIf IdState = 2 Then
                    '    cmbBonusValutaBonus.Enabled = True
                    'Else
                End If
            Else
                btnGarant.Enabled = False
            End If
            IdGarant = 0
            txtGarant.Text = ""
        Else 'sModelType = "UBS_COUNTER_GUARANT"
            btnGarant.Enabled = True
        End If

        ReDim arrInterval(3, 0) As Variant
        arrInterval(0, 0) = objParamOut.Parameter("Вознаграждение. Тип периода")
        arrInterval(1, 0) = objParamOut.Parameter("Вознаграждение. Период")
        arrInterval(2, 0) = objParamOut.Parameter("Вознаграждение. Тип даты")
        arrInterval(3, 0) = objParamOut.Parameter("Вознаграждение. Номер дня")

        dDateNextPayFee.DateValue = objParamOut.Parameter("Дата следующей уплаты вознаграждения")

        ReDim arrIntervalBonus(3, 0) As Variant
        arrIntervalBonus(0, 0) = objParamOut.Parameter("Вознаграждение за выдачу. Тип периода")
        arrIntervalBonus(1, 0) = objParamOut.Parameter("Вознаграждение за выдачу. Период")
        arrIntervalBonus(2, 0) = objParamOut.Parameter("Вознаграждение за выдачу. Тип даты")
        arrIntervalBonus(3, 0) = objParamOut.Parameter("Вознаграждение за выдачу. Номер дня")

        dDateNextPayFeeBonus.DateValue = objParamOut.Parameter("Дата след. упл.вознаграждения за выдачу")


        'Вознаграждение (гарант)
        strOrderPayFeeGuarant = CStr(objParamOut.Parameter("Порядок уплаты вознаграждения (гарант)"))

        If (strOrderPayFeeGuarant <> "") Then
            frmPayFeeGuarant.Visible = True
            Dim TypePayFeeGuarant : TypePayFeeGuarant = CStr(objParamOut.Parameter("Тип вознаграждения (гарант)"))
            If (strOrderPayFeeGuarant = "Периодически") Then
                dDateNextPayFeeGuarant.DateValue = objParamOut.Parameter("Дата след. уплаты вознаграждения (гарант)")
                arrIntervalGuarant = objParamOut.Parameter("Вознаграждение (гарант)")
            End If
        End If

        If objParamOut.ExistParameter("Идентификатор портфеля") Then
            Call SetComboText(cmbPortfolio, objParamOut.Parameter("Идентификатор портфеля"))
        End If

        If objParamOut.ExistParameter("Тип оценки риска") Then
            Call SetComboText(cmbTypeValidationRisk, objParamOut.Parameter("Тип оценки риска"))
        End If

        If objParamOut.ExistParameter("Группа риска") Then
            objInterfaces.SetFocusCombo cmbQualityCategory, objParamOut.Parameter("Группа риска")
            cmbQualityCategory.Text = objParamOut.Parameter("Группа риска")
        End If

        'If objParamOut.ExistParameter("Причина классификации ссуды") Then
        '    Dim indexItem

        '   For i = 0 To cmbRiskReason.ListCount - 1
        '       If cmbRiskReason.ItemData(i) = objParamOut.Parameter("Причина классификации ссуды") Then
        '           cmbRiskReason.ListIndex = i
        '           indexItem = i
        '           Exit For
        '       End If
        '   Next i

        ' End If

        If objParamOut.ExistParameter("Ставка резервирования") Then
            ucmRateReservation.CurrencyValue = objParamOut.Parameter("Ставка резервирования")
        End If

        Call SetComboText(cmbNumberDiv, IdDivision)
        Call SetComboText(cmbExecut, IdOI)
        Call SetComboText(cmbWarrant, IdWarrant)
        Call SetComboText(cmbCoverType, IdCoverType)
        Call SetComboText(cmbState, IdState)
        Call SetComboText(cmbValuta, IdValuta)

        txtNumber.Text = objParamOut.Parameter("Номер договора")
        txtDateOpen.Text = objParamOut.Parameter("Дата заключения")
        txtDateClose.Text = objParamOut.Parameter("Дата закрытия")
        txtDateBegin.Text = objParamOut.Parameter("Дата начала действия")
        txtDatePrincipal.Text = objParamOut.Parameter("Дата возникн. обязательства Принципала") ' [16430]
        dateBeginC = objParamOut.Parameter("Дата начала действия")  ' (70774)
        txtDateEnd.Text = objParamOut.Parameter("Дата окончания действия")

        If IdState = 4 Then
            btnPreviousContract.Enabled = True
            If cmbTypePayFee.Text = "Процент суммы гарантии" Then
                cmbBonusValuta.ListIndex = cmbValuta.ListIndex
                cmbBonusValuta.Enabled = False
            Else
                cmbBonusValuta.Enabled = True
            End If

            If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
                cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
                cmbBonusValutaBonus.Enabled = False
            Else
                cmbBonusValutaBonus.Enabled = True
            End If
        Else
            btnPreviousContract.Enabled = False
        End If
        txtPreviousContract.Enabled = False
        txtPreviousContract.Text = objParamOut.Parameter("InfoPrevContract")

        '---------------------------------------------------------------------------------
        '/////////////////// Доп. поля
        '---------------------------------------------------------------------------------
        lIdBonusValuta = objParamOut.Parameter("Идентификатор валюты вознаграждения")
        Call SetComboText(cmbBonusValuta, lIdBonusValuta)

        lIdBonusValutaBonus = objParamOut.Parameter("Идентификатор валюты вознаграждения за выдачу")
        Call SetComboText(cmbBonusValutaBonus, lIdBonusValutaBonus)

        blnInitCurrencyBonus = True

        txtGarantSumma.CurrencyValue = objParamOut.Parameter("Сумма гарантии")
        IdCoverType = objParamOut.Parameter("Тип покрытия")
        Call SetComboText(cmbCoverType, IdCoverType)
        txtCoverSumma.CurrencyValue = objParamOut.Parameter("Сумма покрытия")
        lIdCoverValuta = objParamOut.Parameter("Идентификатор валюты покрытия")
        Call SetComboText(cmbCoverValuta, lIdCoverValuta)
        lIdCoverContract = objParamOut.Parameter("Идентификатор договора покрытия")
        If objParamOut.ExistParameter("Договор покрытия") Then
            txtCoverDogovor.Text = objParamOut.Parameter("Договор покрытия")
        End If

        If IsArray(objParamOut.Parameter("Порядок уплаты вознаграждения (список)")) Then
            Dim arrPayOrder : arrPayOrder = objParamOut.Parameter("Порядок уплаты вознаграждения (список)")
            Call FillComboText(cmbOrderPayFee, arrPayOrder)
            Call SetComboValueText(cmbOrderPayFee, objParamOut.Parameter("Порядок уплаты вознаграждения"))
            Call FillComboText(cmbOrderPayFeeBonus, arrPayOrder)
            Call SetComboValueText(cmbOrderPayFeeBonus, objParamOut.Parameter("Порядок уплаты вознаграждения за выдачу"))

            dDateNextPayFee.DateValue = IIf(cmbOrderPayFee.Text = "Периодически", objParamOut.Parameter("Дата следующей уплаты вознаграждения"), DateSerial(2222, 1, 1))
            dDateNextPayFeeBonus.DateValue = IIf(cmbOrderPayFeeBonus.Text = "Периодически", objParamOut.Parameter("Дата след. упл.вознаграждения за выдачу"), DateSerial(2222, 1, 1))


            If (strOrderPayFeeGuarant <> "") Then
                Call FillComboText(cmbOrderPayFeeGuarant, arrPayOrder)
                Call SetComboValueText(cmbOrderPayFeeGuarant, strOrderPayFeeGuarant)
            End If

            If (strOrderPayFeeGuarant <> "") And (strOrderPayFeeGuarant = "Периодически") Then
                dDateNextPayFeeGuarant.DateValue = objParamOut.Parameter("Дата след. уплаты вознаграждения (гарант)")
            End If

        Else
            MsgBox "Параметр 'Порядок уплаты вознаграждения (список)' пуст!", vbCritical, "Договор гарантии"
            If CheckParamForClose(LoadParam) Then
                btnExit_Click()
                Exit Sub
            End If
        End If


        If IsArray(objParamOut.Parameter("Тип вознаграждения (список)")) Then
            Dim arrTypeBonus : arrTypeBonus = objParamOut.Parameter("Тип вознаграждения (список)")
            Call FillComboText(cmbTypePayFee, arrTypeBonus)
            Call SetComboValueText(cmbTypePayFee, CStr(objParamOut.Parameter("Тип вознаграждения")))

            Call FillComboText(cmbTypePayFeeBonus, arrTypeBonus)
            Call SetComboValueText(cmbTypePayFeeBonus, CStr(objParamOut.Parameter("Тип вознаграждения за выдачу")))

            If (strOrderPayFeeGuarant <> "") Then
                Call FillComboText(cmbTypePayFeeGuarant, arrTypeBonus)
                Call SetComboValueText(cmbTypePayFeeGuarant, TypePayFeeGuarant)
            End If

            If cmbTypePayFee.Text = "Процент суммы гарантии" Then cmbBonusValuta.Enabled = False
            If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then cmbBonusValutaBonus.Enabled = False

        Else
            MsgBox "Параметр 'Тип вознаграждения (список)' пуст!", vbCritical, "Договор гарантии"
            If CheckParamForClose(LoadParam) Then
                btnExit_Click()
                Exit Sub
            End If
        End If

        '----------------------------------------------------------------------------------
        If IdState = 4 Then
            If cmbTypePayFee.Text = "Процент суммы гарантии" Then
                cmbBonusValuta.ListIndex = cmbValuta.ListIndex
                cmbBonusValuta.Enabled = False
            Else
                cmbBonusValuta.Enabled = True
            End If

            If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
                cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
                cmbBonusValutaBonus.Enabled = False
            Else
                cmbBonusValutaBonus.Enabled = True
            End If
        End If
    Else
        txtDateClose.Text = ""
    End If
    cmbValuta.Enabled = cmbValutaEnabled()

    Call SetBonusCtrlsState()

    ' arrRateValues обнуляем, чтобы они перечитались
    arrRateValues = Empty
    Call InitTrvRates(True)

    If Len(txtModel.Text) > 0 Then btnModel.Enabled = False

    Call UpdateCover()

    arrAccounts = objParamOut.Parameter("Счета")
    Call FilllstAccounts()

    ucpParam.UbsAddFields = objStub
    ucpParam.Refresh

    ' мышь-стрелка
    UserDocument.MousePointer = 0

    ' [16430]
    If IdState <> 2 And IdState <> 4 Then
        txtDatePrincipal.Enabled = False
    End If

    If IdState <> 4 And StrCommand <> "COPY" Then  'IdState = 4 - подготовлен
        Call EnabledCmdControl(False)

        txtModel.Enabled = False
        txtPrincipal.Enabled = False
        txtBeneficiar.Enabled = False
        txtGarant.Enabled = False

        txtNumber.Enabled = False
        txtDateBegin.Enabled = False
        txtDateEnd.Enabled = True
        txtDateOpen.Enabled = False
        txtDateClose.Enabled = False
        txtGarantSumma.Enabled = False

        cmbValuta.Enabled = cmbValutaEnabled()

        cmbCoverType.Enabled = False
        cmbCoverValuta.Enabled = False
        txtCoverDogovor.Enabled = False
        txtCoverSumma.Enabled = False

        cmbExecut.Enabled = True
        cmbState.Enabled = False
        cmbNumberDiv.Enabled = False

        cmdAdd.Enabled = False
        cmdDel.Enabled = False
        cmdEdit.Enabled = False

        btnFrameContract.Enabled = False
        btnFrameContractDel.Visible = False

        btnAgent.Enabled = False
        btnAgentDel.Visible = False

        txtDateEnd.Enabled = False

        If IdState = 1 Then 'Закрыт
            btnSave.Enabled = False
            btnReRead.Enabled = False
        End If
        'If IdState = 2 Then
        '    If cmbTypePayFee.Text = "Процент суммы гарантии" Then
        '        cmbBonusValuta.ListIndex = cmbValuta.ListIndex
        '        cmbBonusValuta.Enabled = False
        '    Else
        '        cmbBonusValuta.Enabled = True
        '    End If
        '
        '    If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
        '        cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
        '        cmbBonusValutaBonus.Enabled = False
        '    Else
        '        cmbBonusValutaBonus.Enabled = True
        '    End If
        '    cmbNumberDiv.Enabled = True
        '    btnGarant.Enabled = True
        '    btnPreviousContract.Enabled = True
        '    cmbOrderPayFee.Enabled = True
        '    cmbTypePayFee.Enabled = True
        '
        '    cmbOrderPayFeeBonus.Enabled = True
        '    cmbTypePayFeeBonus.Enabled = True
        'End If
    End If
    cmbValuta.Enabled = cmbValutaEnabled()

    Call CorrectFormDateCtrls()

    Exit Sub
Error_:
    objErr.UbsMsgRaise "ReReadDoc", "ошибка выполнения"
End Sub

Private Sub FillComboText(ByVal cmbControl As ComboBox, ByVal arrData As Variant)

    If IsEmpty(arrData) Then Exit Sub
    cmbControl.Clear

    Dim q

    For q = 0 To UBound(arrData)
        cmbControl.AddItem(arrData(q))
        cmbControl.ItemData(q) = q
    Next q
    cmbControl.ListIndex = 0

End Sub

Private Sub SetComboValueText(ByVal cmbControl As ComboBox, ByVal Value As String)

    Dim i

    For i = 0 To cmbControl.ListCount - 1
        If cmbControl.List(i) = Value Then
            cmbControl.ListIndex = i
        End If
    Next

End Sub

Private Function FillLvwGuarant()
    Dim i As Integer, itmGuarant As ListItem
    On Error GoTo ErrorCode

    lvwGuarant.ListItems.Clear

    If IsArray(arrGuarant) Then
        For i = 0 To UBound(arrGuarant, 2)
            Set itmGuarant = lvwGuarant.ListItems.Add(, "Key: " & arrGuarant(0, i), arrGuarant(0, i))
                
            itmGuarant.SubItems(1) = arrGuarant(1, i)
            itmGuarant.SubItems(2) = arrGuarant(2, i)
        Next i
    End If

    Exit Function
ErrorCode:
    objErr.UbsErrMsg "FillLvwGuarant", "ошибка выполнения"
End Function

Private Sub GetBonusPayOrder(ByRef arrData As Variant)
    Dim j As Integer, q As Integer, i As Integer
    Dim arrNumDays As Variant
    On Error GoTo ErrorCode

    ' Загружаем форму и инициализируем ее
    Load frmBGBonusPayInterval

    With frmBGBonusPayInterval

        'Иницализиция комбобокса с типами периодов
        If IsArray(arrTypePeriod) Then
            For i = 0 To UBound(arrTypePeriod, 2)
                .cmbTypePeriod.AddItem(arrTypePeriod(1, i))
                .cmbTypePeriod.ItemData(i) = arrTypePeriod(0, i)
            Next i
        Else
            MsgBox "Массив типов периодов пуст!", vbCritical, m_strCaptionForm
        End If

        .ucmPeriod.CurrencyValue = 1

        'Иницализиция комбобокса с типами дат гашений
        If IsArray(arrTypeDate) Then
            For i = 0 To UBound(arrTypeDate, 2)
                .cmbTypeDate.AddItem(arrTypeDate(1, i))
                .cmbTypeDate.ItemData(i) = arrTypeDate(0, i)
            Next i
        Else
            MsgBox "Массив типов дат гашений пуст!", vbCritical, m_strCaptionForm
        End If

        If Not VarType(arrData) = vbEmpty Then
            Call SetComboText(.cmbTypePeriod, arrData(0, 0))
            .ucmPeriod.CurrencyValue = arrData(1, 0)
            Call SetComboText(.cmbTypeDate, arrData(2, 0))

            If .ucmNumDay.Enabled Then
                .ucmNumDay.CurrencyValue = arrData(3, 0)(0, 0)
            ElseIf .chkArray(0).Enabled Then
                For i = 0 To .chkArray.UBound
                    .chkArray(i).Value = Unchecked
                Next i
                For i = 0 To UBound(arrData(3, 0), 2)
                    .chkArray(arrData(3, 0)(0, i) - 1).Value = Checked
                Next i
            End If

            If cmbState.ItemData(cmbState.ListIndex) < 2 Then
                .cmdApply.Enabled = False
            End If
        End If

        .Show vbModal

        If .blnApply Then

            ReDim arrData(3, 0) As Variant
            arrData(0, 0) = .cmbTypePeriod.ItemData(.cmbTypePeriod.ListIndex) 'Тип периода гашений
            arrData(1, 0) = Val(.ucmPeriod.CurrencyValue) 'Период гашений
            arrData(2, 0) = .cmbTypeDate.ItemData(.cmbTypeDate.ListIndex) 'Тип даты гашений
            If .ucmNumDay.Enabled Then
                ReDim arrNumDays(0, 0)
                arrNumDays(0, 0) = Val(.ucmNumDay.CurrencyValue) 'Номер дня периода
                arrData(3, 0) = arrNumDays
            ElseIf .chkArray(0).Enabled Then
                'Забиваем массив номеров дней
                For i = 0 To .chkArray.UBound
                    If .chkArray(i).Value = Checked Then
                        If IsArray(arrNumDays) Then
                            ReDim Preserve arrNumDays(0, UBound(arrNumDays, 2) + 1)
                            arrNumDays(0, UBound(arrNumDays, 2)) = i + 1
                        Else
                            ReDim arrNumDays(0, 0)
                            arrNumDays(0, 0) = i + 1
                        End If
                    End If
                Next i

                arrData(3, 0) = arrNumDays
            Else
                arrData(3, 0) = Empty
            End If

        End If

    End With

    Unload frmBGBonusPayInterval

    Exit Sub
ErrorCode:
    ' Если при возникновении ошибки форма еще не выгружена, то выгружаем ее.
    If Not frmBGBonusPayInterval Is Nothing Then
        Unload frmBGBonusPayInterval
    End If
    objErr.UbsErrMsg "GetRate", "frmBGBonusPayInterval: ошибка выполнения"
End Sub

Private Sub SetBonusCtrlsState()

    If IdState = 4 Then
        If cmbTypePayFee.Text = "Процент суммы гарантии" Then
            cmbBonusValuta.ListIndex = cmbValuta.ListIndex
            cmbBonusValuta.Enabled = False
        Else
            cmbBonusValuta.Enabled = True
        End If

        If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
            cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
            cmbBonusValutaBonus.Enabled = False
        Else
            cmbBonusValutaBonus.Enabled = True
        End If
    End If

    If cmbOrderPayFee.Text = "Периодически" Then
        If cmbState.ItemData(cmbState.ListIndex) = 4 Then
            dDateNextPayFee.Enabled = True
        Else
            dDateNextPayFee.Enabled = False
        End If

        cmdPeriodPayFee.Enabled = True
    Else
        cmdPeriodPayFee.Enabled = False
        dDateNextPayFee.Enabled = False
    End If

End Sub

Private Sub SetBonusCtrlsBonusState()
    If IdState = 4 Then
        If cmbTypePayFee.Text = "Процент суммы гарантии" Then
            cmbBonusValuta.ListIndex = cmbValuta.ListIndex
            cmbBonusValuta.Enabled = False
        Else
            cmbBonusValuta.Enabled = True
        End If

        If cmbTypePayFeeBonus.Text = "Процент суммы гарантии" Then
            cmbBonusValutaBonus.ListIndex = cmbValuta.ListIndex
            cmbBonusValutaBonus.Enabled = False
        Else
            cmbBonusValutaBonus.Enabled = True
        End If
    End If

    'If IdState = 2 Then
    '        dDateNextPayFeeBonus.Enabled = True
    'Else
    '        dDateNextPayFeeBonus.Enabled = False
    'End If

    If cmbOrderPayFeeBonus.Text = "Периодически" _
    Then
        If cmbState.ItemData(cmbState.ListIndex) = 4 Then
            dDateNextPayFeeBonus.Enabled = True
        Else
            dDateNextPayFeeBonus.Enabled = False
        End If

        cmdPeriodPayFeeBonus.Enabled = True
    Else
        cmdPeriodPayFeeBonus.Enabled = False
        dDateNextPayFeeBonus.Enabled = False
    End If

    'If cmbState.ItemData(cmbState.ListIndex) = 2 And blnFixSum Then
    '    cmbBonusValutaBonus.Enabled = True
    'Else
    '    cmbBonusValutaBonus.Enabled = False
    'End If

End Sub

Private Sub SetBonusCtrlsStateGuarant()

    cmdPeriodPayFeeGuarant.Visible = False
    dDateNextPayFeeGuarant.Visible = False
    lblDateNextPayFeeGuarant.Visible = False

    dDateNextPayFeeGuarant.Enabled = False
    If cmbOrderPayFeeGuarant.Text = "Периодически" Then
        dDateNextPayFeeGuarant.Visible = True
        If cmbState.ItemData(cmbState.ListIndex) = 2 Then dDateNextPayFeeGuarant.Enabled = True
        cmdPeriodPayFeeGuarant.Visible = True
        lblDateNextPayFeeGuarant.Visible = True
    Else

    End If

End Sub


Private Sub CorrectDateCtrls(in_DateCtrl As Control)

    If TypeName(in_DateCtrl) = "UbsControlDate" Then
        If in_DateCtrl.DateValue >= dDate2222 Or in_DateCtrl.DateValue <= dDate1990 Then
            in_DateCtrl.Text = ""
        End If
    End If

End Sub


Private Sub CorrectFormDateCtrls()
    Dim objCtrl As Control

    For Each objCtrl In UserDocument.Controls
        If TypeName(objCtrl) = "UbsControlDate" Then
            If (objCtrl.DateValue >= dDate2222) Or (objCtrl.DateValue <= dDate1990) Then
                objCtrl.Text = ""
            End If
        End If
    Next objCtrl

End Sub

'//////////////////////////////////////////
' Обеспечение - Гарантия
Private Sub GuarCmdState(in_State As Boolean, Optional in_Lock As Boolean = False)

    If in_Lock Then
        in_State = False
    End If
    cmdAddGuarant.Enabled = in_State
    cmdInclude.Enabled = in_State
    cmdListGuarantOperDog.Enabled = in_State

    If (lvwGuarant.SelectedItem Is Nothing) Or in_Lock Then
        in_State = False
    End If
    cmdEditGuarant.Enabled = in_State

End Sub


Private Sub AddEditGuarContract(ByVal in_Mode As String)
    Dim objRS As Object
    Dim objPIn As Object, objPOut As Object

    Call GuarCmdState(False, True)
    
    Set objPIn = CreateObject("ToolPubs.IUbsParam")
    Set objPOut = CreateObject("ToolPubs.IUbsParam")
    Set objRS = CreateObject("URunScr.IUbsRunScript")
    
    objRS.UbsChannel = oleUbsChannel
    objRS.ParentWnd = UserDocument.hWnd
    objRS.Parameter("UbsWaitBox") = objWait
    objRS.Parameter("DocObj") = Me
    objRS.Read "UBS_VBS\GUAR\GuarCallContr_Cli.vbs"

    objPIn.Parameter("Номер окна") = NumWin
    objPIn.Parameter("Тип объекта") = "BG"
    If in_Mode = "Add" Then
        objPIn.Parameter("Идентификатор валюты") = cmbValuta.ItemData(cmbValuta.ListIndex)
    End If
    If (lvwGuarant.ListItems.Count > 0) And (in_Mode = "Edit") Then
        objPIn.Parameter("Идентификатор договора обеспечения") = CLng(Mid(lvwGuarant.SelectedItem.Key, 6))
    End If
    objPIn.Parameter("Идентификатор клиента") = IdPrincipal
    objPIn.Parameter("Идентификатор объекта") = IdContract
    objPIn.Parameter("StrCommand") = in_Mode

    blnGuarWinOpened = True
    Call objRS.Run("GuarAddContr", objPIn, objPOut)
    
    Set objRS = Nothing
    Set objPIn = Nothing
    Set objPOut = Nothing
    
    Call GuarCmdState(True)

    Call ReReadGuarCntracts()

End Sub




Private Sub ReReadGuarCntracts()

    Dim objPIn As Object, objPOut As Object
    
    Set objPIn = CreateObject("ToolPubs.IUbsParam")
    Set objPOut = CreateObject("ToolPubs.IUbsParam")
    
    objPIn.ClearParameters
    objPOut.ClearParameters

    objPIn.Parameter("Id") = IdContract
    oleUbsChannel.Run "GetListGuarant", objPIn, objPOut
    If objPOut.ExistParameter("Обеспечения") Then
        arrGuarant = objPOut.Parameter("Обеспечения")
        Call FillLvwGuarant()
    End If
    
    Set objPIn = Nothing
    Set objPOut = Nothing
    
End Sub


Private Function FindInArray(arrData, intValue, intNumCol) As Boolean
    'Поиск в массиве arrData элемента со значением intValue в колонке intNumCol
    '   при "Save")
    On Error GoTo ErrorCode
    Dim arrAfterChangeTemp As Variant, arrBeforeChangeTemp As Variant
    Dim i As Integer, j As Integer, q As Integer

    FindInArray = False

    If IsArray(arrData) Then
        For i = 0 To UBound(arrData, 2)
            If arrData(intNumCol, i) = intValue Then
                FindInArray = True
            End If
        Next i
    End If

    Exit Function
ErrorCode:
    objErr.UbsErrMsg "FindInArray", "ошибка выполнения"
End Function

Private Function GetVarValue(Var)
    Dim strResult, strTN
    Dim i, j
    Dim k, n

    strResult = TypeName(Var) & vbCrLf
    Select Case TypeName(Var)
        Case "Variant()"
            i = UBound(Var)
            j = UBound(Var, 2)
            For k = 0 To j
                For n = 0 To i
                    If Not IsArray(Var(n, k)) Then
                        strResult = strResult & GetStrFromType(Var(n, k)) & " : "
                    Else
                        strResult = strResult & GetStrFromArray(Var(n, k)) & " : "
                    End If
                Next
                strResult = strResult & vbCrLf
            Next
        Case Else
            strResult = strResult & Var & vbCrLf
    End Select

    MsgBox strResult
End Function

Private Function GetStrFromType(Var)

    If IsDate(Var) Then
        GetStrFromType = CDate(Var)
    Else
        GetStrFromType = Var
    End If
End Function
Private Function GetStrFromArray(varArr)
    Dim i, j
    Dim k, n, strResult
    i = UBound(varArr)
    j = UBound(varArr, 2)
    strResult = "| "
    For k = 0 To j
        For n = 0 To i
            If Not IsArray(varArr(n, k)) Then
                strResult = strResult & varArr(n, k) & " | "
            Else
                strResult = strResult & "Array" & " | "
            End If
        Next
        strResult = strResult & vbCrLf
    Next
    GetStrFromArray = strResult
End Function

Private Sub ResetKindComboBox()
    On Error GoTo Error_

    Dim Selected
    Selected = kindComboBox.Text

    FillComboText kindComboBox, KindAddflSense
    kindComboBox.ListIndex = kindComboBox.ListCount - 1
    SetComboValueText kindComboBox, Selected

    Exit Sub
Error_:
    objErr.UbsMsgRaise "ResetKindComboBox", "Ошибка выполнения"
End Sub

Private Sub SetKindComboBoxByFrame()
    On Error GoTo Error_

    Dim Selected
    Dim Kinds
    Dim i
    Selected = kindComboBox.Text

    If IsArray(FrameContractTerms) Then
        ReDim Kinds(UBound(FrameContractTerms, 2) + 1)
    Else
        ReDim Kinds(0)
    End If

    For i = 0 To UBound(FrameContractTerms, 2)
        Kinds(i) = FrameContractTerms(0, i)
    Next
    Kinds(UBound(Kinds)) = ""

    FillComboText kindComboBox, Kinds
    kindComboBox.ListIndex = kindComboBox.ListCount - 1
    SetComboValueText kindComboBox, ""
    SetComboValueText kindComboBox, Selected

    Exit Sub
Error_:
    objErr.UbsMsgRaise "SetKindComboBoxByFrame", "Ошибка выполнения"
End Sub

Private Function GetAvailableKinds() As Variant
    On Error GoTo Error_

    Dim Kinds As Variant
    Dim i As Long

    If IdFrameContract > 0 And IsArray(FrameContractTerms) Then
        ReDim Kinds(UBound(FrameContractTerms, 2))
        For i = 0 To UBound(FrameContractTerms, 2)
            Kinds(i) = FrameContractTerms(0, i)
        Next
    Else
        Kinds = KindAddflSense
        ' Последний элемент - пустая строка
        ReDim Preserve Kinds(UBound(Kinds) - 1)
    End If

    GetAvailableKinds = Kinds

    Exit Function
Error_:
    objErr.UbsMsgRaise "GetAvailableKinds", "Ошибка выполнения"
End Function

Private Function CheckTerm() As Boolean
    On Error GoTo Error_

    Dim Term As Long
    Dim Kind As String
    Dim i As Long

    CheckTerm = True

    If IdFrameContract > 0 And IsArray(FrameContractTerms) And kindComboBox.Text <> "" Then
        Term = DateDiff("d", txtDateBegin.DateValue, txtDateEnd.DateValue) + 1
        Kind = kindComboBox.Text

        For i = 0 To UBound(FrameContractTerms, 2)
            If Kind = FrameContractTerms(0, i) Then
                If Term > FrameContractTerms(1, i) Then
                    MsgBox "Cрок гарантии — " & Term & " д. — превышает максимальный срок, указанный в рамочном договоре, — " & FrameContractTerms(1, i) & " д.", vbExclamation + vbOKOnly, "Ошибка"
                    CheckTerm = False
                End If
            End If
        Next
    End If

    Exit Function
Error_:
    objErr.UbsMsgRaise "CheckTerm", "Ошибка выполнения"
End Function

Private Function CheckFrameLimit() As Boolean
    On Error GoTo Error_

    CheckFrameLimit = True

    If IdFrameContract > 0 And LimitExcessCheckOn Then
        If txtGarantSumma.CurrencyValue > FrameContractLimitSaldo Then
            MsgBox "Сумма гарантии — " & txtGarantSumma.CurrencyValue & " — превышает остаток лимита рамочного договора — " & FrameContractLimitSaldo, vbExclamation + vbOKOnly, "Ошибка"
            CheckFrameLimit = False
        End If
    End If

    Exit Function
Error_:
    objErr.UbsMsgRaise "CheckFrameLimit", "Ошибка выполнения"
End Function

Private Function CheckIssueDate() As Boolean
    On Error GoTo Error_

    CheckIssueDate = True

    If IdFrameContract > 0 And IssueEndDate <> dDate2222 Then
        If txtDateOpen.DateValue > IssueEndDate Then
            MsgBox "Дата заключения — " & txtDateOpen.DateValue & " — позже даты окончания выдачи гарантии, указанной в рамочном договоре, — " & IssueEndDate, vbExclamation, "Ошибка"
            CheckIssueDate = False
        End If
    End If

    Exit Function
Error_:
    objErr.UbsMsgRaise "CheckIssueDate", "Ошибка выполнения"
End Function

Private Function cmbValutaEnabled() As Boolean
    cmbValutaEnabled = (IdState = 4 And IdFrameContract = 0)
    'Or IdState = 2
End Function

Private Sub UserDocument_Resize()
    cmbPortfolio.Width = UserDocument.Width - 1650
End Sub
